---
title: 04-cloud-å®æˆ˜é¡¹ç›®æ­å»º
---
## 1.æ­å»ºå¼€å‘ç¯å¢ƒ

â€œå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨â€â€”â€”è¿™ä¸ªå¤ä»£çš„æ ¼è¨€åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ä¾ç„¶é€‚ç”¨ã€‚å¼€å‘ç¯å¢ƒçš„æ­å»ºæ˜¯è¿›è¡Œé«˜æ•ˆè½¯ä»¶å¼€å‘çš„åŸºç¡€ï¼Œç¡®ä¿åœ¨é¡¹ç›®å®æ–½è¿‡ç¨‹ä¸­ç³»ç»Ÿè¿è¡Œçš„ç¨³å®šæ€§ä¸ä¸€è‡´æ€§ã€‚åœ¨æ·±å…¥é¡¹ç›®å®æˆ˜ä¹‹å‰ï¼Œå…³é”®åœ¨äºå»ºç«‹ä¸€ä¸ªå¥å…¨ä¸”å¯é çš„å¼€å‘ç¯å¢ƒï¼Œä»¥é¿å…åæœŸç”±äºç¯å¢ƒé…ç½®ä¸å½“å¸¦æ¥çš„ç§ç§é—®é¢˜å’ŒæŒ‘æˆ˜ã€‚

1. **å¼€å‘ç¯å¢ƒçš„ç»Ÿä¸€æ ‡å‡†åŒ–**

   é¦–å…ˆï¼Œç»Ÿä¸€çš„å¼€å‘ç¯å¢ƒé…ç½®æ˜¯ä¿éšœé¡¹ç›®å›¢é˜Ÿåä½œé¡ºç•…çš„é‡è¦å› ç´ ã€‚æˆ‘ä»¬éœ€ç¡®ä¿å„å¼€å‘ç»„ä»¶ï¼Œå¦‚ Javaã€Maven å’Œå…¶ä»–ç›¸å…³ä¸­é—´ä»¶çš„ç‰ˆæœ¬ç»Ÿä¸€ã€‚ç‰ˆæœ¬çš„ç»Ÿä¸€æœ‰åŠ©äºå‡å°‘å› ç¯å¢ƒå·®å¼‚å¯¼è‡´çš„é—®é¢˜ï¼Œå¦‚å…¼å®¹æ€§é—®é¢˜æˆ–åŠŸèƒ½å·®å¼‚ï¼Œä»è€Œä¿è¯é¡¹ç›®çš„è¿›åº¦å’Œè´¨é‡ã€‚

2. **å…³é”®ä¸­é—´ä»¶çš„é€‰æ‹©ä¸æ­å»º**

   åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€‰ç”¨äº†å¤šä¸ªé‡è¦çš„ä¸­é—´ä»¶ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº Spring Cloud çš„æ ¸å¿ƒç»„ä»¶å¦‚ Nacosã€Sentinelã€Zipkin å’Œ Seataã€‚é€‰æ‹©è¿™äº›ä¸­é—´ä»¶æ˜¯ä¸ºäº†æé«˜é¡¹ç›®çš„å¯é æ€§ã€ç›‘æ§èƒ½åŠ›åŠåˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†ã€‚æˆ‘ä»¬å°†åœ¨åç»­ç« èŠ‚ä¸­é€ä¸€æ·±å…¥ä»‹ç»è¿™äº›ä¸­é—´ä»¶çš„ä½œç”¨ã€å®‰è£…è¿‡ç¨‹å’Œé…ç½®æ–¹æ³•ã€‚

3. **é›†æˆå¼€å‘ç¯å¢ƒï¼ˆIDEï¼‰å’Œæ•°æ®åº“çš„è®¾ç½®**

   æˆ‘ä»¬è¿˜éœ€è¦æ­å»ºé›†æˆå¼€å‘ç¯å¢ƒï¼ˆIDEï¼‰ï¼Œå®‰è£…æ•°æ®åº“ï¼Œå¹¶å¯¼å…¥å¿…è¦çš„æ•°æ®åº“è„šæœ¬ã€‚ä¸€ä¸ªé«˜æ•ˆçš„ IDE å¯ä»¥æå¤§æé«˜å¼€å‘æ•ˆç‡ï¼Œè€Œé€‚å½“é…ç½®çš„æ•°æ®åº“æ˜¯ç¡®ä¿æ•°æ®å­˜å–æ•ˆç‡å’Œå®‰å…¨çš„å…³é”®ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šæ¢è®¨å¦‚ä½•å®‰è£…å’Œé…ç½®ä¸€äº›å¸¸ç”¨çš„ä¸­é—´ä»¶ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ”¯æŒåç»­çš„å¼€å‘å·¥ä½œã€‚

OKï¼Œä¸è¯´åºŸè¯äº†ï¼Œæˆ‘ä»¬æ­£å¼å¼€å§‹ï¼

### 1.1 ç¯å¢ƒå‡†å¤‡ï¼šé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ“ä½œç³»ç»Ÿ

é€‰æ‹©ä¸€ä¸ªé€‚åˆçš„æ“ä½œç³»ç»Ÿæ˜¯å¼€å‘è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€æ­¥ã€‚é’ˆå¯¹ Java å¼€å‘ï¼Œå¼ºçƒˆæ¨è **Mac ç¬”è®°æœ¬æˆ–è€…åŸºäº Linux çš„æ“ä½œç³»ç»Ÿ**ã€‚Linux ç³»ç»Ÿç”±äºå…¶ç¨³å®šæ€§ã€çµæ´»æ€§ä»¥åŠä¸ç”Ÿäº§ç¯å¢ƒçš„ä¸€è‡´æ€§ï¼Œè¢«å¹¿æ³›è®¤ä¸ºæ˜¯æœåŠ¡å™¨ç«¯åº”ç”¨å’Œå¼€å‘çš„é¦–é€‰ã€‚è€Œ Mac ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒå’Œå¯¹å¼€å‘è€…å‹å¥½çš„ç¯å¢ƒï¼ŒåŒæ ·æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

å¦‚æœä½ ç›®å‰æ˜¯ Windows ç”¨æˆ·ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼å¯ä»¥è·å¾—ç±»ä¼¼ Linux çš„å¼€å‘ä½“éªŒï¼š

1. **å®‰è£…åŒç³»ç»Ÿ**ï¼šè¿™æ˜¯æœ€æ¥è¿‘çœŸå® Linux ç³»ç»Ÿçš„ä½“éªŒï¼Œä½†å¯èƒ½éœ€è¦é¢å¤–çš„åˆ†åŒºæˆ–ç¡¬ç›˜ç©ºé—´ã€‚
2. **ä½¿ç”¨ Cygwin æˆ– Ubuntu è™šæ‹Ÿæœº**ï¼šè¿™äº›å·¥å…·å¯ä»¥åœ¨ Windows ç³»ç»Ÿä¸­æ¨¡æ‹Ÿå‡º Linux ç¯å¢ƒï¼Œæ–¹ä¾¿ä¸”é«˜æ•ˆã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä»‹ç»å¦‚ä½•åœ¨ Mac ç³»ç»Ÿä¸Šé…ç½®å¼€å‘ç¯å¢ƒã€‚å°½ç®¡è¿™é‡Œä»¥ Mac ç³»ç»Ÿä¸ºä¾‹ï¼Œä½†ç›¸åŒçš„æ­¥éª¤ä¹Ÿé€‚ç”¨äº Linuxï¼Œåªæ˜¯å®‰è£…æ–¹å¼å¯èƒ½ç•¥æœ‰ä¸åŒã€‚Windows ç”¨æˆ·å¯ä»¥å‚è€ƒå®˜æ–¹ä¸‹è½½é“¾æ¥è¿›è¡Œç›¸åº”è½¯ä»¶çš„å®‰è£…ã€‚

### 1.2 Homebrewï¼šMac ä¸Šçš„è½¯ä»¶ç®¡ç†ç¥å™¨

Homebrew æ˜¯ Mac ä¸Šçš„ä¸€æ¬¾å¼ºå¤§çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå®ƒå¯ä»¥å¤§å¤§ç®€åŒ–è½¯ä»¶çš„å®‰è£…å’Œç®¡ç†è¿‡ç¨‹ã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ­¥éª¤åœ¨ Mac ä¸Šå®‰è£… Homebrewã€‚

é¦–å…ˆï¼Œè®¿é—® [Homebrew å®˜æ–¹ç½‘ç«™](https://brew.sh/) æŸ¥çœ‹è¯¦ç»†çš„å®‰è£…æŒ‡å—ã€‚

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-023042.png)

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

ç”±äºæŸäº›ç½‘ç»œç¯å¢ƒçš„é™åˆ¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°å®‰è£…é€Ÿåº¦ç¼“æ…¢çš„é—®é¢˜ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š

1. **ä½¿ç”¨ VPN**ï¼šè¿™å¯ä»¥æœ‰æ•ˆæé«˜ä¸‹è½½é€Ÿåº¦ï¼Œä½†å¯èƒ½éœ€è¦é¢å¤–çš„è´¹ç”¨æˆ–é…ç½®ã€‚
2. **åˆ‡æ¢åˆ°å›½å†…é•œåƒæº**ï¼šå¦‚æ¸…åå¤§å­¦æˆ–ä¸­å›½ç§‘æŠ€å¤§å­¦çš„é•œåƒã€‚å®˜æ–¹å®‰è£…æ–‡æ¡£ä¸­æœ‰è¯¦ç»†çš„æ›¿æ¢æ–¹æ³•ã€‚

å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œ `brew -v` æ¥éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸã€‚ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºä¿¡æ¯ï¼š

```bash
âœ  ~ brew -v
Homebrew 4.0.28-67-ge9ac36a
```

æœ‰äº† Homebrewï¼Œä½ å¯ä»¥æ–¹ä¾¿åœ°ä½¿ç”¨ `brew install` å‘½ä»¤å®‰è£…æ‰€éœ€è½¯ä»¶ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨å›½å†…é•œåƒæ—¶ï¼Œè¯·æ³¨æ„æŸäº›è½¯ä»¶æˆ–ä¾èµ–é¡¹å¯èƒ½å› ç½‘ç»œé—®é¢˜å®‰è£…å¤±è´¥ï¼Œæ­¤æ—¶å¯ä»¥å°è¯•æ ¹æ®é”™è¯¯æ—¥å¿—å•ç‹¬å®‰è£…æœ‰é—®é¢˜çš„ä¾èµ–ç„¶åå†å°è¯•å®‰è£…ç›®æ ‡è½¯ä»¶ã€‚

### 1.3 Java å’Œ Mavenï¼šé«˜æ•ˆ Java å¼€å‘çš„å…³é”®

Java å’Œ Maven æ˜¯ Java å¼€å‘çš„æ ¸å¿ƒå·¥å…·ï¼Œå…¶ç‰ˆæœ¬é€‰æ‹©å’Œé…ç½®ç›´æ¥å½±å“åˆ°å¼€å‘çš„æ•ˆç‡å’Œé¡¹ç›®çš„ç¨³å®šæ€§ã€‚ä»¥ä¸‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é…ç½®è¿™ä¸¤ä¸ªå·¥å…·ï¼Œç¡®ä¿ä¸€ä¸ªé¡ºç•…çš„å¼€å‘æµç¨‹ã€‚

Java å’Œ Maven ç‰ˆæœ¬é€‰æ‹©ï¼š

* **JDK 8**ï¼šè¿™æ˜¯ Java é•¿æœŸæ”¯æŒçš„ç‰ˆæœ¬ä¹‹ä¸€ï¼Œå¹¿æ³›ç”¨äºä¼ä¸šçº§åº”ç”¨ã€‚ä½ å¯ä»¥ä» [Oracle å®˜ç½‘](https://www.oracle.com/sg/java/technologies/javase/javase8u211-later-archive-downloads.html) ä¸‹è½½ JDK 8 çš„æœ€æ–°å°ç‰ˆæœ¬ã€‚å°½ç®¡è¾ƒæ—§ï¼Œä½†å…¶ç¨³å®šæ€§å’Œå¹¿æ³›çš„åº”ç”¨æ”¯æŒæ˜¯é€‰æ‹©å®ƒçš„ä¸»è¦åŸå› ã€‚
* **Maven ç‰ˆæœ¬**ï¼šå»ºè®®ä½¿ç”¨ Maven 3.6 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿ä¸ç°ä»£ Java ç”Ÿæ€çš„å…¼å®¹æ€§ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ Maven 3.9.3ï¼Œå¯ä» [Maven å®˜ç½‘](https://maven.apache.org/download.cgi) ä¸‹è½½ã€‚

ç”±äº Maven ä¸­å¤®ä»“åº“åœ¨å›½å†…è®¿é—®å¯èƒ½å—é™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½® `settings.xml` æ¥æŒ‡å®šå›½å†…çš„é•œåƒä»“åº“ï¼Œä»¥æé«˜ä¾èµ–åŒ…çš„ä¸‹è½½é€Ÿåº¦ã€‚è¿™é‡Œä»‹ç»ä¸¤ä¸ªå¸¸ç”¨çš„å›½å†…é•œåƒï¼š

**é˜¿é‡Œäº‘é•œåƒ**ï¼šé€Ÿåº¦å¿«ï¼Œè¦†ç›–å¹¿æ³›ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ã€‚

```xml
<mirror>
  <id>aliyunmaven</id>
  <mirrorOf>*</mirrorOf>
  <name>é˜¿é‡Œäº‘å…¬å…±ä»“åº“</name>
  <url>https://maven.aliyun.com/repository/public</url>
</mirror>
```

**åä¸ºäº‘é•œåƒ**ï¼šè¿™æ˜¯ä¸€ä¸ªé«˜é€Ÿä¸”ç¨³å®šçš„æ›¿ä»£é€‰é¡¹ï¼Œæˆ‘åœ¨è¿™é‡Œä½¿ç”¨åä¸ºäº‘é•œåƒã€‚

```xml
<mirror>
  <id>huaweicloud</id>
  <mirrorOf>*</mirrorOf>
  <url>https://repo.huaweicloud.com/repository/maven/</url>
</mirror>
```

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼ŒJava å’Œ Maven çš„åŸºæœ¬é…ç½®å°±å®Œæˆäº†ã€‚

### 1.4 IntelliJ IDEAï¼šJava å¼€å‘çš„åˆ©å™¨

IntelliJ IDEA æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”æµè¡Œçš„ Java é›†æˆå¼€å‘ç¯å¢ƒï¼ˆIDEï¼‰ï¼Œç”± JetBrains å¼€å‘ã€‚å®ƒä¸ä»…æ”¯æŒ Javaï¼Œè¿˜æ”¯æŒå¤šç§å…¶ä»–ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ã€‚ä»¥ä¸‹æ˜¯å…¶å®‰è£…æ­¥éª¤ï¼š

1. **ä¸‹è½½**ï¼šå‰å¾€ [JetBrains å®˜æ–¹ç½‘ç«™](https://www.jetbrains.com/zh-cn/idea/download) ä¸‹è½½ IntelliJ IDEAã€‚ä½ å¯ä»¥é€‰æ‹©å…è´¹çš„ç¤¾åŒºç‰ˆï¼Œæˆ–æ˜¯å…·æœ‰æ›´å¤šç‰¹æ€§çš„ä»˜è´¹å•†ä¸šç‰ˆã€‚
2. **å®‰è£…**ï¼šæ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿï¼Œæ‰§è¡Œå®‰è£…ç¨‹åºã€‚è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥é€‰æ‹©å®‰è£…ä½ç½®ã€åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ç­‰ã€‚
3. **é…ç½®**ï¼šåˆæ¬¡å¯åŠ¨ IntelliJ IDEA åï¼Œä½ ä¼šè¢«å¼•å¯¼å®Œæˆä¸€äº›åŸºç¡€é…ç½®ï¼Œæ¯”å¦‚ç•Œé¢ä¸»é¢˜ã€ç¼–è¾‘å™¨è®¾ç½®ç­‰ã€‚
4. **æ¿€æ´»**ï¼šå¦‚æœä½ ä½¿ç”¨å•†ä¸šç‰ˆï¼Œéœ€è¦è¿›è¡Œæ¿€æ´»ã€‚å­¦ç”Ÿå’Œæ•™å¸ˆå¯é€šè¿‡æ•™è‚²é‚®ç®±ç”³è¯·å…è´¹çš„å•†ä¸šç‰ˆæˆæƒã€‚

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-024538.png)

### 1.5 Lombokï¼šä»£ç ç®€åŒ–ç¥å™¨

Lombok æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„ Java åº“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å¸¸è§çš„æ¨¡æ¿ä»£ç ï¼Œå¦‚ gettersã€settersã€equalsã€hashCode å’Œ toString æ–¹æ³•ã€‚

åœ¨ IntelliJ IDEA ä¸­ï¼Œå®‰è£… Lombok éå¸¸ç®€å•ã€‚åªéœ€åœ¨ IDEA çš„æ’ä»¶å¸‚åœºä¸­æœç´¢å¹¶å®‰è£… Lombok æ’ä»¶å³å¯ï¼š

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-024723.png)

æ¥ç€å¯ç”¨æ³¨è§£å¤„ç†å™¨ï¼Œåœ¨ â€œSettingsâ€ ä¸­ï¼Œè¿›å…¥  â€œBuild, Execution, Deploymentâ€ > â€œCompilerâ€ > â€œAnnotation Processorsâ€ã€‚ç¡®ä¿å‹¾é€‰ â€œEnable annotation processingâ€ï¼š

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-10-29-121745.png)

ä¸ºäº†åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Lombokï¼Œç¡®ä¿ä½ çš„ `pom.xml` æˆ– `build.gradle` æ–‡ä»¶ä¸­åŠ å…¥äº† Lombok ä¾èµ–ã€‚Maven ç¤ºä¾‹ï¼š

```xml
<dependency>
  <groupId>org.projectlombok</groupId>
  <artifactId>lombok</artifactId>
  <version>æœ€æ–°ç‰ˆæœ¬</version>
  <scope>provided</scope>
</dependency>
```

### 1.6 MySQL åŠå…¶å¯è§†åŒ–å·¥å…·ï¼šæ„å»ºé«˜æ•ˆæ•°æ®ç¯å¢ƒ

æˆ‘ä»¬å°†ä½¿ç”¨ MySQL ä½œä¸ºæ ¸å¿ƒæ•°æ®åº“ã€‚å¦‚æœä½ çš„ç³»ç»Ÿä¸­å·²ç»å®‰è£…äº† MariaDBï¼Œæ— éœ€æ‹…å¿ƒï¼Œå› ä¸º MariaDB æ˜¯ MySQL çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œç”± MySQL çš„åˆ›å§‹äººä¹‹ä¸€å¼€å‘ï¼Œå¹¶ä¿æŒä¸ MySQL çš„é«˜åº¦å…¼å®¹æ€§ã€‚

å®‰è£… MySQL éå¸¸ç®€ä¾¿ã€‚Mac ç”¨æˆ·å¯ä»¥é€šè¿‡ Homebrew è¿›è¡Œå®‰è£…ï¼Œåªéœ€æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
brew install mysql
```

Windows æˆ– Linux ç”¨æˆ·å¯è®¿é—® [MySQL å®˜æ–¹ç½‘ç«™](https://dev.mysql.com/downloads/mysql)ï¼Œä¸‹è½½ç›¸åº”å¹³å°çš„ç¤¾åŒºç‰ˆå®‰è£…åŒ…ã€‚ç¤¾åŒºç‰ˆå·²å……åˆ†æ»¡è¶³æˆ‘ä»¬å®æˆ˜é¡¹ç›®çš„éœ€æ±‚ã€‚

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-025049.png" style="zoom: 33%;" />

å®Œæˆå®‰è£…åï¼Œå¯ä»¥ç”¨ä»¥ä¸‹ä»»ä¸€æ–¹æ³•å¯åŠ¨ MySQLï¼š

```bash
# ä½¿ç”¨ mysql.server å¯åŠ¨
mysql.server start

# ä½¿ç”¨ brew services å¯åŠ¨ï¼ˆæ¨èï¼‰
brew services start mysql
```

åŒæ ·åœ°ï¼Œè¦å…³é—­ MySQLï¼Œå¯ç”¨å¯¹åº”çš„å‘½ä»¤ï¼š

```bash
# ä½¿ç”¨ mysql.server åœæ­¢
mysql.server stop

# ä½¿ç”¨ brew services åœæ­¢ï¼ˆæ¨èï¼‰
brew services stop mysql
```

> TIPï¼šä½¿ç”¨ `brew services` ç®¡ç† MySQL æœåŠ¡æ—¶ï¼Œ`brew services stop mysql` ä¸ä»…èƒ½æ–¹ä¾¿åœ°åœæ­¢æœåŠ¡ï¼Œè¿˜å¯é˜²æ­¢ç³»ç»Ÿé‡å¯æ—¶ MySQL è‡ªåŠ¨å¯åŠ¨ã€‚

ä¸ºéªŒè¯ MySQL æ˜¯å¦æ­£ç¡®å®‰è£…ï¼Œå°è¯•ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç™»å½•ï¼š

```bash
mysql -uroot -p
```

è¿™é‡Œä½¿ç”¨é»˜è®¤çš„ root ç”¨æˆ·ç™»å½•ï¼ˆåˆå§‹å¯†ç ä¸ºç©ºï¼‰ã€‚ç™»å½•æˆåŠŸåï¼Œä¼šè§åˆ°ç±»ä¼¼ä¸‹æ–¹çš„ç•Œé¢ï¼Œè¡¨ç¤º MySQL å®‰è£…å¹¶è¿è¡Œæ­£å¸¸ï¼š

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-030049.png" style="zoom:50%;" />

ç™»å½•åï¼Œå»ºè®®ç«‹å³ä¿®æ”¹ root ç”¨æˆ·çš„å¯†ç ï¼Œæé«˜æ•°æ®åº“å®‰å…¨æ€§ï¼š

```sql
ALTER USER 'root'@'localhost' IDENTIFIED BY 'æ–°å¯†ç ';
```

ç»§ MySQL å®‰è£…åï¼Œä¸ºäº†æ›´é«˜æ•ˆåœ°ç®¡ç†æ•°æ®åº“ï¼Œæˆ‘æ¨èä½¿ç”¨ DataGripï¼Œå®ƒæ˜¯ JetBrains å¼€å‘çš„ä¸€æ¬¾å¼ºå¤§çš„æ•°æ®åº“ç®¡ç†å·¥å…·ã€‚DataGrip æ”¯æŒ MySQL ä»¥åŠå¤šç§å…¶ä»–æ•°æ®åº“ï¼Œæä¾›ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¦‚ä»£ç è‡ªåŠ¨å®Œæˆã€åˆ†æå’Œé‡æ„ç­‰ã€‚

è®¿é—® [DataGrip å®˜ç½‘](https://www.jetbrains.com/zh-cn/datagrip/download)ï¼Œé€‰æ‹©é€‚åˆä½ æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ä¸‹è½½ï¼š

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-025527.png" style="zoom: 33%;" />

å®‰è£…å¹¶å¯åŠ¨ DataGrip åï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªæ•°æ®æºæ¥è¿æ¥æœ¬åœ°çš„ MySQL æ•°æ®åº“ï¼š

1. åœ¨ DataGrip ä¸­ï¼Œç‚¹å‡» "æ·»åŠ æ•°æ®æº"ã€‚
2. é€‰æ‹© MySQLã€‚
3. è¾“å…¥æ•°æ®åº“è¿æ¥è¯¦æƒ…ï¼š
   * **ç”¨æˆ·å**ï¼šrootï¼ˆæˆ–ä½ çš„è‡ªå®šä¹‰ç”¨æˆ·åï¼‰
   * **å¯†ç **ï¼šï¼ˆç•™ç©ºæˆ–è¾“å…¥ä½ è®¾ç½®çš„å¯†ç ï¼‰
   * **JDBC URL**ï¼š`jdbc:mysql://localhost:3306`
4. ç¡®ä¿å·²å®‰è£… MySQL JDBC é©±åŠ¨ã€‚å¦‚æœæœªå®‰è£…ï¼ŒDataGrip é€šå¸¸ä¼šæç¤ºä¸‹è½½ã€‚

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-032416.png)

å®Œæˆè¿™äº›æ­¥éª¤åï¼Œç‚¹å‡» "æµ‹è¯•è¿æ¥" æ£€æŸ¥æ˜¯å¦èƒ½å¤ŸæˆåŠŸè¿æ¥åˆ°æ•°æ®åº“ã€‚è¿æ¥æˆåŠŸæ„å‘³ç€ä½ ç°åœ¨å¯ä»¥é€šè¿‡ DataGrip æ¥ç®¡ç† MySQL æ•°æ®åº“ï¼Œè¿›è¡ŒæŸ¥è¯¢ã€ç¼–è¾‘ã€ç®¡ç†æ•°æ®è¡¨ç­‰æ“ä½œã€‚

åœ¨å®æˆ˜é¡¹ç›®å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåœ¨ MySQL ä¸­æ„å»ºé¡¹ç›®æ‰€éœ€çš„æ•°æ®åº“å’Œæ•°æ®è¡¨ã€‚è¿™ä¸ªè¿‡ç¨‹å¯¹äºæ•´ä¸ªé¡¹ç›®çš„æ•°æ®ç®¡ç†è‡³å…³é‡è¦ã€‚

**åˆ›å»ºæ•°æ®åº“**ï¼šæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º `coupon_db` çš„æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰ä¸ä¼˜æƒ åˆ¸ç›¸å…³çš„æ•°æ®ã€‚

```sql
-- åˆ›å»ºæ•°æ®åº“ coupon_db
CREATE DATABASE IF NOT EXISTS coupon_db;
```

**åˆ›å»º `coupon_template` æ•°æ®è¡¨**ï¼šè¯¥è¡¨ç”¨äºå­˜å‚¨ä¼˜æƒ åˆ¸æ¨¡æ¿çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚ä¼˜æƒ åˆ¸åç§°ã€ç±»å‹ã€é€‚ç”¨é—¨åº—ç­‰ã€‚

```sql
-- å¦‚æœå­˜åœ¨åŒåè¡¨åˆ™åˆ é™¤ï¼Œç„¶ååˆ›å»º coupon_template æ•°æ®è¡¨
DROP TABLE IF EXISTS `coupon_db`.`coupon_template`;
CREATE TABLE IF NOT EXISTS `coupon_db`.`coupon_template` (
     `id`                   int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
     `available`        boolean NOT NULL DEFAULT false COMMENT 'ä¼˜æƒ åˆ¸å¯ç”¨çŠ¶æ€ï¼Œé»˜è®¤ä¸º false è¡¨ç¤ºä¸èƒ½ä½¿ç”¨',
     `name`              varchar(64) NOT NULL DEFAULT '' COMMENT 'ä¼˜æƒ åˆ¸åç§°',
     `description`     varchar(256) NOT NULL DEFAULT '' COMMENT 'ä¼˜æƒ åˆ¸è¯¦ç»†ä¿¡æ¯',
     `type`                varchar(10) NOT NULL DEFAULT '' COMMENT 'ä¼˜æƒ åˆ¸ç±»å‹',
     `shop_id`           bigint(20) COMMENT 'é€‚ç”¨çš„é—¨åº—ï¼Œç©ºä»£è¡¨å…¨åœºé€‚ç”¨',
     `created_time`   datetime NOT NULL DEFAULT '2023-09-17 00:00:00' COMMENT 'åˆ›å»ºæ—¶é—´',
     `rule`                 varchar(2000) NOT NULL DEFAULT '' COMMENT 'ä½¿ç”¨è§„åˆ™',
     
     PRIMARY KEY (`id`),
     KEY `idx_shop_id` (`shop_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='ä¼˜æƒ åˆ¸æ¨¡æ¿';
```

**åˆ›å»º `coupon` æ•°æ®è¡¨**ï¼šæ­¤è¡¨è®°å½•ç”¨æˆ·é¢†å–çš„ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·IDã€é¢†åˆ¸æ—¶é—´ã€ä¼˜æƒ åˆ¸çŠ¶æ€ç­‰ã€‚

```sql
-- å¦‚æœå­˜åœ¨åŒåè¡¨åˆ™åˆ é™¤ï¼Œç„¶ååˆ›å»º coupon æ•°æ®è¡¨
DROP TABLE IF EXISTS `coupon_db`.`coupon`;
CREATE TABLE IF NOT EXISTS `coupon_db`.`coupon` (
    `id`                    int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®',
    `template_id`    int(20) NOT NULL DEFAULT '0' COMMENT 'ä¼˜æƒ åˆ¸æ¨¡ç‰ˆID',
    `user_id`           bigint(20) NOT NULL DEFAULT '0' COMMENT 'ç”¨æˆ·ID',
    `created_time`  datetime NOT NULL DEFAULT '2023-09-17 00:00:00' COMMENT 'é¢†åˆ¸æ—¶é—´',
    `status`              int(2) NOT NULL DEFAULT '0' COMMENT 'ä¼˜æƒ åˆ¸çŠ¶æ€',
    `shop_id`          bigint(20) COMMENT 'å†—ä½™å­—æ®µï¼Œæ–¹ä¾¿æŸ¥æ‰¾',

    PRIMARY KEY (`id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_template_id` (`template_id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8 COMMENT='é¢†åˆ°çš„ä¼˜æƒ åˆ¸';
```

ä»¥ä¸Š SQL è„šæœ¬åˆ›å»ºäº†ä¸€ä¸ªä¸“æ³¨äºä¼˜æƒ åˆ¸ç›¸å…³æ•°æ®çš„æ•°æ®åº“å’Œä¸¤ä¸ªä¸»è¦æ•°æ®è¡¨ã€‚`coupon_template` è¡¨æ ¼ç”¨äºå®šä¹‰ä¼˜æƒ åˆ¸çš„åŸºæœ¬æ¨¡æ¿ï¼Œè€Œ `coupon` è¡¨æ ¼è®°å½•äº†å…·ä½“çš„ä¼˜æƒ åˆ¸å‘æ”¾æƒ…å†µã€‚ç¡®ä¿åœ¨æ‰§è¡Œè¿™äº›è„šæœ¬å‰ï¼ŒMySQL æœåŠ¡æ­£åœ¨è¿è¡Œã€‚

> âœï¸ æ•°æ®è¡¨è®¾è®¡è¦ç‚¹ï¼š
>
> * **æ•°æ®ç±»å‹é€‰æ‹©**ï¼šåˆç†é€‰æ‹©æ•°æ®ç±»å‹èƒ½å¤Ÿä¼˜åŒ–å­˜å‚¨ç©ºé—´å’ŒæŸ¥è¯¢æ•ˆç‡ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `int` ç±»å‹è¡¨ç¤ºä¸»é”®ï¼Œ`varchar` å­˜å‚¨å­—ç¬¦ä¸²ã€‚
> * **å†—ä½™å­—æ®µ**ï¼š`coupon` è¡¨ä¸­çš„ `shop_id` ä½œä¸ºå†—ä½™å­—æ®µï¼Œä¾¿äºå¿«é€ŸæŸ¥è¯¢ä¼˜æƒ åˆ¸é€‚ç”¨é—¨åº—ï¼Œè¿™å‡å°‘äº†ä¸ `coupon_template` è¡¨çš„è”åˆæŸ¥è¯¢éœ€æ±‚ã€‚
> * **é»˜è®¤å€¼ä¸æ³¨é‡Š**ï¼šè¡¨ä¸­å­—æ®µçš„é»˜è®¤å€¼åŠæ³¨é‡Šçš„è®¾ç½®å¢å¼ºäº†æ•°æ®çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§ã€‚

### 1.7 æ¶ˆæ¯ä¸­é—´ä»¶ï¼šRabbitMQ çš„å®‰è£…ä¸é…ç½®

RabbitMQ æ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹ä¸€ã€‚åç»­ Spring Cloud é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ç»“åˆ Stream ç»„ä»¶å’Œ RabbitMQ æ¥å®ç°å¼‚æ­¥æ¶ˆæ¯ä¼ é€’ã€‚

**å¯¹äº Mac ç”¨æˆ·**ï¼šä½¿ç”¨ Homebrew å¿«é€Ÿå®‰è£… RabbitMQ çš„å‘½ä»¤å¾ˆæ–¹ä¾¿ï¼Œå¦‚ä¸‹å‘½ä»¤å°†è‡ªåŠ¨å®‰è£… RabbitMQ çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬ã€‚

```bash
brew install rabbitmq
```

**é Mac ç”¨æˆ·æˆ–æ‰‹åŠ¨å®‰è£…**ï¼šè®¿é—® [RabbitMQ å®˜ç½‘](https://www.rabbitmq.com/) ä¸‹è½½ç›¸åº”çš„å®‰è£…åŒ…ã€‚

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-031755.png)

**å¯åŠ¨ RabbitMQ**ï¼šå¯åŠ¨ RabbitMQ æœåŠ¡çš„å‘½ä»¤æ ¹æ®å®‰è£…æ–¹å¼ç•¥æœ‰ä¸åŒã€‚å¦‚æœé€šè¿‡ Homebrew å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```bash
rabbitmq-server
# æˆ–è€…ï¼ˆæ¨èï¼‰
brew services start rabbitmq
```

> TIPï¼šå¦‚æœæ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œç¡®ä¿ RabbitMQ çš„å®‰è£…è·¯å¾„å·²æ·»åŠ è‡³ PATH ç¯å¢ƒå˜é‡ã€‚

**å…³é—­ RabbitMQ**ï¼šæ­£ç¡®å…³é—­ RabbitMQ æœåŠ¡æ˜¯éå¸¸é‡è¦çš„ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†é‡è¦æ•°æ®å’Œé…ç½®æ—¶ã€‚

```bash
rabbitmqctl stop
# æˆ–è€…ï¼ˆæ¨èï¼‰
brew services stop rabbitmq
```

> TIPï¼šç¡®ä¿åœ¨åœæ­¢ RabbitMQ ä¹‹å‰ä¿å­˜æ‰€æœ‰çš„é‡è¦æ•°æ®å’Œé…ç½®ï¼Œä»¥é˜²æ•°æ®ä¸¢å¤±æˆ–é…ç½®è¢«é‡ç½®ã€‚

åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ `http://localhost:15672/` è®¿é—® RabbitMQ çš„ç®¡ç†ç•Œé¢ï¼Œé»˜è®¤ç«¯å£ä¸º `15672`ã€‚é»˜è®¤çš„ç”¨æˆ·åå’Œå¯†ç å‡ä¸º `guest`ã€‚

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-043816.png)

ç™»å½•æˆåŠŸåï¼Œä½ å¯ä»¥çœ‹åˆ° RabbitMQ çš„ç®¡ç†ç•Œé¢ï¼Œå®ƒæä¾›äº†å…³äºæ¶ˆæ¯ã€é˜Ÿåˆ—ç­‰çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯å’Œç®¡ç†é€‰é¡¹ã€‚

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-043834.png)

è‡³æ­¤ï¼Œä½ å·²ç»æˆåŠŸå®‰è£…å¹¶è¿è¡Œäº† RabbitMQã€‚

> æ³¨æ„ï¼š
>
> * **æ›´æ–° RabbitMQ**ï¼šå¦‚æœä¹‹å‰å·²ç»å®‰è£…äº† RabbitMQï¼Œä½†éæœ€æ–°ç‰ˆæœ¬ï¼Œå»ºè®®æ›´æ–°åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼Œä»¥ä¾¿ä½¿ç”¨æ‰€æœ‰æœ€æ–°åŠŸèƒ½å’Œæ’ä»¶ã€‚
> * **æ•°æ®å’Œé…ç½®çš„ä¿å­˜**ï¼šåœ¨åœæ­¢ RabbitMQ æœåŠ¡ä¹‹å‰ï¼Œç¡®ä¿å·²ç»ä¿å­˜äº†æ‰€æœ‰é‡è¦çš„æ•°æ®å’Œé…ç½®ï¼Œä»¥é¿å…æ•°æ®ä¸¢å¤±æˆ–é…ç½®è¢«é‡ç½®ã€‚

### 1.8 å­˜å‚¨ç³»ç»Ÿï¼šRedis çš„å®‰è£…ä¸é…ç½®

Redis æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ key-value å­˜å‚¨ç³»ç»Ÿï¼Œå¹¿æ³›åº”ç”¨äºç¼“å­˜ã€ä¼šè¯ç®¡ç†ç­‰åœºæ™¯ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Redis æ¥å®ç°ç½‘å…³å±‚çš„é™æµåŠŸèƒ½ã€‚

**é€šè¿‡ Homebrew å®‰è£…**ï¼šå¯¹äº Mac ç”¨æˆ·ï¼Œä½¿ç”¨ Homebrew å®‰è£… Redis éå¸¸æ–¹ä¾¿ï¼Œä»¥ä¸‹å‘½ä»¤å°†å®‰è£… Redis çš„æœ€æ–°ç‰ˆæœ¬ã€‚

```bash
brew install redis
```

**æ‰‹åŠ¨å®‰è£…**ï¼šä¹Ÿå¯ä»¥é€‰æ‹©æ‰‹åŠ¨å®‰è£… Redisï¼Œè®¿é—® [Redis å®˜æ–¹ç½‘ç«™](https://redis.io/download) ä¸‹è½½æºç åŒ…ã€‚

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044049.png" style="zoom: 33%;" />

ç„¶åæŒ‰ç…§å®˜æ–¹[å®‰è£…æŒ‡å—](https://redis.io/docs/getting-started/installation/)è¿›è¡Œæœ¬åœ°ç¼–è¯‘å’Œå®‰è£…ï¼š

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044136.png" style="zoom: 29%;" />

**å¯åŠ¨å’Œåœæ­¢ Redis æœåŠ¡**ï¼š

```bash
# å¯åŠ¨ Redis æœåŠ¡
brew services start redis

# åœæ­¢ Redis æœåŠ¡
brew services stop redis
```

æ‰§è¡Œ `redis-cli` è¿æ¥è‡³é»˜è®¤çš„ Redis æœåŠ¡åœ°å€ï¼ˆlocalhost:6379ï¼‰ï¼š

```bash
âœ  ~ redis-cli
127.0.0.1:6379>
```

åœ¨ Redis æ§åˆ¶å°ä¸­ï¼Œå¯ä»¥æ‰§è¡Œ Redis å‘½ä»¤ä»¥æµ‹è¯•å’Œç®¡ç†æ‚¨çš„ Redis å®ä¾‹ï¼š

```bash
127.0.0.1:6379> set test 955
OK
127.0.0.1:6379> get test
"955"
127.0.0.1:6379>
```

å½“ç„¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ DataGrip è¿æ¥ Redis æ•°æ®åº“ï¼Œè¿›è¡Œæ›´ç›´è§‚çš„æ•°æ®ç®¡ç†å’Œæ“ä½œï¼š

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044757.png" style="zoom:50%;" />

è¿æ¥ä¿¡æ¯åŸºæœ¬ä¿æŒé»˜è®¤å³å¯ï¼š

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044901.png)

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰€æœ‰å¿…è¦å·¥å…·çš„å®‰è£…ã€‚åœ¨æ¥ä¸‹æ¥çš„ Spring Cloud å¾®æœåŠ¡å®æˆ˜ä¸­ï¼Œæˆ‘ä»¬è¿˜å°†ä»‹ç»å’Œä½¿ç”¨æ›´å¤šçš„ä¸­é—´ä»¶å’Œå·¥å…·ã€‚

> ğŸš€ **ä¸‹ä¸€æ­¥ï¼šSpring Boot å¿«é€Ÿå…¥é—¨**
>
> å·²ç»é…ç½®å¥½åŸºç¡€ç¯å¢ƒåï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ·±å…¥åˆ° Spring Boot çš„å­¦ä¹ å’Œåº”ç”¨ä¸­äº†ï¼è®©æˆ‘ä»¬å¼€å§‹ Spring Boot çš„æ—…ç¨‹å§ï¼**åŠ æ²¹ï¼**ğŸ”¥

## 2.æ­å»ºä¼˜æƒ åˆ¸æ¨¡æ¿æœåŠ¡

åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†è¯¦ç»†æ¢ç´¢å¦‚ä½•ä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ªåŸºäº Spring Boot çš„ä¼˜æƒ åˆ¸å¹³å°ï¼Œç‰¹åˆ«èšç„¦äºä¼˜æƒ åˆ¸æ¨¡æ¿æœåŠ¡ï¼ˆ`coupon-template-serv`ï¼‰çš„æ„å»ºè¿‡ç¨‹ã€‚è¿™ä¸€æœåŠ¡æ˜¯ä¼˜æƒ åˆ¸å¹³å°çš„æ ¸å¿ƒï¼Œå› ä¸ºä¼˜æƒ åˆ¸çš„ç”Ÿæˆä¸ç®¡ç†éƒ½ä¾èµ–äºæ¨¡æ¿ã€‚

é¡¹ç›®ç»“æ„æ¦‚è§ˆï¼š

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-11-01-160815.png" style="zoom:67%;" />

æˆ‘ä»¬çš„ä¼˜æƒ åˆ¸å¹³å°é¡¹ç›®ï¼ˆ`coupon-center`ï¼‰åŒ…å«å››ä¸ªä¸»è¦å­æ¨¡å—ï¼Œå®ƒä»¬åœ¨ Maven ç®¡ç†ä¸‹å½¢æˆä¸€ä¸ªå±‚æ¬¡åˆ†æ˜çš„ç»“æ„ï¼š

1. **coupon-template-serv**ï¼šæ­¤æ¨¡å—è´Ÿè´£åˆ›å»ºã€æŸ¥æ‰¾ã€å…‹éš†å’Œåˆ é™¤ä¼˜æƒ åˆ¸æ¨¡æ¿ã€‚
2. **coupon-calculation-serv**ï¼šå¤„ç†ä¼˜æƒ åçš„è®¢å•ä»·æ ¼è®¡ç®—ï¼Œä»¥åŠè¯„ä¼°å„ç±»ä¼˜æƒ åˆ¸çš„ä¼˜æƒ ç¨‹åº¦ã€‚
3. **coupon-customer-serv**ï¼šä¸ç”¨æˆ·ç›¸å…³çš„æœåŠ¡ï¼ŒåŒ…æ‹¬é¢†å–ä¼˜æƒ åˆ¸ã€æ¨¡æ‹Ÿè®¡ç®—ä¼˜æƒ ã€åˆ é™¤ä¼˜æƒ åˆ¸å’Œè®¢å•å¤„ç†ã€‚
4. **middleware**ï¼šå­˜å‚¨è·¨ä¸šåŠ¡çš„ã€å¹³å°çº§ç»„ä»¶ã€‚

æ¯ä¸ªä»¥ `-serv` ç»“å°¾çš„å­æ¨¡å—è¿›ä¸€æ­¥ç»†åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªå­æ¨¡å—ï¼Œç¡®ä¿èŒè´£å•ä¸€ï¼Œä»£ç ç®¡ç†æ¸…æ™°ï¼š

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-11-01-161047.png" style="zoom:67%;" />

* **coupon-template-api**ï¼šåŒ…å«å…¬å…±ç±»å’Œå¤–éƒ¨æ¥å£ï¼Œå¦‚ Request å’Œ Response å¯¹è±¡ã€‚
* **coupon-template-dao**ï¼šå®šä¹‰æ•°æ®åº“å®ä½“å’Œæ•°æ®è®¿é—®å¯¹è±¡ï¼ˆDAOï¼‰ã€‚
* **coupon-template-impl**ï¼šå…·ä½“å®ç°æœåŠ¡çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å’Œ REST APIã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å…·ä½“ä»‹ç»å¦‚ä½•é…ç½®å’Œå¯åŠ¨ `coupon-template-serv` æ¨¡å—ï¼ŒåŒ…æ‹¬æ•°æ®åº“é…ç½®ã€æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„å®ç°ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ REST API å¯¹å¤–æä¾›æœåŠ¡ã€‚

### 2.1 æ·»åŠ  Maven ä¾èµ–é¡¹

åœ¨æ„å»ºåŸºäº Maven çš„ Spring Boot é¡¹ç›®æ—¶ï¼Œåˆç†çš„ä¾èµ–ç®¡ç†ç­–ç•¥å¯¹äºé¡¹ç›®çš„ç»“æ„å’Œåç»­ç»´æŠ¤è‡³å…³é‡è¦ã€‚ä»¥ä¸‹å†…å®¹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨å¤šæ¨¡å—é¡¹ç›®ä¸­æ·»åŠ å’Œé…ç½® Maven ä¾èµ–é¡¹ï¼Œä»¥åŠå®ƒä»¬åœ¨é¡¹ç›®ä¸­çš„å±‚çº§å…³ç³»ã€‚

#### 2.1.1 ç¼–å†™ part01-springboot-quick ä¾èµ–é¡¹

åœ¨æˆ‘ä»¬çš„å®æˆ˜é¡¹ç›® `part01-springboot-quick` ä¸­ï¼Œå®ƒä½œä¸ºé¡¶å±‚é¡¹ç›®ï¼Œä¸»è¦æ‰¿æ‹…ç€å®šä¹‰å…¬å…± Maven ä¾èµ–ç‰ˆæœ¬çš„è´£ä»»ï¼Œç±»ä¼¼äºä¸€ä¸ªå…¬å¸çš„æˆ˜ç•¥ç®¡ç†å±‚ï¼ŒæŒ‡æ˜å¤§æ–¹å‘è€Œä¸æ¶‰è¶³å…·ä½“ä¸šåŠ¡ã€‚è¿™äº›é…ç½®å‡åœ¨é¡¹ç›®çš„ `pom.xml` æ–‡ä»¶ä¸­æŒ‡å®šã€‚

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.4.2</version>
  </parent>

  <groupId>cn.javgo</groupId>
  <artifactId>ch0-springboot-monolithic</artifactId>
  <version>1.0-SNAPSHOT</version>
  <packaging>pom</packaging>

  <name>ch0-springboot-monolithic</name>
  <url>http://maven.apache.org</url>

  <!-- å­æ¨¡å— -->
  <modules>
    <module>coupon-template-serv</module>
    <module>coupon-calculation-serv</module>
    <module>coupon-customer-serv</module>
    <module>middleware</module>
  </modules>

  <!-- å±æ€§ -->
  <properties>
    <java.version>1.8</java.version>
    <maven.compiler.source>8</maven.compiler.source>
    <maven.compiler.target>8</maven.compiler.target>
  </properties>

  <!-- ä¾èµ–ç®¡ç† -->
  <dependencyManagement>
    <dependencies>
      <!-- Spring Cloud ç‰ˆæœ¬ -->
      <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-dependencies</artifactId>
        <version>2020.0.1</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>

      <!-- Spring Cloud Alibaba ç‰ˆæœ¬ -->
      <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-alibaba-dependencies</artifactId>
        <version>2021.1</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>

      <!-- Apache Commons -->
      <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
        <version>3.0</version>
      </dependency>

      <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-collections4</artifactId>
        <version>4.0</version>
      </dependency>

      <dependency>
        <groupId>commons-codec</groupId>
        <artifactId>commons-codec</artifactId>
        <version>1.9</version>
      </dependency>

      <!-- Alibaba FastJson -->
      <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.31</version>
      </dependency>

      <!-- Lombok -->
      <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.20</version>
      </dependency>

      <!-- Jakarta Bean Validation -->
      <dependency>
        <groupId>jakarta.validation</groupId>
        <artifactId>jakarta.validation-api</artifactId>
        <version>2.0.2</version>
      </dependency>

      <!-- Google Guava -->
      <dependency>
        <groupId>com.google.guava</groupId>
        <artifactId>guava</artifactId>
        <version>16.0</version>
      </dependency>
    </dependencies>

  </dependencyManagement>
</project>
```

åœ¨è¿™ä»½ `pom.xml` æ–‡ä»¶ä¸­ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹ä¸‰ä¸ªæ ‡ç­¾ï¼š

1. **\< parent \> æ ‡ç­¾**

   é€šè¿‡ `<parent>` æ ‡ç­¾çš„é…ç½®ï¼Œæˆ‘ä»¬ç¡®å®šäº†é¡¶å±‚é¡¹ç›®çš„çˆ¶ä¾èµ–ä¸º `spring-boot-starter-parent`ï¼Œå®ƒä¸ºæˆ‘ä»¬çš„å­æ¨¡å—æä¾›äº†æ‰€éœ€çš„ Spring Boot ç»„ä»¶ç‰ˆæœ¬ï¼Œè¿™æ ·çš„åšæ³•åˆ©äºä¿æŒä¾èµ–çš„ä¸€è‡´æ€§å’Œç®€åŒ–ç®¡ç†ã€‚

2. **\< packaging \> æ ‡ç­¾**

   è¿™é‡Œæˆ‘ä»¬æŒ‡å®š `<packaging>` çš„å€¼ä¸º `pom`ï¼Œæ„å‘³ç€è¯¥æ¨¡å—èšç„¦äºç­–ç•¥æ€§çš„å®šä¹‰ï¼ŒåŒ…æ‹¬å­æ¨¡å—çš„æ•´åˆå’Œä¾èµ–ç‰ˆæœ¬ç®¡ç†ï¼Œè€Œä¸åŒ…å«å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å®ç°ã€‚

3. **\< dependencyManagement \> æ ‡ç­¾**

   ä¸ `<parent>` ç±»ä¼¼ï¼Œ`<dependencyManagement>` ç”¨äºé›†ä¸­ç®¡ç†é¡¹ç›®ä¾èµ–ç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œå­æ¨¡å—åœ¨å£°æ˜ä¾èµ–æ—¶ï¼Œåªéœ€æŒ‡å‡º `groupId` å’Œ `artifactId`ï¼Œæ— éœ€æŒ‡å®šç‰ˆæœ¬ï¼Œé¿å…äº†ç‰ˆæœ¬å†²çªå’Œæ··ä¹±ã€‚

#### 2.1.2 ç¼–å†™ coupon-template-serv ä¾èµ–é¡¹

æ¥ä¸‹æ¥æ˜¯ `coupon-template-serv` å­æ¨¡å—çš„ä¾èµ–é…ç½®ã€‚ä½œä¸º `part01-springboot-quick` çš„ç›´æ¥å­æ¨¡å—ï¼Œå®ƒçš„ `pom.xml` é…ç½®åŒæ ·å°† `<packaging>` ç±»å‹è®¾ä¸º `pom`ï¼Œå¹¶ä¸”ä¸»è¦å†…å®¹é›†ä¸­åœ¨ç¡®å®šå…¶çˆ¶æ¨¡å—ï¼Œå¹¶å®šä¹‰ä¸‹å±‚å­æ¨¡å—çš„é…ç½®ã€‚

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>cn.javgo</groupId>
        <artifactId>ch0-springboot-monolithic</artifactId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>coupon-template-serv</artifactId>
    <packaging>pom</packaging>

    <name>coupon-template-serv</name>
    <url>http://maven.apache.org</url>

    <modules>
        <module>coupon-template-api</module>
        <module>coupon-template-impl</module>
        <module>coupon-template-dao</module>
    </modules>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
</project>
```

åœ¨å®Œæˆäº†é¡¶çº§æ¨¡å—å’Œç›´æ¥å­æ¨¡å—çš„ä¾èµ–é…ç½®åï¼Œæˆ‘ä»¬çš„ä¸‹ä¸€æ­¥æ˜¯æ„å»º `coupon-template-serv` ä¸‹å±çš„ä¸‰ä¸ªå­æ¨¡å—ï¼š

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-081052.png)

ä»¥ `coupon-template-api` å­æ¨¡å—ä¸ºèµ·ç‚¹ï¼Œå…¶ä¸»è¦èŒè´£æ˜¯æä¾›æ¥å£çš„è¯·æ±‚å’Œå“åº”ç±»æ¨¡æ¿ï¼Œå®ƒæ˜¯å…¶ä»–ä¸¤ä¸ªæ¨¡å—å…±äº«èµ„æºçš„åŸºç¡€ï¼Œæˆ‘ä»¬å°†ç€æ‰‹äºæ­¤æ¨¡å—çš„æ„å»ºå·¥ä½œã€‚

### 2.4 æ­å»º coupon-template-api æ¨¡å—

#### 2.4.1 æ¦‚è§ˆ

`coupon-template-api` æ¨¡å—æ‹…ä»»äº†æ•´ä¸ªæœåŠ¡ä¸­**å…±äº«æ•°æ®ç±»å‹å’Œæ¥å£è§„èŒƒ**çš„è§’è‰²ã€‚å®ƒåŒ…å«äº†æ‰€æœ‰çš„ REST API æ¶ˆæ¯ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ï¼Œä¾‹å¦‚è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼Œè¿™äº›éƒ½æ˜¯ä»¥ POJOï¼ˆPlain Old Java Objectï¼‰ç±»çš„å½¢å¼å®ç°çš„ã€‚åœ¨å¾®æœåŠ¡ä½“ç³»ä¸­ï¼Œè¿™æ ·åšå¯ä»¥é¿å…åœ¨æœåŠ¡ä¹‹é—´å…±äº«å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œä¿ƒè¿›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œå¯é‡ç”¨æ€§ã€‚

#### 2.4.2 ä¾èµ–é…ç½®

åœ¨è¿™ä¸ªæ¨¡å—çš„ `pom.xml` ä¸­ï¼Œæˆ‘ä»¬åŠ å…¥äº†è‹¥å¹²ä¾¿äºå¼€å‘çš„å·¥å…·ç±»åº“ï¼Œå¦‚ `lombok`ï¼ˆç”¨äºç®€åŒ–å¯¹è±¡çš„åˆ›å»ºå’Œç®¡ç†ï¼‰ï¼Œ`guava`ï¼ˆæä¾›é¢å¤–çš„é›†åˆå¤„ç†èƒ½åŠ›ï¼‰ï¼Œä»¥åŠ `validation-api`ï¼ˆç”¨äºæ•°æ®æœ‰æ•ˆæ€§æ ¡éªŒï¼‰ã€‚

ä¸‹é¢æ˜¯è¿™äº›ä¾èµ–é¡¹çš„å…·ä½“é…ç½®ï¼š

```xml
<dependencies>
    <!-- Apache Commons -->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
    </dependency>

    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-collections4</artifactId>
    </dependency>

    <dependency>
        <groupId>commons-codec</groupId>
        <artifactId>commons-codec</artifactId>
    </dependency>

    <!-- Alibaba FastJson -->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
    </dependency>

    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>

    <!-- Jakarta Validation -->
    <dependency>
        <groupId>jakarta.validation</groupId>
        <artifactId>jakarta.validation-api</artifactId>
    </dependency>

    <!-- Google Guava -->
    <dependency>
        <groupId>com.google.guava</groupId>
        <artifactId>guava</artifactId>
    </dependency>
</dependencies>
```

#### 2.4.3 æ ¸å¿ƒç»„ä»¶

<center>ä¼˜æƒ åˆ¸ç±»å‹æšä¸¾ï¼ˆCouponTypeï¼‰</center>

åœ¨ `cn.javgo.coupon.calculation.template.api.constant` åŒ…ä¸­ï¼Œ`CouponType `æšä¸¾å®šä¹‰äº†ä¸€ç³»åˆ—çš„ä¼˜æƒ åˆ¸ç±»å‹ã€‚ä¸ºäº†å¢åŠ ä»£ç çš„**é²æ£’æ€§**ï¼Œè¿™é‡Œè¿˜è®¾è®¡äº†ä¸€ä¸ªç‰¹æ®Šçš„æšä¸¾å€¼ `UNKNOWN`ï¼Œç”¨äºå¤„ç†æ— æ•ˆçš„è¾“å…¥ã€‚

```java
/**
 * ä¼˜æƒ å·ç±»å‹æšä¸¾
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
@Getter
@AllArgsConstructor
public enum CouponType {
    UNKNOWN("unknown", "0"),
    MONEY_OFF("æ»¡å‡åˆ¸", "1"),
    DISCOUNT("æŠ˜æ‰£åˆ¸", "2"),
    RANDOM_DISCOUNT("éšæœºæŠ˜æ‰£åˆ¸", "3"),
    LONELY_NIGHT_MONEY_OFF("æ™šé—´åŒå€æ»¡å‡åˆ¸", "4");

    private final String desc;

    private final String code;


    /**
     * å°†ç»™å®šçš„ä»£ç è½¬æ¢ä¸ºç›¸åº”çš„ä¼˜æƒ åˆ¸ç±»å‹
     *
     * @param code ä¼˜æƒ åˆ¸ç±»å‹çš„ä»£ç 
     * @return è½¬æ¢åçš„ä¼˜æƒ åˆ¸ç±»å‹
     */
    public static CouponType convert(String code) {
        return Stream.of(CouponType.values())
                .filter(bean -> bean.code.equalsIgnoreCase(code))
                .findFirst()
                // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šå¤„ç†æ¶æ„è¯·æ±‚ä¸­æ•…æ„è¾“å…¥çš„é”™è¯¯ä»£ç 
                .orElse(UNKNOWN);
    }
}
```

<hr/>

<center>ä¼˜æƒ åˆ¸æ¨¡æ¿è§„åˆ™ï¼ˆTemplateRuleï¼‰</center>

`TemplateRule `ç±»ä½äº `cn.javgo.coupon.calculation.template.api.beans.rules` åŒ…ä¸‹ï¼Œæè¿°äº†ä¼˜æƒ åˆ¸æ¨¡æ¿çš„ä¸¤ä¸ªåŸºæœ¬è§„åˆ™ï¼šé¢†å–è§„åˆ™å’Œä½¿ç”¨è§„åˆ™ã€‚è¿™äº›è§„åˆ™å¯¹äºç†è§£å’Œæ‰§è¡Œä¼˜æƒ åˆ¸çš„è¡Œä¸ºè‡³å…³é‡è¦ã€‚

1. **é¢†åˆ¸è§„åˆ™**ï¼šæè¿°äº†æ¯ä¸ªç”¨æˆ·å¯ä»¥é¢†å–çš„ä¼˜æƒ åˆ¸æ•°é‡å’Œä¼˜æƒ åˆ¸çš„è¿‡æœŸæ—¶é—´ã€‚
2. **ä¼˜æƒ åˆ¸çš„è®¡ç®—è§„åˆ™**ï¼šæè¿°äº†ä¼˜æƒ åˆ¸çš„å…·ä½“æŠ˜æ‰£è§„åˆ™ã€‚

```java
/**
 * ä¼˜æƒ å·é¢†å–è§„åˆ™
 * @author javgo.cn
 * @date 2023/11/3
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class TemplateRule {

    /**
     * ä¼˜æƒ å·æŠ˜æ‰£è§„åˆ™
     */
    private Discount discount;

    /**
     * ä¼˜æƒ å·é¢†å–é™åˆ¶
     */
    private Integer limitation;

    /**
     * ä¼˜æƒ å·è¿‡æœŸæ—¶é—´
     */
    private Long deadline;
}
```

<hr/>

<center>æŠ˜æ‰£è§„åˆ™ï¼ˆDiscountï¼‰</center>

`Discount `ç±»å®šä¹‰äº†å…·ä½“çš„æŠ˜æ‰£é€»è¾‘ï¼Œè¿™é‡Œä½¿ç”¨ `Long` ç±»å‹ä»¥åˆ†ä¸ºå•ä½è¡¨ç¤ºé‡‘é¢ï¼Œä»¥é¿å…æµ®ç‚¹æ•°è®¡ç®—çš„ç²¾åº¦é—®é¢˜ã€‚

```java
/**
 * ä¼˜æƒ è§„åˆ™
 * @author javgo.cn
 * @date 2023/11/3
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Discount {

    /**
     * ä¼˜æƒ é‡‘é¢
     * <p>
     * æ³¨æ„ï¼šå¯¹äºä¸åŒçš„ä¼˜æƒ å·æœ‰ä¸åŒçš„å«ä¹‰<br>
     * 1ã€æ»¡å‡åŠµï¼šæ»¡è¶³ä¸€å®šé‡‘é¢åå¯ä»¥å‡å»çš„é‡‘é¢<br>
     * 2ã€æŠ˜æ‰£åŠµï¼šæŠ˜æ‰£æ¯”ä¾‹ï¼Œå¦‚ 90 è¡¨ç¤ºæ‰“9æŠ˜<br>
     * 3ã€éšæœºç«‹å‡åŠµï¼šéšæœºå‡å»çš„é‡‘é¢<br>
     * 4ã€æ™šé—´å‘æ”¾åŠµï¼šæ™šé—´ä¼˜æƒ å·ç¿»å€
     */
    private Long quota;

    /**
     * ä¼˜æƒ æ¡ä»¶ï¼šä½¿ç”¨ä¼˜æƒ å·çš„æœ€ä½é‡‘é¢ï¼Œå•ä½ï¼šåˆ†
     */
    private Long threshold;
}
```

<hr/>

<center>ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯ï¼ˆCouponTemplateInfoï¼‰</center>

`CouponTemplateInfo `ç±»æä¾›äº†æ¨¡æ¿çš„åŸºç¡€æè¿°ï¼Œå¹¶ä½¿ç”¨äº† `jakarta.validation-api` ä¸­çš„æ ¡éªŒæ³¨è§£ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ã€‚

```java
/**
 * ä¼˜æƒ å·æ¨¡æ¿ä¿¡æ¯
 * @author javgo.cn
 * @date 2023/11/3
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class CouponTemplateInfo {

  @ApiModelProperty("ä¸»é”®")
  private Long id;

  @NotNull
  @ApiModelProperty("ä¼˜æƒ å·æ¨¡æ¿åç§°")
  private String name;

  @NotNull
  @ApiModelProperty("ä¼˜æƒ å·æ¨¡æ¿æè¿°")
  private String desc;

  @NotNull
  @ApiModelProperty("ä¼˜æƒ å·æ¨¡æ¿ç±»å‹")
  private String type;

  @ApiModelProperty("åº—é“ºid")
  private Long shopId;

  @NotNull
  @ApiModelProperty("ä¼˜æƒ å·æ¨¡æ¿è§„åˆ™")
  private TemplateRule templateRule;

  @ApiModelProperty("æ˜¯å¦å¯ç”¨")
  private Boolean available;
}
```

<hr/>

<center>å…¶ä»–ç±»</center>

> æ­¤å¤–ï¼Œæ¨¡å—ä¸­è¿˜åŒ…æ‹¬äº†å¦‚åˆ†é¡µæŸ¥è¯¢å’Œæœç´¢ä¼˜æƒ åˆ¸æ¨¡æ¿æ‰€éœ€çš„å‚æ•°ç±»ç­‰ã€‚è¿™äº›ç±»è¿›ä¸€æ­¥å¢å¼ºäº†æœåŠ¡çš„åŠŸèƒ½ã€‚

ç”Ÿæˆçš„ä¼˜æƒ åˆ¸åˆ™ä½¿ç”¨å¦ä¸€ä¸ªå¯¹è±¡ `CouponInfo` æ¥å°è£…ã€‚`CouponInfo` å¯¹è±¡åŒ…å«äº†ä¼˜æƒ åˆ¸çš„æ¨¡æ¿ä¿¡æ¯ã€é¢†åˆ¸ç”¨æˆ·IDã€é€‚ç”¨é—¨åº— ID ç­‰å…³é”®å±æ€§ï¼š

```java
/**
 * ä¼˜æƒ å·ä¿¡æ¯ï¼ˆåŸºäº {@link CouponTemplateInfo} ç”Ÿæˆï¼‰
 * @author javgo.cn
 * @date 2023/11/3
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class CouponInfo {

  @ApiModelProperty("ä¸»é”®")
  private Long id;

  @ApiModelProperty("ä¼˜æƒ å·æ¨¡æ¿ID")
  private Long templateId;

  @ApiModelProperty("ç”¨æˆ·ID")
  private Long userId;

  @ApiModelProperty("åº—é“ºID")
  private Long shopId;

  @ApiModelProperty("ä¼˜æƒ å·çŠ¶æ€")
  private Integer status;

  @ApiModelProperty("ä¼˜æƒ å·æ¨¡æ¿ä¿¡æ¯")
  private CouponTemplateInfo templateInfo;
}
```

åˆ†é¡µæŸ¥è¯¢ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯å‚æ•°ï¼š

```java
/**
 * åˆ†é¡µæŸ¥è¯¢ä¼˜æƒ å·æ¨¡æ¿
 * @author javgo.cn
 * @date 2023/11/3
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class PagedCouponTemplateInfo {

  @ApiModelProperty("ä¼˜æƒ å·æ¨¡æ¿åˆ—è¡¨")
  public List<CouponTemplateInfo> couponTemplateInfoList;

  @ApiModelProperty("å½“å‰é¡µ")
  public int page;

  @ApiModelProperty("æ€»é¡µæ•°")
  public long total;
}
```

ä¼˜æƒ åˆ¸æ¨¡æ¿æœç´¢å‚æ•°ï¼š

```java
/**
 * ä¼˜æƒ å·æ¨¡ç‰ˆæŸ¥è¯¢å‚æ•°
 * @author javgo.cn
 * @date 2023/11/3
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class TemplateSearchParams {

  @ApiModelProperty(value = "ä¼˜æƒ å·ID")
  private Long id;

  @ApiModelProperty(value = "ä¼˜æƒ å·åç§°")
  private String name;

  @ApiModelProperty(value = "ä¼˜æƒ å·ç±»å‹")
  private String type;

  @ApiModelProperty(value = "é—¨åº—ID")
  private Long shopId;

  @ApiModelProperty(value = "æ˜¯å¦å¯ç”¨")
  private Boolean available;

  @ApiModelProperty(value = "é¡µç ")
  private int page;

  @ApiModelProperty(value = "æ¯é¡µå¤§å°")
  private int pageSize;
}
```

`coupon-template-api ` æ¨¡å—ä¸ºæˆ‘ä»¬æä¾›äº†æ ‡å‡†åŒ–çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œä½¿å¾—å…¶ä»–æœåŠ¡èƒ½å¤ŸåŸºäºè¿™äº›æ ¼å¼æ„å»ºè‡ªå·±çš„é€»è¾‘ã€‚éšç€æ¨¡å—çš„è¿›ä¸€æ­¥ä¸°å¯Œï¼Œå®ƒå°†æˆä¸ºä¿è¯å¾®æœåŠ¡é—´é€šä¿¡ä¸€è‡´æ€§å’Œå‡è½»è€¦åˆçš„å…³é”®ã€‚

åœ¨å®Œæˆ `coupon-template-api` æ¨¡å—åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†èšç„¦äº `coupon-template-dao` æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—è´Ÿè´£å®ç°æ•°æ®è®¿é—®é€»è¾‘ï¼ŒåŒ…æ‹¬ä¸æ•°æ®åº“çš„äº¤äº’å’Œæ•°æ®æŒä¹…åŒ–ã€‚

### 2.5 æ­å»º coupon-template-dao æ¨¡å—

#### 2.5.1 ä¾èµ–é…ç½®

åœ¨åŠ¨æ‰‹å®ç° `coupon-template-dao `æ¨¡å—å‰ï¼Œç¡®è®¤å·²ç»æ·»åŠ äº†ä»¥ä¸‹å…³é”®ä¾èµ–é¡¹è‡³ `pom.xml` æ–‡ä»¶ï¼š

- **coupon-template-api**: å¼•å…¥è¯¥æ¨¡å—ä»¥ä½¿ç”¨ API å±‚å®šä¹‰çš„å…¬å…±ç±»ã€‚
- **spring-boot-starter-data-jpa**: åˆ©ç”¨ Spring Data JPA ç®€åŒ–æ•°æ®æŒä¹…åŒ–æ“ä½œã€‚
- **mysql-connector-java**: ç¡®ä¿æ‰€ç”¨ MySQL é©±åŠ¨ä¸æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹ã€‚

```xml
<dependencies>
    <!--
        æŒä¹…å±‚ï¼ˆPersistence Layerï¼‰æ˜¯åº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†å’Œå­˜å‚¨æ•°æ®ã€‚åœ¨å®é™…æƒ…å†µä¸‹ï¼ŒæŒä¹…å±‚ä¸åº”è¯¥ç›´æ¥ä¾èµ–äº API å±‚
        ï¼ˆApplication Programming Interface Layerï¼‰ï¼Œå› ä¸ºè¿™ä¸¤å±‚çš„åŠŸèƒ½åˆ†ç¦»åº”è¯¥æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚ç„¶è€Œï¼Œä¸ºäº†ç®€åŒ–ç¤ºä¾‹ï¼Œè¿™é‡Œå‡è®¾
        æŒä¹…å±‚ç›´æ¥ä¾èµ–äº API å±‚çš„ POJO ç±»ï¼ˆPlain Old Java Objectï¼Œç®€å•çš„ Java å¯¹è±¡ï¼‰ã€‚

        åœ¨å®é™…å¼€å‘ä¸­ï¼ŒæŒä¹…å±‚åº”è¯¥å®šä¹‰è‡ªå·±çš„ DTOï¼ˆData Transfer Objectï¼‰ï¼Œå³æ•°æ®ä¼ è¾“å¯¹è±¡ã€‚ä¸Šå±‚æ¨¡å—å¯ä»¥é€šè¿‡è½¬æ¢å™¨ï¼ˆconverterï¼‰å°†
        API å±‚çš„ POJO ç±»è½¬æ¢æˆé€‚åˆæŒä¹…å±‚ä½¿ç”¨çš„ DTOã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼ŒæŒä¹…å±‚çš„ DTO å¯ä»¥çµæ´»ä¿®æ”¹ï¼Œè€Œä¸ä¼šå½±å“åˆ° API å±‚çš„ POJO ç±»ã€‚
        å› ä¸º API å±‚çš„ POJO ç±»æ˜¯åº”ç”¨ç¨‹åºçš„å¤–éƒ¨æ¥å£ï¼Œä¸åº”è¯¥é¢‘ç¹ä¿®æ”¹ã€‚

        æ€»ä¹‹ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼ŒæŒä¹…å±‚åº”è¯¥ä¸ API å±‚è§£è€¦åˆï¼Œå¹¶ä¸”é€šè¿‡è‡ªå®šä¹‰ DTO è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚è¿™æ ·åšå¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
    -->
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-template-api</artifactId>
        <version>${project.version}</version>
    </dependency>

    <!-- Spring Data JPA -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>

    <!-- Spring Boot Validation -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>

    <!-- MySQL -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>8.0.21</version>
        <scope>runtime</scope>
    </dependency>
</dependencies>
```

#### 2.5.2 å®ä½“å®šä¹‰

åœ¨ `cn.javgo.template.dao.model` åŒ…ä¸‹åˆ›å»º `CouponTemplate` ç±»ï¼Œè¯¥ç±»è¡¨ç¤ºæ•°æ®åº“ä¸­ `coupon_template` è¡¨çš„å®ä½“ã€‚

```java
/**
 * ä¼˜æƒ å·æ¨¡ç‰ˆå®ä½“
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity // å®ä½“
@EntityListeners(AuditingEntityListener.class) // å®¡è®¡
@Table(name = "coupon_template") // è¡¨å
public class CouponTemplate {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id", nullable = false)
    private Long id;

    @Column(name = "name", nullable = false)
    private String name;

    @Column(name = "description", nullable = false)
    private String description;

    @Column(name = "type", nullable = false)
    @Convert(converter = CouponTypeConverter.class)
    private CouponType category;

    @Column(name = "rule", nullable = false)
    @Convert(converter = RuleConverter.class)
    private TemplateRule templateRule;

    // å¦‚æœä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå…¨åº—é€šç”¨ä¼˜æƒ å·
    @Column(name = "shop_id")
    private Long shopId;

    @Column(name = "available", nullable = false)
    private Boolean available;

    @CreatedDate
    @Column(name = "created_time", nullable = false)
    private Date createdTime;
}
```

ä½¿ç”¨ JPA æ³¨è§£å¯ä»¥å°†ç±»å±æ€§æ˜ å°„åˆ°æ•°æ®åº“è¡¨å­—æ®µï¼Œä»¥ä¸‹æ˜¯ä¸€äº›æ ¸å¿ƒæ³¨è§£åŠå…¶ä½œç”¨çš„æ¦‚è¿°ï¼š

| æ³¨è§£            | æè¿°                                                         |
| --------------- | ------------------------------------------------------------ |
| @Entity         | æŒ‡æ˜è¯¥ç±»ä¸ºå®ä½“ç±»ï¼Œå®ƒå°†æ˜ å°„åˆ°æ•°æ®åº“è¡¨ã€‚                       |
| @Table          | æ˜ç¡®æŒ‡å‡ºå®ä½“å¯¹åº”äºæ•°æ®åº“ä¸­çš„å“ªä¸ªè¡¨ã€‚                         |
| @ID             | æ ‡è®°ä¸€ä¸ªå­—æ®µä½œä¸ºå”¯ä¸€çš„ä¸»é”®ã€‚                                 |
| @GeneratedValue | æŒ‡å®šä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œå¦‚è‡ªå¢ã€‚                                   |
| @Column         | å°†å®ä½“çš„å±æ€§æ˜ å°„åˆ°è¡¨çš„ç‰¹å®šåˆ—ï¼Œå¹¶å¯å®šä¹‰åˆ—çš„ç‰¹æ€§ï¼ˆå¦‚éç©ºï¼‰ã€‚   |
| @CreatedDate    | è‡ªåŠ¨è®°å½•å®ä½“åˆ›å»ºçš„æ—¶é—´ã€‚                                     |
| @Convert        | å½“æ•°æ®åº“å­—æ®µä¸å®ä½“å±æ€§ä¸æ˜¯ç›´æ¥æ˜ å°„å…³ç³»æ—¶ï¼Œä½¿ç”¨è¯¥æ³¨è§£æŒ‡å®šä¸€ä¸ªå®ç°äº† `AttributeConverter<X,Y>` æ¥å£çš„è½¬æ¢å™¨ã€‚ |

> âš ï¸ æ³¨æ„ï¼š
>
> å°½ç®¡ JPA æä¾›äº†å¼ºå¤§çš„å…³ç³»æ˜ å°„åŠŸèƒ½ï¼ˆå¦‚ @ManyToOne å’Œ @OneToOneï¼‰ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è¿‡åº¦ä½¿ç”¨è¿™äº›å…³ç³»å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œç”±äºå¯èƒ½å¯¼è‡´å¤æ‚çš„ SQL è¯­å¥å’Œå¤§é‡çš„æ•°æ®åº“æ“ä½œã€‚æ¨èåœ¨å®é™…å¼€å‘ä¸­å°½å¯èƒ½é¿å…çº§è”æŸ¥è¯¢ï¼Œé€šè¿‡ä¸šåŠ¡é€»è¾‘é‡æ„æˆ–æŸ¥è¯¢ä¼˜åŒ–æ¥å‡è½»æ•°æ®åº“è´Ÿæ‹…ã€‚

åœ¨éœ€è¦å°†ç‰¹å®šçš„æ•°æ®åº“åˆ—å€¼è½¬æ¢ä¸º Java å¯¹è±¡æ—¶ï¼Œå®šä¹‰ç›¸åº”çš„ `AttributeConverter` å®ç°ç±»å³å¯ï¼š

```java
/**
 * ä¼˜æƒ å·ç±»å‹è½¬æ¢å™¨
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
public class CouponTypeConverter implements AttributeConverter<CouponType, String> {

    @Override
    public String convertToDatabaseColumn(CouponType attribute) {
        return attribute.getCode();
    }

    @Override
    public CouponType convertToEntityAttribute(String dbData) {
        return CouponType.convert(dbData);
    }
}
```

#### 2.5.3 æ•°æ®è®¿é—®å¯¹è±¡ï¼ˆDAOï¼‰

ä¸ºäº†ä¸æ•°æ®åº“äº¤äº’ï¼Œæˆ‘ä»¬å°†å®šä¹‰ DAO æ¥å£ã€‚ä¾‹å¦‚ï¼Œ`CouponTemplateDAO `å¯ä»¥é€šè¿‡ç»§æ‰¿ `JpaRepository` æ¥å£ï¼Œæä¾›å¯¹ `CouponTemplate` å®ä½“çš„ CRUD æ“ä½œã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬é¿å…äº†ç¼–å†™å¤§é‡çš„ SQL è¯­å¥ï¼ŒåŒæ—¶ Spring Data JPA æä¾›çš„æ–¹æ³•å·²ç»è¶³å¤Ÿåº”å¯¹å¤§å¤šæ•°æ•°æ®è®¿é—®éœ€æ±‚ã€‚

```java
/**
 * ä¼˜æƒ å·æ¨¡ç‰ˆ Dao ( ç¬¬ä¸€ä¸ªæ³›å‹ï¼šå®ä½“ç±»ï¼Œç¬¬äºŒä¸ªæ³›å‹ï¼šä¸»é”®ç±»å‹ )
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
public interface CouponTemplateDao extends JpaRepository<CouponTemplate, Long> {

    /**
     * æ ¹æ®åº—é“ºidæŸ¥è¯¢ä¼˜æƒ å·æ¨¡ç‰ˆ
     *
     * @param shopId åº—é“ºid
     * @return ä¼˜æƒ å·æ¨¡ç‰ˆåˆ—è¡¨
     */
    List<CouponTemplate> findAllByShopId(Long shopId);

    /**
     * æ ¹æ®ç»™å®šçš„idåˆ—è¡¨å’Œåˆ†é¡µä¿¡æ¯ï¼ŒæŸ¥æ‰¾æ‰€æœ‰çš„ä¼˜æƒ åˆ¸æ¨¡æ¿
     *
     * @param ids      ä¼˜æƒ åˆ¸idåˆ—è¡¨
     * @param pageable åˆ†é¡µä¿¡æ¯
     * @return åŒ…å«åŒ¹é…çš„ä¼˜æƒ åˆ¸æ¨¡æ¿çš„åˆ†é¡µå¯¹è±¡
     */
    Page<CouponTemplate> findAllByIdIn(List<Long> ids, Pageable pageable);

    /**
     * æ ¹æ®å•†åº—IDå’Œå¯ç”¨çŠ¶æ€è®¡æ•°
     *
     * @param shopId    å•†åº—ID
     * @param available å¯ç”¨çŠ¶æ€
     * @return è®¡æ•°
     */
    Integer countByShopIdAndAvailable(Long shopId, Boolean available);

    /**
     * å°†ä¼˜æƒ åˆ¸æ¨¡æ¿è®¾ç½®ä¸ºä¸å¯ç”¨
     *
     * @return æ›´æ–°æˆåŠŸæ—¶è¿”å›ä¿®æ”¹çš„è¡Œæ•°
     * @Modifying è¡¨ç¤ºè¯¥æ³¨è§£ç”¨äºä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®
     * @Query è¡¨ç¤ºè¯¥æ³¨è§£ç”¨äºæ‰§è¡Œä¸€ä¸ª JPA æŸ¥è¯¢è¯­å¥
     */
    @Modifying
    @Query("update CouponTemplate c set c.available = 0 where c.id = :id")
    int makeCouponUnavailable(@Param("id") Long shopId);
}
```

åœ¨ `coupon-template-dao` æ¨¡å—ä¸­ï¼Œæ‚¨å¯èƒ½å¥½å¥‡å¦‚ä½•å®ç°å¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹åŠŸèƒ½ï¼Œå› ä¸ºä»£ç ç¤ºä¾‹ä¸­ä¸»è¦å±•ç¤ºäº†æŸ¥è¯¢æ“ä½œã€‚å®é™…ä¸Šï¼Œè¿™äº›åŸºç¡€çš„æ•°æ®åº“æ“ä½œæ–¹æ³•éƒ½éšå«åœ¨ `CouponTemplateDao` ç»§æ‰¿çš„ `JpaRepository` æ¥å£å†…ã€‚

`JpaRepository `æ¥å£æ˜¯ Spring Data JPA çš„å¿ƒè„ï¼Œå®ƒæä¾›äº†åŒ…æ‹¬ï¼š

- `save()`: æ·»åŠ æˆ–æ›´æ–°æ•°æ®
- `delete()`: åˆ é™¤æ•°æ®
- `findOne()`, `findAll()`: æŸ¥è¯¢æ•°æ®

ç­‰ç­‰ä¸€ç³»åˆ—æ ‡å‡†çš„æ•°æ®æ“ä½œæ–¹æ³•ã€‚

é™¤äº†åŸºæœ¬çš„ CRUD åŠŸèƒ½ï¼Œ`JpaRepository `è¿˜æä¾›äº†å¤šæ ·åŒ–çš„æŸ¥è¯¢æ–¹å¼ï¼Œä¾‹å¦‚ï¼š

- **åŸºäºæ–¹æ³•åç§°çš„æŸ¥è¯¢**ï¼šå¯ä»¥é€šè¿‡åœ¨æ¥å£æ–¹æ³•ä¸­å£°æ˜æŸ¥è¯¢æ¡ä»¶çš„æ–¹å¼æ¥æ„å»ºæŸ¥è¯¢ã€‚
- **åŸºäº Example çš„æŸ¥è¯¢**ï¼šä½¿ç”¨ä¸€ä¸ªå®ä½“å¯¹è±¡ä½œä¸ºæŸ¥è¯¢æ¨¡æ¿ã€‚
- **è‡ªå®šä¹‰æŸ¥è¯¢**ï¼šé€šè¿‡ `@Query` æ³¨è§£æ¥å®šä¹‰ SQL æˆ– JPQL æŸ¥è¯¢è¯­å¥ã€‚

ä¾‹å¦‚ï¼Œä½¿ç”¨åŸºäºæ–¹æ³•åç§°çš„æŸ¥è¯¢æ–¹å¼å¯ä»¥è¿™æ ·å®šä¹‰ï¼š

```java
List<CouponTemplate> findAllByShopId(Long shopId);
```

åœ¨ Spring Data JPA ä¸­ï¼Œè¿™ç§æŸ¥è¯¢æ–¹å¼çš„ä¼˜åŠ¿åœ¨äºå…¶ "**çº¦å®šä¼˜äºé…ç½®**" çš„è®¾è®¡ç†å¿µï¼Œç®€åŒ–äº†æŸ¥è¯¢æ“ä½œã€‚ä½ åªéœ€è¦æŒ‰è§„åˆ™æ„é€ æ–¹æ³•åç§°ï¼Œæ¡†æ¶å°±èƒ½ä¸ºä½ ç”Ÿæˆ SQLã€‚

ä½†éœ€éµå®ˆå‘½åè§„åˆ™ï¼ŒåŒ…æ‹¬ï¼š

- **èµ·å§‹è¯**ï¼ˆå¦‚`find`ã€`count`ï¼‰
- **å±æ€§åç§°**ï¼ˆéœ€ä¸å®ä½“å±æ€§åŒ¹é…ï¼‰
- **è¿æ¥è¯**ï¼ˆå¦‚`And`ã€`Or`ï¼‰

åŸºäºæ–¹æ³•åç§°çš„æŸ¥è¯¢åœ¨ç®€å•åœºæ™¯ä¸‹æ˜“äºä½¿ç”¨ï¼Œä½†å¯èƒ½éš¾ä»¥åº”å¯¹å¤æ‚æŸ¥è¯¢ã€‚å¯¹äºæ›´å¤æ‚çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `@Query` æ³¨è§£æ¥è‡ªå®šä¹‰ SQL è¯­å¥ï¼Œå¦‚ï¼š

```java
@Query("update CouponTemplate c set c.available = false where c.id = :id")
int makeCouponUnavailable(@Param("id") Long id);
```

æˆ–è€…é‡‡ç”¨ Example æŸ¥è¯¢ï¼Œåˆ›å»ºä¸€ä¸ªæŸ¥è¯¢æ¨¡æ¿å®ä¾‹ï¼š

```java
CouponTemplate couponTemplate = new CouponTemplate();
couponTemplate.setName("ä¼˜æƒ åˆ¸åç§°");
List<CouponTemplate> results = templateDao.findAll(Example.of(couponTemplate));
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ¨¡æ¿å¯¹è±¡çš„å±æ€§è¿›è¡ŒæŸ¥è¯¢ã€‚

OKï¼Œæœ‰äº† API å’Œ Dao å±‚çš„åŸºç¡€ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å°†è¿›å…¥ä¸šåŠ¡é€»è¾‘å±‚çš„å¼€å‘ï¼Œå³ `coupon-template-impl` æ¨¡å—ã€‚åœ¨è¿™ä¸€å±‚ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ©ç”¨å·²ç»æ­å»ºå¥½çš„ç»“æ„æ¥å®ç°å…·ä½“çš„ä¸šåŠ¡åŠŸèƒ½ã€‚

### 2.6 æ­å»º coupon-template-impl æ¨¡å—

#### 2.6.1 ä¾èµ–é…ç½®

å½“æˆ‘ä»¬å¼€å§‹æ­å»º `coupon-template-impl` æ¨¡å—æ—¶ï¼Œæˆ‘ä»¬å°†å…¶å®šä¹‰ä¸ºå®ç°ä¸šåŠ¡é€»è¾‘çš„æ ¸å¿ƒã€‚å®ƒå°†ä¾èµ–äºä¹‹å‰æ„å»ºçš„ `coupon-template-api` å’Œ `coupon-template-dao` æ¨¡å—ï¼ŒåŒæ—¶ï¼Œè¿˜ä¼šå¼•å…¥ä¸€äº›å¤–éƒ¨ä¾èµ–æ¥å¢å¼ºåŠŸèƒ½ã€‚

```xml
<dependencies>
    <!-- API æ¨¡å— -->
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-template-api</artifactId>
        <version>${project.version}</version>
    </dependency>

    <!-- DAO æ¨¡å— -->
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-template-dao</artifactId>
        <version>${project.version}</version>
    </dependency>

    <!-- Alibaba FastJson -->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
    </dependency>

    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Apache Commons Codec -->
    <dependency>
        <groupId>commons-codec</groupId>
        <artifactId>commons-codec</artifactId>
    </dependency>

    <!-- Google Guava -->
    <dependency>
        <groupId>com.google.guava</groupId>
        <artifactId>guava</artifactId>
    </dependency>

    <!-- Spring Boot Actuator å¯¹å¾®æœåŠ¡ç«¯ç‚¹è¿›è¡Œç®¡ç†å’Œé…ç½®ç›‘æ§ -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>

</dependencies>
```

#### 2.6.2 å®šä¹‰ Service å±‚æ¥å£

é¦–å…ˆï¼Œå®šä¹‰ `CouponTemplateService` æ¥å£æ˜¯å…³é”®ï¼Œè¿™ä¸ªæ¥å£ä¼šè§„å®šäº†å‡ ä¸ªä¸»è¦æ–¹æ³•ï¼š

- åˆ›å»ºä¼˜æƒ åˆ¸æ¨¡æ¿
- æŸ¥è¯¢ä¼˜æƒ åˆ¸æ¨¡æ¿
- ä¿®æ”¹ä¼˜æƒ åˆ¸æ¨¡æ¿çŠ¶æ€

```java
/**
 * ä¼˜æƒ å·æ¨¡ç‰ˆæœåŠ¡æ¥å£
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
public interface CouponTemplateService {

    /**
     * åˆ›å»ºä¼˜æƒ åˆ¸æ¨¡æ¿
     *
     * @param couponTemplateInfo ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
     * @return åˆ›å»ºçš„ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
     */
    CouponTemplateInfo createCouponTemplate(CouponTemplateInfo couponTemplateInfo);

    /**
     * å…‹éš†ä¼˜æƒ åˆ¸æ¨¡æ¿
     *
     * @param templateId æ¨¡æ¿ID
     * @return å…‹éš†çš„ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
     */
    CouponTemplateInfo cloneCouponTemplate(Long templateId);

    /**
     * æœç´¢ä¼˜æƒ åˆ¸æ¨¡æ¿
     *
     * @param templateSearchParams æœç´¢å‚æ•°
     * @return æœç´¢åˆ°çš„ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
     */
    PagedCouponTemplateInfo searchCouponTemplate(TemplateSearchParams templateSearchParams);

    /**
     * åŠ è½½ä¼˜æƒ åˆ¸æ¨¡æ¿
     *
     * @param id æ¨¡æ¿ID
     * @return åŠ è½½çš„ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
     */
    CouponTemplateInfo loadCouponTemplate(Long id);

    /**
     * åˆ é™¤ä¼˜æƒ åˆ¸æ¨¡æ¿
     *
     * @param id æ¨¡æ¿ID
     */
    void deleteCouponTemplate(Long id);

    /**
     * æ ¹æ®æ¨¡æ¿IDåˆ—è¡¨è·å–ä¼˜æƒ åˆ¸æ¨¡æ¿Map
     *
     * @param ids æ¨¡æ¿IDåˆ—è¡¨
     * @return ä¼˜æƒ åˆ¸æ¨¡æ¿Map
     */
    Map<Long, CouponTemplateInfo> getCouponTemplateMap(Collection<Long> ids);

}
```

#### 2.6.3 å®ç° Service å±‚é€»è¾‘

`CouponTemplateServiceImpl `ç±»å°†å®ç°ä¸Šè¿°æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚é€šè¿‡ä¸ `CouponTemplateDao` äº¤äº’ï¼ŒService å±‚èƒ½å¤Ÿå®ç°å¯¹ä¼˜æƒ åˆ¸æ¨¡æ¿çš„ CRUD æ“ä½œã€‚

```java
/**
 * ä¼˜æƒ å·æ¨¡æ¿æœåŠ¡å®ç°
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
@Slf4j
@Service
public class CouponTemplateServiceImpl implements CouponTemplateService {

    @Resource
    private CouponTemplateDao couponTemplateDao;

    @Override
    public CouponTemplateInfo createCouponTemplate(CouponTemplateInfo couponTemplateInfo) {
        // å•ä¸ªå•†æˆ·æœ€å¤šå¯ä»¥åˆ›å»º 100 å¼ ä¼˜æƒ å·æ¨¡ç‰ˆ
        if (couponTemplateInfo.getShopId() != null) {
            Integer count = couponTemplateDao.countByShopIdAndAvailable(couponTemplateInfo.getShopId(), true);
            if (count > 100) {
                log.error("è¯¥åº—é“ºä¼˜æƒ å·æ¨¡æ¿æ•°é‡è¶…è¿‡100");
                throw new UnsupportedOperationException("è¯¥åº—é“ºä¼˜æƒ å·æ¨¡æ¿æ•°é‡è¶…è¿‡100");
            }
        }

        CouponTemplate couponTemplate = CouponTemplate.builder()
                .name(couponTemplateInfo.getName())
                .description(couponTemplateInfo.getDesc())
                .templateRule(couponTemplateInfo.getTemplateRule())
                .available(couponTemplateInfo.getAvailable())
                .shopId(couponTemplateInfo.getShopId())
                .category(CouponType.convert(couponTemplateInfo.getType()))
                .build();

        CouponTemplate template = couponTemplateDao.save(couponTemplate);
        return CouponTemplateConverter.converterTemplateInfo(template);
    }

    @Override
    public CouponTemplateInfo cloneCouponTemplate(Long templateId) {
        log.info("cloneCouponTemplate templateId: {}", templateId);

        // å‡†å¤‡æ‹·è´æºå’Œç›®æ ‡å¯¹è±¡
        CouponTemplate source = couponTemplateDao.findById(templateId)
                .orElseThrow(() -> new IllegalArgumentException("æ— æ•ˆçš„ä¼˜æƒ å·æ¨¡ç‰ˆID"));
        CouponTemplate target = new CouponTemplate();

        // æµ…æ‹·è´
        BeanUtils.copyProperties(source, target);

        // å…¶ä»–æ•°æ®å¤„ç†
        target.setAvailable(true);
        target.setId(null);

        // å­˜å‚¨å¹¶è¿”å›
        couponTemplateDao.save(target);
        return CouponTemplateConverter.converterTemplateInfo(target);
    }

    @Override
    public PagedCouponTemplateInfo searchCouponTemplate(TemplateSearchParams templateSearchParams) {
        // åˆ›å»º JPA Example æŸ¥è¯¢æ¡ä»¶
        CouponTemplate example = CouponTemplate.builder()
                .shopId(templateSearchParams.getShopId())
                .category(CouponType.convert(templateSearchParams.getType()))
                .name(templateSearchParams.getName())
                .available(templateSearchParams.getAvailable())
                .build();

        // å°è£…åˆ†é¡µæŸ¥è¯¢å‚æ•°
        PageRequest pageRequest = PageRequest.of(templateSearchParams.getPage(), templateSearchParams.getPageSize());

        Page<CouponTemplate> result = couponTemplateDao.findAll(Example.of(example), pageRequest);
        List<CouponTemplateInfo> couponTemplateInfoList = result.stream()
                .map(CouponTemplateConverter::converterTemplateInfo)
                .collect(Collectors.toList());

        return PagedCouponTemplateInfo.builder()
                .couponTemplateInfoList(couponTemplateInfoList)
                .page(templateSearchParams.getPage())
                .total(result.getTotalElements())
                .build();
    }

    @Override
    public CouponTemplateInfo loadCouponTemplate(Long id) {
        Optional<CouponTemplate> couponTemplate = couponTemplateDao.findById(id);
        return couponTemplate.map(CouponTemplateConverter::converterTemplateInfo).orElse(null);
    }

    @Override
    public void deleteCouponTemplate(Long id) {
        int rows = couponTemplateDao.makeCouponUnavailable(id);
        if (rows == 0) {
            throw new UnsupportedOperationException("æ— æ•ˆçš„ä¼˜æƒ å·æ¨¡ç‰ˆID");
        }
    }

    @Override
    public Map<Long, CouponTemplateInfo> getCouponTemplateMap(Collection<Long> ids) {
        List<CouponTemplate> couponTemplateList = couponTemplateDao.findAllById(ids);
        return couponTemplateList.stream()
                .map(CouponTemplateConverter::converterTemplateInfo)
                .collect(Collectors.toMap(CouponTemplateInfo::getId, Function.identity()));
    }
}
```

#### 2.6.4 è½¬æ¢ç±»çš„ä½¿ç”¨

åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šä½¿ç”¨åˆ°å„ç§è½¬æ¢ç±»ï¼ˆDTOsã€VOsç­‰ï¼‰æ¥åœ¨ä¸åŒå±‚ï¼ˆControllerã€Serviceã€DAOï¼‰é—´ä¼ è¾“æ•°æ®ã€‚è¿™äº›è½¬æ¢ç±»é€šå¸¸è´Ÿè´£å°†æ•°æ®åº“å®ä½“è½¬æ¢ä¸ºå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨çš„æ•°æ®æ¨¡å‹ï¼Œæˆ–è€…åä¹‹ã€‚

æ¶‰åŠåˆ°çš„è½¬æ¢ç±»ï¼š

```java
/**
 * ä¼˜æƒ å·æ¨¡æ¿è½¬æ¢å™¨
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
public class CouponTemplateConverter {

    public static CouponTemplateInfo converterTemplateInfo(CouponTemplate couponTemplate) {
        return CouponTemplateInfo.builder()
                .id(couponTemplate.getId())
                .name(couponTemplate.getName())
                .desc(couponTemplate.getDescription())
                .type(couponTemplate.getCategory().getCode())
                .shopId(couponTemplate.getShopId())
                .templateRule(couponTemplate.getTemplateRule())
                .available(couponTemplate.getAvailable())
                .build();
    }
}
```

#### 2.6.5 æ„å»º Controller

æ¥ç€ï¼Œåˆ›å»º `CouponTemplateController` ç±»æ¥æä¾› RESTful æœåŠ¡ã€‚é€šè¿‡ä½¿ç”¨ Spring MVC çš„æ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†åç«¯æœåŠ¡ä»¥ API çš„å½¢å¼æä¾›ç»™å®¢æˆ·ç«¯æˆ–å‰ç«¯ã€‚

æ§åˆ¶å™¨é€šå¸¸ä½¿ç”¨ä»¥ä¸‹æ³¨è§£ï¼š

| æ³¨è§£                                 | æè¿°                                               |
| ------------------------------------ | -------------------------------------------------- |
| @RestController                      | å£°æ˜è¿™æ˜¯ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå¹¶å°†å…¶åŠ è½½åˆ° Spring ä¸Šä¸‹æ–‡ä¸­ã€‚ |
| @RequestMapping                      | å®šä¹‰ç±»çº§åˆ«çš„è·¯ç”±ä¿¡æ¯ã€‚                             |
| @PostMapping/@GetMapping/@PutMapping | å®šä¹‰å…·ä½“çš„ HTTP æ“ä½œå’Œè·¯ç”±ã€‚                       |

ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒä»£ç ï¼š

```java
/**
 * ä¼˜æƒ å·æ¨¡æ¿æ§åˆ¶å™¨
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
@Slf4j
@RestController
@RequestMapping("/template")
public class CouponTemplateController {

    @Resource
    private CouponTemplateService couponTemplateService;

    @PostMapping("/addTemplate")
    public CouponTemplateInfo addTemplate(@Valid @RequestBody CouponTemplateInfo request) {
        log.info("Create coupon template: data={}", request);
        return couponTemplateService.createCouponTemplate(request);
    }

    @PostMapping("/cloneTemplate")
    public CouponTemplateInfo cloneTemplate(@RequestParam("id") Long templateId) {
        log.info("Clone coupon template: data={}", templateId);
        return couponTemplateService.cloneCouponTemplate(templateId);
    }

    @GetMapping("/getTemplate")
    public CouponTemplateInfo getTemplate(@RequestParam("id") Long id) {
        log.info("Load template, id={}", id);
        return couponTemplateService.loadCouponTemplate(id);
    }

    @GetMapping("/getBatch")
    public Map<Long, CouponTemplateInfo> getTemplateInBatch(@RequestParam("ids") Collection<Long> ids) {
        log.info("getTemplateInBatch: {}", JSON.toJSONString(ids));
        return couponTemplateService.getCouponTemplateMap(ids);
    }

    @PostMapping("/search")
    public PagedCouponTemplateInfo search(@Valid @RequestBody TemplateSearchParams request) {
        log.info("search templates, payload={}", request);
        return couponTemplateService.searchCouponTemplate(request);
    }

    @DeleteMapping("/deleteTemplate")
    public void deleteTemplate(@RequestParam("id") Long id) {
        log.info("Load template, id={}", id);
        couponTemplateService.deleteCouponTemplate(id);
    }
}
```

#### 2.6.6 å¯åŠ¨ç±»çš„åˆ›å»º

æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºäº†`Application`ç±»ï¼Œè¿™æ˜¯æ•´ä¸ªåº”ç”¨çš„å…¥å£ç‚¹ã€‚`@SpringBootApplication` æ³¨è§£å°†è§¦å‘ Spring Boot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶ã€‚

è¿™ä¸ªæ³¨è§£è¿˜è´Ÿè´£æ‰«æå¯åŠ¨ç±»æ‰€åœ¨åŒ…åŠå…¶å­åŒ…ä¸­çš„ç»„ä»¶ï¼Œå¹¶åœ¨ Spring ä¸Šä¸‹æ–‡ä¸­è‡ªåŠ¨æ³¨å†Œå®ƒä»¬ã€‚å¦‚æœéœ€è¦åŒ…å«å…¶ä»–è·¯å¾„ä¸‹çš„ç»„ä»¶ï¼Œ`@ComponentScan `æ³¨è§£å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŒ‡å®šé‚£äº›è·¯å¾„ã€‚

```java
@SpringBootApplication
@EnableJpaAuditing // å¯ç”¨ JPA çš„å®¡è®¡åŠŸèƒ½
@ComponentScan(basePackages = {"cn.javgo"})
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

#### 2.6.7 é…ç½®æ–‡ä»¶

å®Œæˆä»£ç ç¼–å†™åï¼Œæ¥ä¸‹æ¥çš„æ­¥éª¤æ˜¯åˆ›å»ºå’Œé…ç½® `.properties `æ–‡ä»¶ã€‚è¿™ä¸ªé…ç½®æ–‡ä»¶åœ¨ `src/main/resources` ç›®å½•ä¸‹æ˜¯é¡¹ç›®çš„å…³é”®éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒåŒ…å«äº†è¿æ¥æ•°æ®åº“å’Œå„ç§æœåŠ¡çš„å¿…è¦å‚æ•°ã€‚

é…ç½®æ–‡ä»¶çš„æ’°å†™ä¸ä»…éœ€è¦ç²¾ç¡®ï¼Œè¿˜éœ€è¦è€ƒè™‘åˆ°å¯è¯»æ€§å’Œæœªæ¥çš„å¯ç»´æŠ¤æ€§ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ¨èçš„æœ€ä½³å®è·µï¼š

- ä½¿ç”¨æ¸…æ™°çš„æ³¨é‡Šæ¥æè¿°æ¯ä¸ªé…ç½®é¡¹çš„ä½œç”¨ï¼Œç‰¹åˆ«æ˜¯é‚£äº›ä¸å¸¸è§æˆ–å®¹æ˜“å¼•èµ·æ··æ·†çš„å‚æ•°ã€‚
- ä¸ºäº†ä¿è¯åœ¨ä¸åŒç¯å¢ƒä¸‹çš„å…¼å®¹æ€§ï¼Œä¾‹å¦‚å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼Œå¯ä»¥é‡‡ç”¨ `application-{profile}.properties` çš„æ–¹å¼æ¥ç®¡ç†ä¸åŒçš„é…ç½®ã€‚
- å¯¹äº JDBC è¿æ¥å­—ç¬¦ä¸²ï¼Œç¡®ä¿å…¶æ ¼å¼å’Œå‚æ•°ä¸ä½ ä½¿ç”¨çš„æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹ã€‚å¦‚æœä½¿ç”¨ MySQL 8.xï¼Œä¸è¦å¿˜è®°åŒ…æ‹¬å¦‚ `serverTimezone` çš„å¿…è¦å‚æ•°ã€‚
- é‰´äºå®‰å…¨è€ƒè™‘ï¼Œæ•æ„Ÿä¿¡æ¯ï¼ˆæ¯”å¦‚æ•°æ®åº“å¯†ç ã€API å¯†é’¥ç­‰ï¼‰ä¸åº”è¯¥ç›´æ¥ç¡¬ç¼–ç åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚è€ƒè™‘ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–åŠ å¯†å·¥å…·æ¥ç®¡ç†è¿™äº›æ•æ„Ÿæ•°æ®ã€‚

```properties
# æœåŠ¡å™¨ç«¯å£
server.port=20000

# æ˜¯å¦åœ¨é”™è¯¯ä¿¡æ¯ä¸­åŒ…å«æ¶ˆæ¯
server.error.include-message=always

# åº”ç”¨åç§°
spring.application.name=coupon-template-serv

# æ•°æ®åº“é©±åŠ¨ç±»å
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
# æ•°æ®åº“è¿æ¥URL
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/coupon_db?autoReconnect=true&useUnicode=true&characterEncoding=utf8&useSSL=false&allowPublicKeyRetrieval=true&zeroDateTimeBehavior=convertToNull&serverTimezone=UTC
# æ•°æ®åº“ç”¨æˆ·å
spring.datasource.username=root
# æ•°æ®åº“å¯†ç 
spring.datasource.password=root

# æ•°æ®æºç±»å‹
spring.datasource.type=com.zaxxer.hikari.HikariDataSource
# æ•°æ®æºè¿æ¥æ± åç§°
spring.datasource.hikari.pool-name=CouponHikari
# è¿æ¥è¶…æ—¶æ—¶é—´
spring.datasource.hikari.connection-timeout=5000
# ç©ºé—²è¶…æ—¶æ—¶é—´
spring.datasource.hikari.idle-timeout=30000
# æœ€å¤§è¿æ¥æ± å¤§å°
spring.datasource.hikari.maximum-pool-size=10
# æœ€å°è¿æ¥æ± å¤§å°
spring.datasource.hikari.minimum-idle=5
# è¿æ¥ç”Ÿå‘½å‘¨æœŸ
spring.datasource.hikari.max-lifetime=60000
# è‡ªåŠ¨æäº¤
spring.datasource.hikari.auto-commit=true

# æ˜¯å¦æ˜¾ç¤º Hibernate SQL è¯­å¥
spring.jpa.show-sql=true
# JPA ç”ŸæˆDDLçš„æ–¹å¼
spring.jpa.hibernate.ddl-auto=none
# Hibernate SQL è¯­å¥æ ¼å¼åŒ–
spring.jpa.properties.hibernate.format_sql=true
# Hibernate SQL è¯­å¥æ˜¾ç¤º
spring.jpa.properties.hibernate.show_sql=true
# æ˜¯å¦åœ¨è§†å›¾ä¸­æ‰“å¼€ JPA è¿æ¥
spring.jpa.open-in-view=false

# æ—¥å¿—çº§åˆ«
logging.level.cn.javgo.coupon=debug
```

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ä¼˜æƒ åˆ¸å¹³å°çš„é¦–ä¸ªæ¨¡å—  `coupon-template-serv`  å·²ç»æ„å»ºå®Œæˆã€‚ä½ å¯ä»¥åœ¨æœ¬åœ°å¯åŠ¨é¡¹ç›®ï¼Œå¹¶ä½¿ç”¨ Postman å·¥å…·è¿›è¡Œæµ‹è¯•ã€‚ä½ ä¹Ÿå¯ä»¥è‡ªè¡ŒåŠ å…¥ Swaggerï¼š

![](https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-134423.png)

#### 2.6.8 æ¨¡å—å°ç»“

åœ¨æœ¬æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å®Œæˆäº† `coupon-template-serv` çš„æ­å»ºï¼Œè¿™æ˜¯ä¼˜æƒ åˆ¸å¹³å°çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚æˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•æœ‰æ•ˆåˆ©ç”¨ Spring Boot çš„åŠŸèƒ½ï¼Œç®€åŒ–äº†æœåŠ¡çš„å®ç°ï¼Œå¹¶ä»‹ç»äº†å¦‚ä½•é€šè¿‡ Spring Data JPA é«˜æ•ˆåœ°æ“ä½œæ•°æ®åº“ã€‚

å…³é”®æŠ€æœ¯ç‚¹å›é¡¾ï¼š

* ä½¿ç”¨ `spring-data-jpa` è¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œå®ç°äº† CRUD åŠŸèƒ½ï¼Œå¹¶é€šè¿‡å®ƒä½“éªŒåˆ°äº† Spring çš„ â€œçº¦å®šä¼˜äºé…ç½®â€ çš„ç†å¿µã€‚
* å¼ºè°ƒäº†ä»£ç çš„é˜²å¾¡æ€§ç¼–ç¨‹ã€è‡ªåŠ¨åŒ–ç”Ÿæˆã€å’Œç²¾ç¡®çš„é‡‘é¢è®¡ç®—ç­‰ç¼–ç æŠ€å·§ã€‚
* æ¢è®¨äº†æ•°æ®æ ¡éªŒçš„ç®€åŒ–æ–¹æ³•å’Œé¿å…çº§è”å…³ç³»çš„å¸¸è§é™·é˜±ã€‚

é€šè¿‡ä»¥ä¸Šçš„æ¢ç´¢å’Œå­¦ä¹ ï¼Œä½ ç°åœ¨åº”è¯¥å¯¹æ„å»ºä¸€ä¸ªæ¨¡å—åŒ–ã€å¯æ‰©å±•çš„ Spring Boot  åº”ç”¨æœ‰äº†æ·±å…¥çš„ç†è§£ã€‚ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ­å»º`coupon-calculation-serv` å’Œ `coupon-customer-serv` æ¨¡å—ï¼Œè¿›ä¸€æ­¥æ‰©å±•æˆ‘ä»¬çš„ä¼˜æƒ åˆ¸å¹³å°ã€‚

## 3.æ­å»ºä¼˜æƒ åˆ¸è®¡ç®—æœåŠ¡

é€šè¿‡å‰é¢çš„ç« èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¼˜æƒ åˆ¸æ¨¡æ¿æœåŠ¡ `coupon-template-serv` çš„æ­å»ºï¼Œå¹¶å¯¹ Spring Boot æœ‰äº†æ›´æ·±å±‚æ¬¡çš„ç†è§£ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥å¼€å‘ä¼˜æƒ åˆ¸ç³»ç»Ÿçš„ä¸¤ä¸ªå…³é”®ç»„ä»¶ï¼š`coupon-calculation-serv`ï¼ˆè´Ÿè´£ä¼˜æƒ è®¡ç®—ï¼‰å’Œ`coupon-customer-serv`ï¼ˆå‘ç”¨æˆ·æä¾›æœåŠ¡ï¼‰ã€‚åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œä¸­é—´ä»¶æ¨¡å— `middleware` çš„è¯¦ç»†æ¢è®¨å°†æ”¾åœ¨æ¶‰åŠ Spring Cloud çš„éƒ¨åˆ†è¿›è¡Œã€‚

æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥æ˜¯å»ºç«‹ `coupon-calculation-serv`ï¼Œä¸€ä¸ªä¸“æ³¨äºä¸ºè®¢å•æä¾›ä¼˜æƒ è®¡ç®—çš„æœåŠ¡æ¥å£ã€‚`coupon-calculation-serv` ä½œä¸ºå…¸å‹çš„è®¡ç®—å¯†é›†å‹æœåŠ¡ï¼Œå…¶ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

1. ä¸å—ç½‘ç»œ I/O å’Œç£ç›˜ç©ºé—´é™åˆ¶ï¼›
2. åœ¨è¿è¡Œæ—¶ä¸»è¦æ¶ˆè€— CPU å’Œå†…å­˜ç­‰è®¡ç®—èµ„æºã€‚

åœ¨æ„å»ºå¤§å‹åº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæŠŠ**è®¡ç®—å¯†é›†å‹æœåŠ¡å’Œ I/O æˆ–å­˜å‚¨å¯†é›†å‹æœåŠ¡åˆ†ç¦»**å¼€ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¼˜åŒ–èµ„æºä½¿ç”¨æ•ˆç‡ã€‚ä»¥ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥è¯´æ˜ï¼Œå‡è®¾æˆ‘ä»¬åŒæ—¶è¿è¡Œä¸€ä¸ªè®¡ç®—å¯†é›†å‹çš„å¾®æœåŠ¡ A å’Œä¸€ä¸ª I/O å¯†é›†å‹çš„å¾®æœåŠ¡ Bã€‚åœ¨é«˜æµé‡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæœåŠ¡ A åˆ†é…æ›´å¤šçš„ CPU å’Œå†…å­˜èµ„æºæ¥åº”å¯¹å‹åŠ›ï¼›å¯¹äºæœåŠ¡ Bï¼Œåˆ™å¯ä»¥å¢åŠ äº‘å­˜å‚¨èµ„æºã€‚è¿™æ · â€œ**æŒ‰éœ€åˆ†é…**â€ çš„ç­–ç•¥èƒ½å¤Ÿæœ‰æ•ˆåœ°æé«˜èµ„æºä½¿ç”¨ç‡ã€‚

å¦‚æœæˆ‘ä»¬å°†æœåŠ¡ A å’Œ B åˆå¹¶åœ¨ä¸€èµ·ï¼Œå°±ä¼šå¤±å»å¯¹èµ„æºåˆ†é…çš„ç²¾ç¡®æ§åˆ¶ï¼Œå…¨é“¾è·¯å‹åŠ›æµ‹è¯•ä¹Ÿæ— æ³•å‡†ç¡®è¯„ä¼°æ€§èƒ½æŒ‡æ ‡ï¼Œä»è€Œå¯èƒ½é€ æˆèµ„æºçš„æµªè´¹ã€‚å› æ­¤ï¼Œæˆ‘å»ºè®®å°†ä¼˜æƒ è®¡ç®—æœåŠ¡ç‹¬ç«‹å‡ºæ¥ï¼Œä»¥å®ç°æ›´åˆç†çš„èµ„æºé…ç½®ã€‚

ç°åœ¨è®©æˆ‘ä»¬ç€æ‰‹æ„å»º `coupon-calculation-serv`ã€‚å®ƒå°†åŒ…å«å¤šä¸ªå­æ¨¡å—ï¼Œç±»ä¼¼äº `coupon-template-serv` çš„ç»“æ„ï¼ŒåŒ…æ‹¬ API å±‚å’Œä¸šåŠ¡é€»è¾‘å±‚ã€‚API å±‚è´Ÿè´£å®šä¹‰å…¬å…±çš„ POJO ç±»ï¼Œè€Œä¸šåŠ¡é€»è¾‘å±‚åˆ™ä¸“æ³¨äºä¼˜æƒ è®¡ç®—é€»è¾‘çš„å®ç°ã€‚ç”±äºä¼˜æƒ è®¡ç®—æœåŠ¡ä¸æ¶‰åŠæ•°æ®åº“æ“ä½œï¼Œæˆ‘ä»¬å°†ä¸åŒ…å« DAO æ¨¡å—ã€‚

æˆ‘ä»¬é¦–å…ˆä» `coupon-calculation-api` å­æ¨¡å—å…¥æ‰‹ï¼Œè¿™æ˜¯æ•´ä¸ªæœåŠ¡çš„æ¥å£å±‚ã€‚

### 3.1 æ­å»º coupon-calculation-api æ¨¡å—

ä¸ºäº†ä½¿ `coupon-calculation-serv` èƒ½å¤Ÿè®¡ç®—è®¢å•çš„ä¼˜æƒ ä»·æ ¼ï¼Œå®ƒéœ€è¦çŸ¥é“å½“å‰è®¢å•ä½¿ç”¨äº†å“ªäº›ä¼˜æƒ åˆ¸ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¼•å…¥å°è£…ä¼˜æƒ åˆ¸ä¿¡æ¯çš„ Java ç±»`CouponInfo`ï¼Œè¯¥ç±»ä½äº `coupon-template-api` åŒ…ä¸­ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨ `coupon-calculation-api` ä¸­æ·»åŠ  `coupon-template-api` çš„ä¾èµ–é¡¹ã€‚

```xml
<dependencies>
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-template-api</artifactId>
        <version>${project.version}</version>
    </dependency>
</dependencies>
```

ä¾èµ–é¡¹æ·»åŠ å®Œæ¯•åï¼Œæˆ‘ä»¬ç»§ç»­å®šä¹‰ç”¨äºå°è£…è®¢å•ä¿¡æ¯çš„ `ShoppingCart `ç±»ï¼š

```java
/**
 * å°è£…è®¢å•ä¿¡æ¯
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ShoppingCart {

    /**
     * å•†å“ä¿¡æ¯
     */
    @NotEmpty
    private Product product;

    /**
     * ä¼˜æƒ åˆ¸ID
     */
    private Long couponId;

    /**
     * è®¢å•æ€»ä»·
     */
    private long cost;

    /**
     * ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ—è¡¨
     * è¯´æ˜ï¼šç›®å‰ä»…æ”¯æŒå•å¼ ä¼˜æƒ åˆ¸ï¼Œä½†æ˜¯ä¸ºäº†ä»¥åçš„æ‰©å±•è€ƒè™‘ï¼Œä½ å¯ä»¥æ·»åŠ å¤šä¸ªä¼˜æƒ åˆ¸çš„è®¡ç®—é€»è¾‘
     */
    private List<CouponInfo> couponInfos;

    /**
     * ç”¨æˆ·ID
     */
    @NotNull
    private Long userId;
}
```

ä»ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `ShoppingCart` è®¢å•ç±»ä½¿ç”¨äº† `Product` å¯¹è±¡æ¥å°è£…å½“å‰è®¢å•çš„å•†å“åˆ—è¡¨ã€‚`Product` ç±»ä¸­åŒ…å«äº†å•†å“çš„å•ä»·ã€æ•°é‡ä»¥åŠé—¨åº—IDã€‚

```java
/**
 * å°è£…å•†å“ä¿¡æ¯
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Product {

    /**
     * ä½ å¯ä»¥è¯•ç€æ­å»ºä¸€ä¸ªå•†å“ä¸­å¿ƒï¼Œç”¨æ¥å­˜å‚¨å•†å“ä¿¡æ¯ï¼Œé€æ­¥å®Œå–„è¿™ä¸ªåº”ç”¨
     */
    private Long productId;

    /**
     * å•†å“çš„ä»·æ ¼
     */
    private long price;

    /**
     * å•†å“åœ¨è´­ç‰©è½¦é‡Œçš„æ•°é‡
     */
    private Integer count;

    /**
     * å•†å“é”€å”®çš„é—¨åº—
     */
    private Long shopId;
}
```

> åœ¨ç”µå•†è¡Œä¸šï¼Œå•†å“æ•°é‡é€šå¸¸ä¸ä»…ä»…æ˜¯æ•´æ•°ã€‚ä¾‹å¦‚ï¼Œå¯¹äºè”¬èœæˆ–è‚‰ç±»è¿™æ ·çš„éæ ‡å‡†å•†å“ï¼Œå®ƒä»¬çš„è®¡é‡å•ä½å¯èƒ½ä¸æ˜¯ â€œä¸ªâ€ã€‚å› æ­¤ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œç‰¹åˆ«æ˜¯é›¶å”®ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œè®¡é‡å•ä½åº”è¯¥å…è®¸å°æ•°ã€‚ä½†ä¸ºäº†ç®€åŒ–æœ¬é¡¹ç›®ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰å•†å“éƒ½æ˜¯æ ‡å‡†å•†å“ã€‚

åœ¨ä¸‹å•æ—¶ï¼Œå¯èƒ½æœ‰å¤šå¼ ä¼˜æƒ åˆ¸å¯ä¾›é€‰æ‹©ã€‚ä¸ºäº†ç¡®å®šå“ªå¼ ä¼˜æƒ åˆ¸æä¾›çš„æŠ˜æ‰£æœ€å¤§ï¼Œä½ éœ€è¦è¿›è¡Œ â€œ**ä»·æ ¼è¯•ç®—**â€ æ¥æ¨¡æ‹Ÿè®¡ç®—æ¯å¼ ä¼˜æƒ åˆ¸çš„æŠ˜æ‰£é‡‘é¢ã€‚`SimulationOrder` å’Œ `SimulationResponse` åˆ†åˆ«ä»£è¡¨äº† â€œä»·æ ¼è¯•ç®—â€ çš„è®¢å•ç±»å’Œè¿”å›çš„è®¡ç®—ç»“æœã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹è¿™ä¸¤ä¸ªç±»çš„ä»£ç ã€‚

```java
/**
 * å°è£…æ¨¡æ‹Ÿè®¢å•ä¿¡æ¯ï¼šç”¨äºè¯•ç®—æœ€ä¼˜çš„ä¼˜æƒ åˆ¸
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class SimulationOrder {

    /**
     * å•†å“ä¿¡æ¯åˆ—è¡¨
     */
    @NotEmpty
    private List<Product> products;
    
    /**
     * ä¼˜æƒ åˆ¸IDåˆ—è¡¨
     */
    @NotEmpty
    private List<Long> couponIDs;
    
    /**
     * ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ—è¡¨
     */
    private List<CouponInfo> couponInfos;
    
    /**
     * ç”¨æˆ·ID
     */
    @NotNull
    private Long userId;
}
```

```java
/**
 * å°è£…æ¨¡æ‹Ÿè®¡ç®—ç»“æœ
 */
@Data
@NoArgsConstructor
public class SimulationResponse {

    /**
     * æœ€çœé’±çš„ä¼˜æƒ å· ID
     */
    private Long bestCouponId;

    /**
     * æ¯ä¸€ä¸ªä¼˜æƒ å·å¯¹åº”çš„è®¢å•ä»·æ ¼
     */
    private Map<Long, Long> couponToOrderPrice = Maps.newHashMap();
}
```

è‡³æ­¤ï¼Œ`coupon-calculation-api `æ¨¡å—çš„æ­å»ºå·²ç»å®Œæˆã€‚ç”±äºè®¡ç®—æœåŠ¡ä¸éœ€è¦è®¿é—®æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡ dao æ¨¡å—çš„æ­å»ºï¼Œç›´æ¥è¿›å…¥ `coupon-calculation-impl` ä¸šåŠ¡å±‚çš„ä»£ç å®ç°ã€‚

### 3.2 æ­å»º coupon-calculation-impl æ¨¡å—

#### 3.2.1 ä¾èµ–é…ç½®

åœ¨å®ç° `coupon-calculation-impl` æ¨¡å—ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¶ `pom.xml `ä¸­æ˜ç¡®åŠ å…¥ä¸‰ä¸ªæ ¸å¿ƒä¾èµ–ã€‚è¿™äº›ä¾èµ–é¡¹ï¼Œå°¤å…¶æ˜¯ `coupon-template-api` å’Œ `coupon-calculation-api`ï¼Œå°†ä¸ºæˆ‘ä»¬æä¾›å®Œæˆè®¢å•ä¼˜æƒ è®¡ç®—æ‰€éœ€çš„ POJO å¯¹è±¡ã€‚è¿™æ˜¯æ„å»ºä¼˜æƒ è®¡ç®—é€»è¾‘çš„åŸºç¡€ã€‚

```xml
<dependencies>
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-template-api</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-calculation-api</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

#### 3.2.2 æ¨¡ç‰ˆè®¾è®¡æ¨¡å¼åˆ†æ

ä¸ºäº†ä¼˜é›…åœ°å®ç°ä¼˜æƒ è®¡ç®—é€»è¾‘ï¼Œæˆ‘é€‰æ‹©äº†**æ¨¡æ¿è®¾è®¡æ¨¡å¼**ã€‚è¯¥æ¨¡å¼é€šè¿‡æŠ½è±¡ç±»å®šä¹‰ç®—æ³•çš„æ¡†æ¶ï¼Œå°†å…·ä½“å®ç°ç•™ç»™å­ç±»å®Œæˆã€‚é‰´äºä¼˜æƒ åˆ¸ç±»å‹çš„å¤šæ ·æ€§ï¼ˆå¦‚æ»¡å‡ã€æŠ˜æ‰£ã€éšæœºç«‹å‡ç­‰ï¼‰ï¼Œå®ƒä»¬çš„è®¡ç®—æµç¨‹å…·æœ‰å…±æ€§ï¼Œä½†æ¯ä¸ªçš„è®¡ç®—ç»†èŠ‚å„ä¸ç›¸åŒï¼Œæ¨¡æ¿è®¾è®¡æ¨¡å¼ä¸ºå¤„ç†è¿™ä¸€é—®é¢˜æä¾›äº†å®Œç¾è§£å†³æ–¹æ¡ˆã€‚

ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„è®¡ç®—é€»è¾‘ç±»ç»“æ„å›¾ï¼š

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-11-04-134259.png" style="zoom: 50%;" />

åœ¨æ­¤ç»“æ„ä¸­ï¼Œ`RuleTemplate ` é¡¶å±‚æ¥å£å®šä¹‰äº† `calculate` æ–¹æ³•ç”¨äºè®¡ç®—ä¼˜æƒ åˆ¸ï¼š

```java
/**
 * æ¨¡ç‰ˆæ¨¡å¼ï¼šä¼˜æƒ åˆ¸è®¡ç®—è§„åˆ™æ¥å£
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
public interface RuleTemplate {

    /**
     * è®¡ç®—è´­ç‰©è½¦é‡‘é¢
     *
     * @param shoppingCart è´­ç‰©è½¦å¯¹è±¡
     * @return è®¡ç®—åçš„è´­ç‰©è½¦é‡‘é¢
     */
    ShoppingCart calculate(ShoppingCart shoppingCart);
}
```

æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ª `AbstractRuleTemplate` æŠ½è±¡ç±»å°è£…é€šç”¨é€»è¾‘ï¼Œå¹¶ä¸ºä¸åŒç±»å‹çš„ä¼˜æƒ åˆ¸å„æä¾›ä¸€ä¸ªå…·ä½“å­ç±»æ¥å®ç°å…¶ç‹¬æœ‰çš„è®¡ç®—é€»è¾‘ã€‚`AbstractRuleTemplate `ç±»æä¾›äº†ä¸€ä¸ª `calculate` æ–¹æ³•çš„å®ç°æ¡†æ¶ï¼Œå¹¶å®šä¹‰äº†ä¸€ä¸ªå¾…å­ç±»å®ç°çš„ `calculateNewPrice` æŠ½è±¡æ–¹æ³•ã€‚

```java
/**
 * æ¨¡ç‰ˆæŠ½è±¡ç±»ï¼šå®ç°é€šç”¨ä¼˜æƒ å·è®¡ç®—è§„åˆ™ä»¥å¤ç”¨ï¼ŒåŒæ—¶æä¾›æŠ½è±¡æ–¹æ³•ç»™å­ç±»å®ç°å„è‡ªçš„è®¡ç®—è§„åˆ™ï¼ˆè®¾è®¡ç­–ç•¥æ¨¡å¼ï¼‰
 *
 * @author javgo.cn
 * @date 2023/11/3
 */
@Slf4j
public abstract class AbstractRuleTemplate implements RuleTemplate {

    /**
     * è®¡ç®—ä¼˜æƒ åçš„è´­ç‰©è½¦ä»·æ ¼
     *
     * @param order è´­ç‰©è½¦è®¢å•
     * @return è®¡ç®—åçš„è´­ç‰©è½¦è®¢å•
     */
    @Override
    public ShoppingCart calculate(ShoppingCart order) {
        // è®¡ç®—è®¢å•æ€»é‡‘é¢
        long orderTotalAmount = getTotalPrice(order.getProducts());
        // æŒ‰åº—é“ºåˆ†ç»„è®¡ç®—è®¢å•æ€»é‡‘é¢
        Map<Long, Long> orderTotalAmountGroupByShop = getTotalPriceGroupByShop(order.getProducts());

        // è·å–ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
        CouponTemplateInfo templateInfo = order.getCouponInfos().get(0).getTemplateInfo();
        // è·å–ä¼˜æƒ åˆ¸çš„æœ€ä½æ¶ˆè´¹é™åˆ¶
        Long threshold = templateInfo.getTemplateRule().getDiscount().getThreshold();
        // è·å–ä¼˜æƒ åˆ¸çš„ä½¿ç”¨é™é¢
        Long quota = templateInfo.getTemplateRule().getDiscount().getQuota();

        // è·å–ä¼˜æƒ åˆ¸æ‰€å±åº—é“ºID
        Long shopId = templateInfo.getShopId();
        // è®¡ç®—åº—é“ºæ€»é‡‘é¢ï¼ˆå¦‚æœshopIdä¸ºç©ºï¼Œåˆ™ä½¿ç”¨è®¢å•æ€»é‡‘é¢ï¼›å¦åˆ™ä½¿ç”¨æŒ‰åº—é“ºåˆ†ç»„çš„è®¢å•æ€»é‡‘é¢ï¼‰
        Long shopTotalAmount = (shopId == null) ? orderTotalAmount : orderTotalAmountGroupByShop.get(shopId);
        // å¦‚æœåº—é“ºæ€»é‡‘é¢å°äºæœ€ä½æ¶ˆè´¹é™åˆ¶ï¼Œä¸é€‚ç”¨ä¼˜æƒ åˆ¸
        if (shopTotalAmount < threshold) {
            log.warn("è®¢å•æ€»ä»·å°äºä¼˜æƒ å·çš„æœ€ä½æ¶ˆè´¹é™åˆ¶ï¼Œä¸é€‚ç”¨ä¼˜æƒ å·ï¼");
            order.setCost(orderTotalAmount);
            order.setCouponInfos(Collections.emptyList());
            return order;
        }

        // è®¡ç®—æ–°çš„ä»·æ ¼ï¼ˆæ ¹æ®è®¢å•æ€»é‡‘é¢ã€åº—é“ºæ€»é‡‘é¢å’Œä½¿ç”¨é™é¢ï¼‰
        Long newCost = calculateNewPrice(orderTotalAmount, shopTotalAmount, quota);
        // å¦‚æœæ–°çš„ä»·æ ¼å°äºæœ€å°æˆæœ¬ï¼Œè®¾ä¸ºæœ€å°æˆæœ¬ï¼ˆè‡³å°‘ 1 åˆ†é’±ï¼‰
        if (newCost < minCost()) {
            newCost = minCost();
        }

        // æ›´æ–°è®¢å•çš„æˆæœ¬å’Œä¼˜æƒ åˆ¸ä¿¡æ¯
        order.setCost(newCost);
        log.info("ä¼˜æƒ åˆ¸è®¡ç®—æˆåŠŸï¼Œè®¢å•æ€»ä»·ï¼š{}ï¼Œä¼˜æƒ åˆ¸ä¼˜æƒ é‡‘é¢ï¼š{}ï¼Œä¼˜æƒ åè®¢å•æ€»ä»·ï¼š{}", orderTotalAmount, orderTotalAmount - newCost, newCost);
        return order;
    }

    /**
     * è®¡ç®—æ–°çš„ä»·æ ¼ï¼ˆç­–ç•¥æ¨¡å¼ï¼Œç•™ç»™å­ç±»æ ¹æ®ä¸åŒç±»å‹çš„ä¼˜æƒ å·è®¡ç®—è§„åˆ™å®ç°ï¼‰
     *
     * @param orderTotalAmount è®¢å•æ€»é‡‘é¢
     * @param shopTotalAmount  åº—é“ºæ€»é‡‘é¢
     * @param quota            ä½¿ç”¨é™é¢
     * @return è®¡ç®—åçš„æ–°ä»·æ ¼
     */
    protected abstract Long calculateNewPrice(Long orderTotalAmount, Long shopTotalAmount, Long quota);

    /**
     * è®¡ç®—è®¢å•çš„æ€»é‡‘é¢
     *
     * @param products è®¢å•äº§å“åˆ—è¡¨
     * @return è®¢å•çš„æ€»é‡‘é¢
     */
    protected long getTotalPrice(List<Product> products) {
        return products.stream()
                .mapToLong(product -> product.getPrice() * product.getCount())
                .sum();
    }

    /**
     * æŒ‰åº—é“ºåˆ†ç»„è®¡ç®—è®¢å•çš„æ€»é‡‘é¢
     *
     * @param products è®¢å•äº§å“åˆ—è¡¨
     * @return æŒ‰åº—é“ºåˆ†ç»„çš„è®¢å•æ€»é‡‘é¢ map
     */
    protected Map<Long, Long> getTotalPriceGroupByShop(List<Product> products) {
        return products.stream()
                .collect(
                        Collectors.groupingBy(
                                Product::getShopId,
                                Collectors.summingLong(product -> product.getPrice() * product.getCount()))
                );
    }

    /**
     * è·å–æœ€å°æˆæœ¬
     *
     * @return æœ€å°æˆæœ¬
     */
    protected long minCost() {
        return 1L;
    }
}
```

ä¾‹å¦‚ï¼Œæ»¡å‡è§„åˆ™çš„å®ç° `MoneyOffTemplate` ç»§æ‰¿äº† `AbstractRuleTemplate`ï¼Œåªéœ€æä¾› `calculateNewPrice` æ–¹æ³•çš„å…·ä½“å®ç°å³å¯ï¼Œè¿™æ ·çš„è®¾è®¡ç®€æ´ä¸”å‡å°‘äº†ä»£ç é‡å¤ã€‚

```java
/**
 * ä¼˜æƒ å·ç­–ç•¥ï¼šæ»¡å‡
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
@Slf4j
@Component
public class MoneyOffTemplate extends AbstractRuleTemplate implements RuleTemplate {

    /**
     * è®¡ç®—æ–°çš„ä»·æ ¼
     *
     * @param orderTotalAmount è®¢å•æ€»é‡‘é¢
     * @param shopTotalAmount  å•†åº—æ€»é‡‘é¢
     * @param quota            ä¼˜æƒ é¢åº¦(è¿™é‡ŒæŒ‡æ»¡å‡é¢åº¦ï¼‰
     * @return æ–°çš„ä»·æ ¼
     */
    @Override
    protected Long calculateNewPrice(Long orderTotalAmount, Long shopTotalAmount, Long quota) {
        // è®¡ç®—ä¼˜æƒ é¢åº¦ï¼šå–å•†åº—æ€»é‡‘é¢å’Œä¼˜æƒ é¢åº¦çš„æœ€å°å€¼
        Long benefitAmount = shopTotalAmount < quota ? shopTotalAmount : quota;
        // è®¡ç®—æœ€ç»ˆçš„ä»·æ ¼ï¼šè®¢å•æ€»é‡‘é¢å‡å»ä¼˜æƒ é¢åº¦
        return orderTotalAmount - benefitAmount;
    }
}
```

ä¸‹é¢ç»™å‡ºå…¶ä»–ä¼˜æƒ å·è®¡ç®—æ¨¡ç‰ˆï¼š

```java
/**
 * ä¼˜æƒ å·ç­–ç•¥ï¼šæŠ˜æ‰£å·
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public class DiscountTemplate extends AbstractRuleTemplate implements RuleTemplate {

    /**
     * è®¡ç®—æ–°çš„ä»·æ ¼
     *
     * @param orderTotalAmount è®¢å•æ€»é‡‘é¢
     * @param shopTotalAmount  å•†åº—æ€»é‡‘é¢
     * @param quota            ä¼˜æƒ é¢åº¦
     * @return æ–°çš„ä»·æ ¼
     */
    @Override
    protected Long calculateNewPrice(Long orderTotalAmount, Long shopTotalAmount, Long quota) {
        return convertToDecimal(shopTotalAmount, quota);
    }

    /**
     * å°†å•†åº—æ€»é‡‘é¢è½¬æ¢ä¸ºå°æ•°ï¼Œå¹¶æŒ‰æ¯”ä¾‹è½¬æ¢ä¸ºå®é™…é‡‘é¢
     *
     * @param shopTotalAmount å•†åº—æ€»é‡‘é¢
     * @param quota           æ¯”ä¾‹
     * @return è½¬æ¢åçš„å°æ•°é‡‘é¢
     */
    private Long convertToDecimal(Long shopTotalAmount, Long quota) {
        double v = shopTotalAmount * (quota.doubleValue() / 100);
        return (long) v;
    }
}
```

```java
/**
 * ä¼˜æƒ å·ç­–ç•¥ï¼šç©ºç­–ç•¥
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public class DummyTemplate extends AbstractRuleTemplate implements RuleTemplate {

    /**
     * è®¡ç®—æ–°çš„ä»·æ ¼
     *
     * @param orderTotalAmount è®¢å•æ€»é‡‘é¢
     * @param shopTotalAmount  å•†åº—æ€»é‡‘é¢
     * @param quota            ä¼˜æƒ é¢åº¦
     * @return æ–°çš„ä»·æ ¼
     */
    @Override
    protected Long calculateNewPrice(Long orderTotalAmount, Long shopTotalAmount, Long quota) {
        return orderTotalAmount;
    }

    @Override
    public ShoppingCart calculate(ShoppingCart order) {
        order.setCost(super.getTotalPrice(order.getProducts()));
        return order;
    }
}
```

```java
/**
 * ä¼˜æƒ å·ç­–ç•¥ï¼šå¤œé—´å•èº«ç‹—ç¿»å€å·ï¼ˆ22:00 - 02:00ï¼‰
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public class LonelyNightTemplate extends AbstractRuleTemplate implements RuleTemplate {

    /**
     * è®¡ç®—æ–°çš„ä»·æ ¼
     *
     * @param orderTotalAmount è®¢å•æ€»é‡‘é¢
     * @param shopTotalAmount  å•†åº—æ€»é‡‘é¢
     * @param quota            ä¼˜æƒ é¢åº¦
     * @return æ–°çš„ä»·æ ¼
     */
    @Override
    protected Long calculateNewPrice(Long orderTotalAmount, Long shopTotalAmount, Long quota) {
        Calendar calendar = Calendar.getInstance();
        int hourOfDay = calendar.get(Calendar.HOUR_OF_DAY);
        if (hourOfDay >= 22 || hourOfDay < 2) {
            quota *= 2;
        }

        Long benefitAmount = shopTotalAmount < quota ? shopTotalAmount : quota;
        return orderTotalAmount - benefitAmount;
    }
}
```

```java
/**
 * ä¼˜æƒ å·ç­–ç•¥ï¼šéšæœºç«‹å‡å·
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public class RandomReductionTemplate extends AbstractRuleTemplate implements RuleTemplate {

    /**
     * è®¡ç®—æ–°çš„ä»·æ ¼
     *
     * @param orderTotalAmount è®¢å•æ€»é‡‘é¢
     * @param shopTotalAmount  å•†åº—æ€»é‡‘é¢
     * @param quota            ä¼˜æƒ é¢åº¦
     * @return æ–°çš„ä»·æ ¼
     */
    @Override
    protected Long calculateNewPrice(Long orderTotalAmount, Long shopTotalAmount, Long quota) {
        // è®¡ç®—æœ€å¤§çš„ä¼˜æƒ é¢åº¦ï¼šå–å•†åº—æ€»é‡‘é¢å’Œä¼˜æƒ é¢åº¦çš„æœ€å°å€¼
        long maxBenefit = Math.min(shopTotalAmount, quota);
        // è®¡ç®—ä¼˜æƒ é¢åº¦ï¼šéšæœºç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼ŒèŒƒå›´ä¸º 0 ~ maxBenefit-1
        int reductionAmount = new Random().nextInt((int) maxBenefit);
        // è®¡ç®—æ–°çš„ä»·æ ¼ï¼šè®¢å•æ€»é‡‘é¢å‡å»ä¼˜æƒ é¢åº¦
        return orderTotalAmount - reductionAmount;
    }
}
```

åœ¨æœªæ¥ï¼Œå¦‚æœä¸šåŠ¡æ‹“å±•æ–°å¢äº†æ›´å¤šç±»å‹çš„ä¼˜æƒ åˆ¸ï¼Œå½“å‰çš„è®¾è®¡å…è®¸æˆ‘ä»¬é€šè¿‡æ·»åŠ æ–°çš„å­ç±»æˆ–åœ¨å¿…è¦æ—¶åˆ›å»ºæ›´å¤šå±‚æ¬¡çš„æŠ½è±¡ç±»æ¥åº”å¯¹ï¼Œè¿™æ ·åšä¸€æ–¹é¢ä¿æŒäº†ç°æœ‰ä»£ç çš„ç¨³å®šï¼Œå¦ä¸€æ–¹é¢åˆä¿æŒäº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

#### 3.2.3 Service å±‚

æ¥ä¸‹æ¥çš„æ­¥éª¤æ˜¯å®ç° Service å±‚ã€‚Service å±‚ä¸­çš„ `calculateOrderPrice` æ–¹æ³•é€šè¿‡`CouponTemplateFactory`å·¥å‚ç±»æ¥è·å–å…·ä½“çš„è®¡ç®—è§„åˆ™ï¼Œç„¶åè°ƒç”¨ `calculate` æ–¹æ³•æ¥è®¡ç®—è®¢å•çš„ä¼˜æƒ åä»·æ ¼ã€‚å…¶ä¸­ï¼Œ`simulate `æ–¹æ³•æä¾›äº†ä¸€ç§è¯•ç®—æœºåˆ¶ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨å®é™…ä¸‹å•å‰é¢„ä¼°å„ä¼˜æƒ åˆ¸çš„æŠ˜æ‰£é‡‘é¢ï¼Œä»¥ä¾¿é€‰æ‹©æœ€ä¼˜æƒ çš„é€‰é¡¹ã€‚

`CouponTemplateFactory `çš„è®¾è®¡æ˜¯æ ¹æ®è®¢å•ä¸­åŒ…å«çš„ä¼˜æƒ åˆ¸ä¿¡æ¯æ¥è¿”å›ç›¸åº”çš„ä¼˜æƒ åˆ¸æ¨¡æ¿å®ä¾‹ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥è®¡ç®—ã€‚

```java
/**
 * å·¥å‚æ¨¡å¼ï¼šç”¨äºåˆ›å»ºä¸åŒç±»å‹çš„ä¼˜æƒ åˆ¸æ¨¡æ¿
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
@Slf4j
@Component
public class CouponTemplateFactory {

    @Resource
    private MoneyOffTemplate moneyOffTemplate;

    @Resource
    private DiscountTemplate discountTemplate;

    @Resource
    private RandomReductionTemplate randomReductionTemplate;

    @Resource
    private LonelyNightTemplate lonelyNightTemplate;

    @Resource
    DummyTemplate dummyTemplate;

    public RuleTemplate getTemplate(ShoppingCart order) {
        if (CollectionUtils.isEmpty(order.getCouponInfos())) {
            return dummyTemplate;
        }

        CouponTemplateInfo templateInfo = order.getCouponInfos().get(0).getTemplateInfo();
        CouponType couponType = CouponType.convert(templateInfo.getType());

        switch (couponType) {
            case MONEY_OFF:
                return moneyOffTemplate;

            case DISCOUNT:
                return discountTemplate;

            case RANDOM_DISCOUNT:
                return randomReductionTemplate;

            case LONELY_NIGHT_MONEY_OFF:
                return lonelyNightTemplate;

            default:
                return dummyTemplate;
        }
    }
}
```

å®šä¹‰ `CouponCalculationService` æ¥å£ä»¥åŠå…¶å…·ä½“å®ç°ï¼Œè¿™æ ·çš„è®¾è®¡éµå¾ªäº†**å¼€é—­åŸåˆ™**ï¼Œå³å¯¹ä¿®æ”¹å°é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

`CouponCalculationService` æ¥å£ç”¨äºæä¾›ä¼˜æƒ è®¡ç®—çš„ API å®šä¹‰ï¼š

```java
/**
 * ä¼˜æƒ å·è®¡ç®—æœåŠ¡
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public interface CouponCalculationService {

    /**
     * è®¡ç®—è®¢å•ä»·æ ¼
     *
     * @param cart è´­ç‰©è½¦
     * @return è®¢å•ä»·æ ¼
     */
    ShoppingCart calculateOrderPrice(ShoppingCart cart);

    /**
     * ä¼˜æƒ è¯•ç®—
     *
     * @param order è®¢å•
     * @return å“åº”
     */
    SimulationResponse simulateOrder(SimulationOrder order);
}
```

å¯¹åº”å®ç°å¦‚ä¸‹ï¼š

```java
/**
 * ä¼˜æƒ å·è®¡ç®—æœåŠ¡å®ç°
 * @author javgo.cn
 * @date 2023/11/4
 */
@Slf4j
@Service
public class CouponCalculationServiceImpl implements CouponCalculationService {

    @Resource
    private CouponTemplateFactory couponTemplateFactory;

    /**
     * æ­£å¸¸è®¡ç®—
     * @param cart è´­ç‰©è½¦
     * @return è®¡ç®—åçš„è´­ç‰©è½¦
     */
    @Override
    public ShoppingCart calculateOrderPrice(ShoppingCart cart) {
        log.info("calculateOrderPrice: {}", JSON.toJSONString(cart));
        RuleTemplate ruleTemplate = couponTemplateFactory.getTemplate(cart);
        return ruleTemplate.calculate(cart);
    }

    /**
     * æ¨¡æ‹Ÿè®¡ç®—
     * @param order è®¢å•
     * @return æ¨¡æ‹Ÿè®¡ç®—ç»“æœ
     */
    @Override
    public SimulationResponse simulateOrder(SimulationOrder order) {
        // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå“åº”å¯¹è±¡
        SimulationResponse response = new SimulationResponse();
        // åˆå§‹åŒ–æœ€å°è®¢å•ä»·æ ¼ä¸º Long æœ€å¤§å€¼
        Long minOrderPrice = Long.MAX_VALUE;

        // éå†ä¼ å…¥çš„ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ—è¡¨
        for (CouponInfo couponInfo : order.getCouponInfos()) {
            // åˆ›å»ºä¸€ä¸ªè´­ç‰©è½¦å¯¹è±¡
            ShoppingCart shoppingCart = new ShoppingCart();
            // è®¾ç½®è´­ç‰©è½¦çš„äº§å“ä¸ºä¼ å…¥è®¢å•çš„äº§å“
            shoppingCart.setProducts(order.getProducts());
            // å°†ä¼˜æƒ åˆ¸ä¿¡æ¯æ·»åŠ åˆ°è´­ç‰©è½¦ä¸­
            shoppingCart.setCouponInfos(Lists.newArrayList(couponInfo));

            // æ ¹æ®è´­ç‰©è½¦æ¨¡æ¿è®¡ç®—åçš„è´­ç‰©è½¦å¯¹è±¡ï¼ˆå†³å®šä½¿ç”¨å“ªä¸ªä¼˜æƒ åˆ¸ï¼Œå¯¹ä¸Šå±‚ä¸šåŠ¡é€æ˜ï¼‰
            shoppingCart = couponTemplateFactory.getTemplate(shoppingCart).calculate(shoppingCart);

            // è·å–å½“å‰ä¼˜æƒ åˆ¸ä¿¡æ¯çš„ID
            Long couponInfoId = couponInfo.getId();
            // è·å–è®¡ç®—åçš„è´­ç‰©è½¦ä»·æ ¼
            long orderPrice = shoppingCart.getCost();
            // å°†ä¼˜æƒ åˆ¸IDå’Œå¯¹åº”çš„è®¢å•ä»·æ ¼æ·»åŠ åˆ°æ¨¡æ‹Ÿå“åº”çš„ä¼˜æƒ åˆ¸åˆ°è®¢å•ä»·æ ¼æ˜ å°„ä¸­
            response.getCouponToOrderPrice().put(couponInfoId, orderPrice);

            // å¦‚æœæœ€å°è®¢å•ä»·æ ¼å¤§äºå½“å‰è®¢å•ä»·æ ¼
            if (minOrderPrice > orderPrice){
                // è®¾ç½®æœ€ä½³ä¼˜æƒ åˆ¸IDä¸ºå½“å‰ä¼˜æƒ åˆ¸ä¿¡æ¯çš„ID
                response.setBestCouponId(couponInfoId);
                // æ›´æ–°æœ€å°è®¢å•ä»·æ ¼
                minOrderPrice = orderPrice;
            }
        }
        return response;
    }
}
```

#### 3.2.4 Controller å±‚

å®Œæˆ Service å±‚çš„æ„å»ºåï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡åˆ›å»ºä¸€ä¸ª `CouponCalculationController` ç±»æ¥å‘å¤–ç•Œæä¾›æ¥å£ã€‚è¿™ä¸ªæ§åˆ¶å™¨å°†æš´éœ²è‡³å°‘ä¸¤ä¸ª POST æ¥å£ï¼Œä¸€ä¸ªç”¨äºå®Œæˆè®¢å•çš„ä¼˜æƒ è®¡ç®—ï¼Œå¦ä¸€ä¸ªç”¨äºè¿›è¡Œä¼˜æƒ åˆ¸çš„ä»·æ ¼è¯•ç®—ã€‚è¿™äº›æ¥å£çš„å®ç°å°†ä¾èµ–äºä¹‹å‰æ„å»ºçš„ Service å±‚é€»è¾‘ã€‚

è¿™é‡Œæ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•å®šä¹‰è¿™äº› REST æ¥å£ï¼š

```java
/**
 * ä¼˜æƒ å·è®¡ç®— Controller
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
@Slf4j
@RestController
@RequestMapping("calculator")
public class CouponCalculationController {

    @Resource
    private CouponCalculationService calculationService;

    @PostMapping("/checkout")
    public ShoppingCart calculateOrderPrice(@RequestBody ShoppingCart settlement) {
        log.info("do calculation: {}", JSON.toJSONString(settlement));
        return calculationService.calculateOrderPrice(settlement);
    }

    @PostMapping("/simulate")
    public SimulationResponse simulate(@RequestBody SimulationOrder simulator) {
        log.info("do simulation: {}", JSON.toJSONString(simulator));
        return calculationService.simulateOrder(simulator);
    }
}
```

åœ¨è¿™ä¸ªæ§åˆ¶å™¨ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥äº† `CouponCalculationService` æ¥è°ƒç”¨è®¡ç®—å’Œè¯•ç®—çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶è¿”å›ç»“æœã€‚

#### 3.2.5 å¯åŠ¨ç±»

æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º `Application` ç±»æ¥å¯åŠ¨ Spring Boot åº”ç”¨ã€‚è¿™ä¸ªç±»é€šå¸¸å¾ˆç®€å•ï¼ŒåŒ…å«ä¸€ä¸ª main æ–¹æ³•å’Œ `@SpringBootApplication` æ³¨è§£ï¼š

```java
@SpringBootApplication
@ComponentScan(basePackages = {"cn.javgo"})
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(com.apple.eawt.Application.class, args);
    }
}
```

#### 3.2.6 é…ç½®æ–‡ä»¶

æœ€åï¼Œæˆ‘ä»¬éœ€è¦é…ç½® `application.yml` æ–‡ä»¶ï¼Œä¸ºæˆ‘ä»¬çš„æœåŠ¡æä¾›å¿…è¦çš„é…ç½®ï¼Œå¦‚ç«¯å£å·ã€æ•°æ®åº“è¿æ¥çš„é…ç½®ç­‰ã€‚

```properties
# æœåŠ¡ç«¯å£
server.port=20002
# é”™è¯¯ä¿¡æ¯æ˜¯å¦åŒ…å«å †æ ˆä¿¡æ¯
server.error.include-message=always

# åº”ç”¨åç§°
spring.application.name=coupon-calculation-serv

# æ—¥å¿—çº§åˆ«
logging.level.cn.javgo.coupon=debug

# å¼€å¯ Spring Boot Actuator çš„æ‰€æœ‰ç«¯ç‚¹
management.endpoints.web.exposure.include=*
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† `coupon-calculation-impl` æ¨¡å—çš„æ„å»ºã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•æ¥éªŒè¯æœåŠ¡çš„æ­£ç¡®æ€§ï¼Œå¹¶ä½¿ç”¨ Spring Boot çš„ Actuator æ¥ç›‘æ§æœåŠ¡çš„å¥åº·çŠ¶å†µå’Œæ€§èƒ½ã€‚

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†ç»§ç»­å‰è¿›ï¼Œæ„å»º `coupon-customer-serv` æ¨¡å—ï¼Œè¿™æ˜¯ä¼˜æƒ åˆ¸é¡¹ç›®çš„æœ€åä¸€ä¸ªæœåŠ¡ï¼Œä¸“é—¨ç”¨äºä¸ç”¨æˆ·äº¤äº’ï¼Œæ¯”å¦‚é¢†å–ä¼˜æƒ åˆ¸ã€æŸ¥è¯¢ä¼˜æƒ åˆ¸ç­‰ã€‚

## 4.æ­å»ºç”¨æˆ·æœåŠ¡

åœ¨ç”µå­å•†åŠ¡ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ä¼˜æƒ åˆ¸æœåŠ¡ï¼ˆä»¥ä¸‹ç®€ç§° â€œç”¨æˆ·æœåŠ¡â€ï¼‰æ˜¯è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚æœ¬æ¨¡å—çš„è®¾è®¡é‡ç‚¹åœ¨äºå®ç°ç”¨æˆ·ä¸ä¼˜æƒ åˆ¸äº¤äº’çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸ã€æŸ¥è¯¢æŒæœ‰ä¼˜æƒ åˆ¸ä»¥åŠåœ¨è®¢å•ç»“ç®—æ—¶ä½¿ç”¨ä¼˜æƒ åˆ¸ã€‚ç±»ä¼¼åœ°ï¼Œè¯¥æ¨¡å—çš„æ¶æ„è®¾è®¡å‚ç…§äº†ä¼˜æƒ åˆ¸æ¨¡æ¿æœåŠ¡ï¼Œä¹Ÿåˆ†ä¸º API å±‚ã€DAO å±‚å’Œä¸šåŠ¡é€»è¾‘å±‚ã€‚

ä¸ºäº†ä¿æŒæ–‡ç« çš„èšç„¦ï¼Œæˆ‘ä»¬å°†ä¸ä¼šæ·±å…¥ â€œç”¨æˆ·æ³¨å†Œâ€ ç­‰åŠŸèƒ½ï¼Œè€Œæ˜¯å‡è®¾ä½ å·²ç»ç†Ÿæ‚‰ç”¨æˆ·èº«ä»½éªŒè¯çš„æµç¨‹ï¼Œé€šè¿‡ `userId` æ¥æ ‡è¯†ä¸€ä¸ªç»è¿‡è®¤è¯çš„ç”¨æˆ·èº«ä»½ã€‚

### 4.1 æ­å»º coupon-customer-api æ¨¡å—

#### 4.1.1 ä¾èµ–é…ç½®

åœ¨ç”¨æˆ·æœåŠ¡çš„ API å±‚æ„å»ºä¸­ï¼Œé¦–å…ˆè¦ç¡®ä¿ç”¨æˆ·æœåŠ¡èƒ½å¤Ÿä¸ç³»ç»Ÿä¸­çš„å…¶ä»–æœåŠ¡è¿›è¡Œäº¤äº’ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·æœåŠ¡çš„é¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆPOMï¼‰æ–‡ä»¶ä¸­æ·»åŠ ä¼˜æƒ åˆ¸æ¨¡æ¿æœåŠ¡ï¼ˆcoupon-template-apiï¼‰å’Œä¼˜æƒ åˆ¸è®¡ç®—æœåŠ¡ï¼ˆcoupon-calculation-apiï¼‰çš„ä¾èµ–ã€‚è¿™ä¸€æ­¥ç¡®ä¿ç”¨æˆ·æœåŠ¡èƒ½å¤Ÿä½¿ç”¨è¿™ä¸¤ä¸ªæœåŠ¡æä¾›çš„è¯·æ±‚å’Œå“åº”å¯¹è±¡ã€‚

```xml
<dependencies>
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-template-api</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-calculation-api</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>com.google.guava</groupId>
        <artifactId>guava</artifactId>
    </dependency>
</dependencies>
```

#### 4.1.2 å°è£… DTO

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ `RequestCoupon` ç±»ï¼Œç”¨äºå°è£…ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸æ—¶æ‰€éœ€æä¾›çš„ä¿¡æ¯ï¼Œè¿™é€šå¸¸åŒ…æ‹¬ç”¨æˆ· ID å’Œä¼˜æƒ åˆ¸æ¨¡æ¿ IDã€‚é€šè¿‡è¿™ä¸ªç±»ï¼Œç”¨æˆ·å¯ä»¥è¯·æ±‚ç³»ç»Ÿä¸ºå…¶ç”ŸæˆåŸºäºæŒ‡å®šæ¨¡æ¿çš„ä¼˜æƒ åˆ¸ã€‚

```java
/**
 * ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸è¯·æ±‚
 * @author javgo.cn
 * @date 2023/11/4
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class RequestCoupon {

    @NotNull
    private Long userId;

    @NotNull
    private Long couponTemplateId;
}
```

æ­¤å¤–ï¼Œ`SearchCoupon` ç±»è¢«å®šä¹‰ç”¨äºå°è£…æŸ¥è¯¢ä¼˜æƒ åˆ¸è¯·æ±‚æ—¶çš„å‚æ•°ã€‚å®ƒå…è®¸ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œä¼˜æƒ åˆ¸æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼Œå¯ä»¥æ ¹æ®ä¼˜æƒ åˆ¸çš„çŠ¶æ€è¿›è¡Œç­›é€‰ã€‚

```java
/**
 * ä¼˜æƒ å·æŸ¥è¯¢
 * @author javgo.cn
 * @date 2023/11/4
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class SearchCoupon {

  @NotNull
  private Long userId;

  private Long shopId;

  private Integer status;
}
```

```java
/**
 * ä¼˜æƒ å·çŠ¶æ€æšä¸¾
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
@Getter
@AllArgsConstructor
public enum CouponStatus {

    AVAILABLE("æœªä½¿ç”¨", 1),
    USED("å·²ä½¿ç”¨", 2),
    INACTIVE("å·²æ³¨é”€", 3);

    private String desc;
    private Integer code;

    public static CouponStatus convert(Integer code) {
        if (code == null) {
            return null;
        }
        return Stream.of(CouponStatus.values())
                .filter(bean -> bean.code.equals(code))
                .findAny()
                .orElse(null);
    }
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ­å»ºå¥½äº†ç”¨æˆ·æœåŠ¡çš„ API å­æ¨¡å—çš„åŸºæœ¬ç»“æ„ã€‚ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¼šè¿›å…¥åˆ°æ•°æ®è®¿é—®å±‚ï¼ˆDAOï¼‰ï¼Œåœ¨è¿™ä¸€å±‚æˆ‘ä»¬å°†å®ç°ä¼˜æƒ åˆ¸æ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼ŒåŒ…æ‹¬ä¼˜æƒ åˆ¸çš„å­˜å‚¨ã€æ£€ç´¢ã€æ›´æ–°å’Œåˆ é™¤ã€‚

### 4.2 æ­å»º coupon-customer-dao æ¨¡å—

#### 4.2.1 æ•°æ®åº“æ˜ å°„å¯¹è±¡

åœ¨ç”¨æˆ·ä¼˜æƒ åˆ¸æœåŠ¡çš„æ•°æ®è®¿é—®å±‚ï¼ˆDAO å±‚ï¼‰çš„æ­å»ºä¸­ï¼Œæ ¸å¿ƒä»»åŠ¡æ˜¯è®¾è®¡å’Œå®ç°ä¸æ•°æ®åº“äº¤äº’çš„å®ä½“å’Œæ¥å£ã€‚åœ¨è¿™ä¸€ç¯èŠ‚ï¼Œæˆ‘å®šä¹‰äº† `Coupon` å®ä½“ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°æ®åº“æ˜ å°„å¯¹è±¡ï¼Œä¸“é—¨ç”¨æ¥è¡¨ç¤ºå’Œå­˜å‚¨ç”¨æˆ·æ‰€é¢†å–çš„ä¼˜æƒ åˆ¸ä¿¡æ¯ã€‚

```java
/**
 * ä¼˜æƒ å·
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
@EntityListeners(AuditingEntityListener.class)
@Table(name = "coupon")
public class Coupon {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id", nullable = false)
    private Long id;

    @Column(name = "template_id", nullable = false)
    private Long templateId;

    @Column(name = "user_id", nullable = false)
    private Long userId;

    @Column(name = "shop_id")
    private Long shopId;

    @Column(name = "status", nullable = false)
    @Convert(converter = CouponStatusConverter.class)
    private CouponStatus status;

    @Transient // æ ‡è®°è¯¥å­—æ®µä¸å‚ä¸æ•°æ®åº“æ˜ å°„
    private CouponTemplateInfo templateInfo;

    @CreatedDate
    @Column(name = "created_time", nullable = false)
    private Date createTime;
}
```

é’ˆå¯¹ `Coupon` å®ä½“ç±»ï¼Œæˆ‘è¿˜ç¼–å†™äº†ç›¸åº”çš„è½¬æ¢å™¨ç±»ï¼Œå…¶ä½œç”¨æ˜¯åœ¨ä¸åŒæ•°æ®ç±»å‹çš„å®ä½“å±æ€§å’Œè¡¨å­—æ®µè¿›è¡Œæ˜ å°„æ—¶ï¼Œèƒ½å¤Ÿå°†æ•°æ®åº“å®ä½“å±æ€§å’Œå¯¹åº”å­—æ®µè¿›è¡Œäº’ç›¸è½¬æ¢ï¼Œä¿è¯æ•°æ®å¤„ç†çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§ã€‚

```java
/**
 * ä¼˜æƒ å·çŠ¶æ€è½¬æ¢å™¨
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public class CouponStatusConverter implements AttributeConverter<CouponStatus, Integer> {
    @Override
    public Integer convertToDatabaseColumn(CouponStatus attribute) {
        return attribute.getCode();
    }

    @Override
    public CouponStatus convertToEntityAttribute(Integer dbData) {
        return CouponStatus.convert(dbData);
    }
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨äº† Lombok åº“æ¥ç®€åŒ–å®ä½“ç±»çš„ç¼–å†™ï¼Œé€šè¿‡æ³¨è§£è‡ªåŠ¨ç”Ÿæˆå¸¸ç”¨çš„æ–¹æ³•å¦‚ `getter`ã€`setter`ã€`toString` ç­‰ï¼Œå¤§å¤§æå‡äº†å¼€å‘æ•ˆç‡ã€‚å¯¹ Lombok æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è®¿é—®å…¶[å®˜æ–¹ç½‘ç«™](https://projectlombok.org/)ä»¥è·å¾—æ›´å¤šä¿¡æ¯ã€‚

<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-18-061309.png" style="zoom: 33%;" />

æ­¤å¤–ï¼Œæˆ‘æƒ³åˆ†äº«å…³äº â€œ**æ•°æ®å†—ä½™**â€ çš„è®¾è®¡è€ƒé‡ã€‚ä¾‹å¦‚ï¼Œåœ¨ `Coupon` å®ä½“ä¸­ï¼Œæˆ‘ä»¬å†³å®šå¼•å…¥ä¸€ä¸ªå†—ä½™å­—æ®µâ€”â€”Shop IDã€‚è™½ç„¶è¯¥æ•°æ®å¯ä»¥é€šè¿‡å…³è”çš„ `CouponTemplate` å®ä½“è·å–ï¼Œä½†å°†å…¶ç›´æ¥å­˜å‚¨åœ¨ `Coupon` å®ä½“ä¸­å¯ä»¥æå¤§æå‡æ•°æ®æŸ¥è¯¢æ•ˆç‡ï¼Œè¿™ç§è®¾è®¡åœ¨é¢å‘å¤§è§„æ¨¡å¹¶å‘çš„ç³»ç»Ÿæ—¶å°¤ä¸ºå¸¸è§ã€‚å®ƒä½“ç°äº† â€œ**ä»¥ç©ºé—´æ¢æ—¶é—´**â€ çš„ç­–ç•¥ï¼Œå³é€šè¿‡å¢åŠ å­˜å‚¨æ¶ˆè€—æ¥æ¢å–æ›´å¿«çš„å“åº”é€Ÿåº¦ã€‚

#### 4.2.2 æŒä¹…å±‚

æ¥ä¸‹æ¥ï¼Œåˆ›å»ºäº† `CouponDAO` æ¥å£ï¼Œè¿™æ˜¯ä¸€ä¸ªéµå¾ª Spring Data JPA è§„èŒƒçš„æ•°æ®è®¿é—®æ¥å£ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†å¿…è¦çš„æ•°æ®æ“ä½œæ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç”¨äºç»Ÿè®¡ä¼˜æƒ åˆ¸æ•°é‡çš„æ–¹æ³•ã€‚è€ŒåŸºäº `JpaRepository` æä¾›çš„æ ‡å‡† CRUD æ“ä½œåˆ™ä¸éœ€è¦é¢å¤–å®šä¹‰ï¼Œè¿™å±•ç¤ºäº† Spring Data JPA æ¡†æ¶çš„ä¾¿æ·æ€§å’Œé«˜æ•ˆæ€§ã€‚

```java
/**
 * ä¼˜æƒ å· DAO
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public interface CouponDao extends JpaRepository<Coupon, Long> {

    /**
     * æ ¹æ®ç”¨æˆ·IDå’Œæ¨¡æ¿IDç»Ÿè®¡æ•°é‡
     *
     * @param userId     ç”¨æˆ·ID
     * @param templateId æ¨¡æ¿ID
     * @return ç»Ÿè®¡æ•°é‡
     */
    long countByUserIdAndTemplateId(Long userId, Long templateId);
}
```

è‡³æ­¤ï¼Œç”¨æˆ·ä¼˜æƒ åˆ¸æœåŠ¡çš„æ•°æ®è®¿é—®å±‚å·²ç»æ­å»ºå®Œæˆã€‚æˆ‘ä»¬å°†ç»§ç»­å‰è¿›ï¼Œä¸‹ä¸€æ­¥æ˜¯è¿›å…¥å®ç°å±‚ï¼ˆimpl å±‚ï¼‰ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬å°†å…·ä½“å®ç°ä¸šåŠ¡é€»è¾‘ã€‚

### 4.3 æ­å»º coupon-customer-impl æ¨¡å—

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦è¿°ç”¨æˆ·ä¼˜æƒ åˆ¸æœåŠ¡çš„ä¸šåŠ¡é€»è¾‘å±‚â€”â€”`coupon-customer-impl`æ¨¡å—çš„æ„å»ºã€‚

#### 4.3.1 ä¾èµ–é…ç½®

åœ¨å¾®æœåŠ¡çš„å®Œå…¨å®è·µä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå°†æ¨¡æ¿æœåŠ¡ï¼ˆtemplateï¼‰å’Œè®¡ç®—æœåŠ¡ï¼ˆcalculationï¼‰çš„åŠŸèƒ½ä¸´æ—¶é›†æˆåˆ°ç”¨æˆ·æœåŠ¡ï¼ˆcustomerï¼‰ä¸­ï¼Œå½¢æˆä¸€ä¸ªé›†æˆçš„å•ä½“åº”ç”¨ã€‚è¿™ä¸ªè¿‡æ¸¡æ€§çš„å•ä½“ç»“æ„ä¸ºæœªæ¥æ‹†åˆ†æˆç‹¬ç«‹å¾®æœåŠ¡æ‰“ä¸‹äº†åŸºç¡€ã€‚

åœ¨å¼€å§‹å®ç°ä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œéœ€è¦åœ¨ `coupon-customer-impl` çš„é…ç½®ä¸­åŠ å…¥æ¨¡æ¿å’Œè®¡ç®—æœåŠ¡çš„å®ç°å±‚ä¾èµ–é¡¹ã€‚è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒç¡®ä¿äº†ç”¨æˆ·æœåŠ¡ä¸ä»…èƒ½å¤Ÿè°ƒç”¨å…¶ä»–æœåŠ¡çš„ APIï¼Œè¿˜èƒ½å¤Ÿåˆ©ç”¨å®ƒä»¬çš„å…·ä½“å®ç°æ¥å®Œæˆå¤æ‚çš„ä¸šåŠ¡æ“ä½œã€‚

```xml
<dependencies>
    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-customer-dao</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-calculation-impl</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>${project.groupId}</groupId>
        <artifactId>coupon-template-impl</artifactId>
        <version>${project.version}</version>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

#### 4.3.2 Service å±‚

å®Œæˆä¾èµ–é…ç½®ä¹‹åï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡æ¥å£ `CouponCustomerService`ï¼Œå®ƒè§„å®šäº†é¢†å–ä¼˜æƒ åˆ¸ã€æŸ¥è¯¢ä¼˜æƒ åˆ¸ã€æ ¸é”€ä¼˜æƒ åˆ¸ä»¥åŠæ‰§è¡Œä¼˜æƒ åˆ¸è¯•ç®—ç­‰å…³é”®ä¸šåŠ¡åŠŸèƒ½çš„æ–¹æ³•ã€‚

```java
/**
 * ç”¨æˆ·ä¼˜æƒ å·æœåŠ¡
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public interface CouponCustomerService {

    /**
     * è·å–ä¼˜æƒ åˆ¸
     *
     * @param request ä¼˜æƒ åˆ¸è¯·æ±‚å¯¹è±¡
     * @return ä¼˜æƒ åˆ¸å¯¹è±¡
     */
    Coupon requestCoupon(RequestCoupon request);

    /**
     * æ ¸é”€ä¼˜æƒ å·ï¼ˆå³ä¸‹å•ï¼‰
     *
     * @param order è´­ç‰©è½¦å¯¹è±¡
     */
    ShoppingCart placeOrder(ShoppingCart order);

    /**
     * æ¨¡æ‹Ÿè®¢å•è¯•ç®—
     *
     * @param order æ¨¡æ‹Ÿè®¢å•å¯¹è±¡
     * @return æ¨¡æ‹Ÿå“åº”å¯¹è±¡
     */
    SimulationResponse simulateOrderPrice(SimulationOrder order);

    /**
     * åˆ é™¤ä¼˜æƒ åˆ¸
     *
     * @param userId   ç”¨æˆ·ID
     * @param couponId ä¼˜æƒ åˆ¸ID
     */
    void deleteCoupon(Long userId, Long couponId);

    /**
     * æŸ¥æ‰¾ä¼˜æƒ åˆ¸
     *
     * @param request æŸ¥æ‰¾ä¼˜æƒ åˆ¸è¯·æ±‚å¯¹è±¡
     * @return ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ—è¡¨
     */
    List<CouponInfo> findCoupon(SearchCoupon request);
}
```

ç„¶åï¼Œé‡ç‚¹å…³æ³¨ `placeOrder` æ–¹æ³•çš„å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¤„ç†ç”¨æˆ·ä¸‹å•åŠä¼˜æƒ åˆ¸æ ¸é”€æµç¨‹çš„å…³é”®ã€‚åœ¨å®ç°è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œ`Coupon` å¯¹è±¡çš„æ„é€ è¿‡ç¨‹é‡‡ç”¨äº†æ„å»ºè€…æ¨¡å¼ï¼Œè¿™ä¸€æ¨¡å¼é€šè¿‡ Lombok çš„ `@Builder` æ³¨è§£å¾—ä»¥ç®€åŒ–å®ç°ï¼Œä½¿å¾—å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹æ—¢ç›´è§‚åˆæ˜“äºç®¡ç†ï¼Œæå‡äº†ä»£ç çš„æ•´æ´åº¦å’Œå¯ç»´æŠ¤æ€§ã€‚

```java
@Transactional
@Override
public ShoppingCart placeOrder(ShoppingCart order) {
    // å¦‚æœè®¢å•å•†å“ä¸ºç©º
    if (CollectionUtils.isEmpty(order.getProducts())) {
        log.error("è®¢å•å•†å“ä¸ºç©º");
        throw new IllegalArgumentException("è®¢å•å•†å“ä¸ºç©º");
    }

    Coupon coupon = null;
    // å¦‚æœè®¢å•ä¸­å«æœ‰ä¼˜æƒ åˆ¸ID
    if (order.getCouponId() != null) {
        // åˆ›å»ºä¼˜æƒ åˆ¸æŸ¥è¯¢ç¤ºä¾‹
        Coupon example = Coupon.builder()
                .userId(order.getUserId())
                .id(order.getCouponId())
                .status(CouponStatus.AVAILABLE)
                .build();

        // æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ä¼˜æƒ åˆ¸
        coupon = couponDao.findAll(Example.of(example)).stream()
                .findFirst()
                .orElseThrow(() -> new RuntimeException("ä¼˜æƒ åˆ¸ä¸å­˜åœ¨"));

        // å°†ä¼˜æƒ åˆ¸è½¬æ¢ä¸ºä¼˜æƒ åˆ¸ä¿¡æ¯å¯¹è±¡
        CouponInfo couponInfo = CouponConverter.convertToCoupon(coupon);
        // åŠ è½½ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
        couponInfo.setTemplateInfo(templateService.loadCouponTemplate(coupon.getTemplateId()));
        // å°†ä¼˜æƒ åˆ¸ä¿¡æ¯æ·»åŠ åˆ°è®¢å•ä¸­
        order.setCouponInfos(Lists.newArrayList(couponInfo));
    }

    // è®¡ç®—è®¢å•ä»·æ ¼
    ShoppingCart checkoutInfo = calculationService.calculateOrderPrice(order);

    // å¦‚æœå«æœ‰ä¼˜æƒ åˆ¸
    if (coupon != null) {
        // å¦‚æœè®¢å•ä¸­æ²¡æœ‰ä¼˜æƒ åˆ¸ä¿¡æ¯
        if (CollectionUtils.isEmpty(checkoutInfo.getCouponInfos())) {
            log.error("æ²¡æœ‰ä¼˜æƒ åˆ¸ä¿¡æ¯");
            throw new IllegalArgumentException("æ²¡æœ‰ä¼˜æƒ åˆ¸ä¿¡æ¯");
        }

        log.info("æ›´æ–°ä¼˜æƒ åˆ¸çŠ¶æ€");
        // æ›´æ–°ä¼˜æƒ åˆ¸çŠ¶æ€ä¸ºå·²ä½¿ç”¨
        coupon.setStatus(CouponStatus.USED);
        // ä¿å­˜ä¼˜æƒ åˆ¸ä¿¡æ¯
        couponDao.save(coupon);
    }
    // è¿”å›ç»“è´¦ä¿¡æ¯å¯¹è±¡
    return checkoutInfo;
}
```

å®Œæ•´å®ç°ç±»å¦‚ä¸‹ï¼š

```java
/**
 * ç”¨æˆ·ä¼˜æƒ åˆ¸ä¸šåŠ¡é€»è¾‘å®ç°ç±»
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
@Slf4j
@Service
public class CouponCustomerServiceImpl implements CouponCustomerService {

    @Resource
    private CouponDao couponDao;

    @Resource
    private CouponTemplateService templateService;

    @Resource
    private CouponCalculationService calculationService;

    @Override
    public Coupon requestCoupon(RequestCoupon request) {
        // åŠ è½½ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
        CouponTemplateInfo templateInfo = templateService.loadCouponTemplate(request.getCouponTemplateId());
        // å¦‚æœæ¨¡æ¿ä¿¡æ¯ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
        if (templateInfo == null) {
            log.error("ä¼˜æƒ åˆ¸æ¨¡æ¿ä¸å­˜åœ¨");
            throw new IllegalArgumentException("ä¼˜æƒ åˆ¸æ¨¡æ¿ä¸å­˜åœ¨");
        }

        // è·å–å½“å‰æ—¶é—´
        long now = Calendar.getInstance().getTimeInMillis();
        // è·å–æ¨¡æ¿è§„åˆ™çš„æˆªæ­¢æ—¶é—´
        Long expTime = templateInfo.getTemplateRule().getDeadline();
        // å¦‚æœæˆªæ­¢æ—¶é—´ä¸ä¸ºç©ºä¸”å½“å‰æ—¶é—´è¶…è¿‡æˆªæ­¢æ—¶é—´ï¼Œæˆ–è€…å¯ç”¨æ€§ä¸ºfalseï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
        if (expTime != null && now > expTime || BooleanUtils.isFalse(templateInfo.getAvailable())) {
            log.error("ä¼˜æƒ åˆ¸æ¨¡æ¿ä¸å¯ç”¨");
            throw new IllegalArgumentException("ä¼˜æƒ åˆ¸æ¨¡æ¿ä¸å¯ç”¨");
        }

        // ç»Ÿè®¡ç”¨æˆ·ä½¿ç”¨è¯¥æ¨¡æ¿çš„ä¼˜æƒ åˆ¸æ•°é‡
        long count = couponDao.countByUserIdAndTemplateId(request.getUserId(), request.getCouponTemplateId());
        // å¦‚æœæ•°é‡è¾¾åˆ°é™åˆ¶ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
        if (count >= templateInfo.getTemplateRule().getLimitation()) {
            log.error("ä¼˜æƒ åˆ¸æ¨¡æ¿å·²è¾¾ä¸Šé™");
            throw new IllegalArgumentException("ä¼˜æƒ åˆ¸æ¨¡æ¿å·²è¾¾ä¸Šé™");
        }

        // åˆ›å»ºä¼˜æƒ åˆ¸å¯¹è±¡
        Coupon coupon = Coupon.builder()
                .templateId(request.getCouponTemplateId())
                .userId(request.getUserId())
                .shopId(templateInfo.getShopId())
                .status(CouponStatus.AVAILABLE)
                .build();

        // ä¿å­˜ä¼˜æƒ åˆ¸åˆ°æ•°æ®åº“
        couponDao.save(coupon);
        // è¿”å›ç”Ÿæˆçš„ä¼˜æƒ åˆ¸å¯¹è±¡
        return coupon;
    }

    @Transactional
    @Override
    public ShoppingCart placeOrder(ShoppingCart order) {
        // å¦‚æœè®¢å•å•†å“ä¸ºç©º
        if (CollectionUtils.isEmpty(order.getProducts())) {
            log.error("è®¢å•å•†å“ä¸ºç©º");
            throw new IllegalArgumentException("è®¢å•å•†å“ä¸ºç©º");
        }

        Coupon coupon = null;
        // å¦‚æœè®¢å•ä¸­å«æœ‰ä¼˜æƒ åˆ¸ID
        if (order.getCouponId() != null) {
            // åˆ›å»ºä¼˜æƒ åˆ¸æŸ¥è¯¢ç¤ºä¾‹
            Coupon example = Coupon.builder()
                    .userId(order.getUserId())
                    .id(order.getCouponId())
                    .status(CouponStatus.AVAILABLE)
                    .build();

            // æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ä¼˜æƒ åˆ¸
            coupon = couponDao.findAll(Example.of(example)).stream()
                    .findFirst()
                    .orElseThrow(() -> new RuntimeException("ä¼˜æƒ åˆ¸ä¸å­˜åœ¨"));

            // å°†ä¼˜æƒ åˆ¸è½¬æ¢ä¸ºä¼˜æƒ åˆ¸ä¿¡æ¯å¯¹è±¡
            CouponInfo couponInfo = CouponConverter.convertToCoupon(coupon);
            // åŠ è½½ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
            couponInfo.setTemplateInfo(templateService.loadCouponTemplate(coupon.getTemplateId()));
            // å°†ä¼˜æƒ åˆ¸ä¿¡æ¯æ·»åŠ åˆ°è®¢å•ä¸­
            order.setCouponInfos(Lists.newArrayList(couponInfo));
        }

        // è®¡ç®—è®¢å•ä»·æ ¼
        ShoppingCart checkoutInfo = calculationService.calculateOrderPrice(order);

        // å¦‚æœå«æœ‰ä¼˜æƒ åˆ¸
        if (coupon != null) {
            // å¦‚æœè®¢å•ä¸­æ²¡æœ‰ä¼˜æƒ åˆ¸ä¿¡æ¯
            if (CollectionUtils.isEmpty(checkoutInfo.getCouponInfos())) {
                log.error("æ²¡æœ‰ä¼˜æƒ åˆ¸ä¿¡æ¯");
                throw new IllegalArgumentException("æ²¡æœ‰ä¼˜æƒ åˆ¸ä¿¡æ¯");
            }

            log.info("æ›´æ–°ä¼˜æƒ åˆ¸çŠ¶æ€");
            // æ›´æ–°ä¼˜æƒ åˆ¸çŠ¶æ€ä¸ºå·²ä½¿ç”¨
            coupon.setStatus(CouponStatus.USED);
            // ä¿å­˜ä¼˜æƒ åˆ¸ä¿¡æ¯
            couponDao.save(coupon);
        }
        // è¿”å›ç»“è´¦ä¿¡æ¯å¯¹è±¡
        return checkoutInfo;
    }


    @Override
    public SimulationResponse simulateOrderPrice(SimulationOrder order) {
        // åˆ›å»ºä¸€ä¸ªç©ºçš„CouponInfoåˆ—è¡¨
        ArrayList<CouponInfo> couponInfos = Lists.newArrayList();

        // éå†è®¢å•ä¸­çš„ä¼˜æƒ åˆ¸IDåˆ—è¡¨
        for (Long couponID : order.getCouponIDs()) {
            // åˆ›å»ºä¸€ä¸ªCouponçš„æ„å»ºå™¨å¯¹è±¡ï¼Œå¹¶è®¾ç½®ç”¨æˆ·IDã€ä¼˜æƒ åˆ¸IDå’ŒçŠ¶æ€
            Coupon example = Coupon.builder()
                    .userId(order.getUserId())
                    .id(couponID)
                    .status(CouponStatus.AVAILABLE)
                    .build();

            // é€šè¿‡ä¼˜æƒ åˆ¸IDæŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼Œå¹¶å°†ç»“æœè½¬æ¢ä¸ºObservable
            Optional<Coupon> couponOptional = couponDao.findAll(Example.of(example)).stream().findFirst();

            // å¦‚æœæŸ¥è¯¢åˆ°äº†ä¼˜æƒ åˆ¸
            if (couponOptional.isPresent()) {
                // è·å–ä¼˜æƒ åˆ¸å¯¹è±¡
                Coupon coupon = couponOptional.get();

                // å°†ä¼˜æƒ åˆ¸è½¬æ¢ä¸ºCouponInfoå¯¹è±¡
                CouponInfo couponInfo = CouponConverter.convertToCoupon(coupon);

                // åŠ è½½ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯
                couponInfo.setTemplateInfo(templateService.loadCouponTemplate(coupon.getTemplateId()));

                // å°†CouponInfoå¯¹è±¡æ·»åŠ åˆ°åˆ—è¡¨ä¸­
                couponInfos.add(couponInfo);
            }
        }

        // å°†ç”Ÿæˆçš„ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ—è¡¨è®¾ç½®å›è®¢å•å¯¹è±¡
        order.setCouponInfos(couponInfos);

        // è°ƒç”¨è®¡ç®—æœåŠ¡çš„simulateOrderæ–¹æ³•ï¼Œè¿”å›æ¨¡æ‹Ÿè®¢å•ç»“æœ
        return calculationService.simulateOrder(order);
    }


    @Override
    public void deleteCoupon(Long userId, Long couponId) {
        // æ„å»ºä¼˜æƒ åˆ¸æŸ¥è¯¢ç¤ºä¾‹
        Coupon example = Coupon.builder()
                .userId(userId)
                .id(couponId)
                .status(CouponStatus.AVAILABLE)
                .build();

        // æ ¹æ®æŸ¥è¯¢ç¤ºä¾‹è·å–ç¬¦åˆæ¡ä»¶çš„ä¼˜æƒ åˆ¸
        Coupon coupon = couponDao.findAll(Example.of(example))
                .stream()
                .findFirst()
                .orElseThrow(() -> new RuntimeException("ä¼˜æƒ åˆ¸ä¸å­˜åœ¨"));

        // å°†ä¼˜æƒ åˆ¸çŠ¶æ€è®¾ç½®ä¸ºæ— æ•ˆ
        coupon.setStatus(CouponStatus.INACTIVE);

        // ä¿å­˜ä¿®æ”¹åçš„ä¼˜æƒ åˆ¸
        couponDao.save(coupon);
    }


    @Override
    public List<CouponInfo> findCoupon(SearchCoupon request) {
        // æ ¹æ®æœç´¢æ¡ä»¶æŸ¥è¯¢ä¼˜æƒ åˆ¸åˆ—è¡¨
        // æ³¨æ„ï¼šåœ¨ç”Ÿäº§ä¸­æ­¤å¤„åº”è¯¥ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ä¸”æŸ¥è¯¢æ¡ä»¶åº”è¯¥å°è£…ä¸ºä¸€ä¸ªç±»
        Coupon example = Coupon.builder()
                .userId(request.getUserId())
                .status(CouponStatus.convert(request.getStatus()))
                .shopId(request.getShopId())
                .build();

        List<Coupon> coupons = couponDao.findAll(Example.of(example));
        // å¦‚æœä¼˜æƒ åˆ¸åˆ—è¡¨ä¸ºç©º,è¿”å›ç©ºåˆ—è¡¨
        if (coupons.isEmpty()) {
            return Lists.newArrayList();
        }

        // è·å–ä¼˜æƒ åˆ¸æ¨¡æ¿IDåˆ—è¡¨
        List<Long> templateIds = coupons.stream()
                .map(Coupon::getTemplateId)
                .collect(Collectors.toList());
        // æ ¹æ®æ¨¡æ¿IDè·å–ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯æ˜ å°„
        Map<Long, CouponTemplateInfo> templateMap = templateService.getCouponTemplateMap(templateIds);
        // å°†ä¼˜æƒ åˆ¸æ¨¡æ¿ä¿¡æ¯è®¾ç½®åˆ°ä¼˜æƒ åˆ¸å¯¹è±¡ä¸­
        coupons.forEach(coupon -> coupon.setTemplateInfo(templateMap.get(coupon.getTemplateId())));

        // å°†ä¼˜æƒ åˆ¸åˆ—è¡¨è½¬æ¢ä¸ºä¼˜æƒ åˆ¸ä¿¡æ¯åˆ—è¡¨
        return coupons.stream()
                .map(CouponConverter::convertToCoupon)
                .collect(Collectors.toList());
    }
}
```

æ¶‰åŠåˆ°çš„è½¬æ¢å™¨å¦‚ä¸‹ï¼š

```java
/**
 * ä¼˜æƒ å·è½¬æ¢å™¨
 *
 * @author javgo.cn
 * @date 2023/11/4
 */
public class CouponConverter {

    public static CouponInfo convertToCoupon(Coupon coupon) {
        return CouponInfo.builder()
                .id(coupon.getId())
                .status(coupon.getStatus().getCode())
                .templateId(coupon.getTemplateId())
                .shopId(coupon.getShopId())
                .userId(coupon.getUserId())
                .templateInfo(coupon.getTemplateInfo())
                .build();
    }
}
```

åœ¨è¿™é‡Œï¼Œè½¬æ¢å™¨çš„ä½œç”¨æ˜¯ç¡®ä¿å®ä½“å¯¹è±¡ä¸æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ä¹‹é—´çš„å‡†ç¡®è½¬æ¢ï¼Œè¿™å¯¹ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§è‡³å…³é‡è¦ã€‚

#### 4.3.3 Controller å±‚

åœ¨ä¸šåŠ¡é€»è¾‘å±‚çš„å®ç°ä¹‹åï¼Œç´§æ¥ç€æ˜¯å°†æœåŠ¡é€»è¾‘ä¸å‰ç«¯äº¤äº’çš„æ§åˆ¶å™¨å±‚ã€‚åœ¨ `CouponCustomerController` ä¸­ï¼Œæˆ‘å®šä¹‰äº†å‡ ä¸ªå¯¹å¤–æ¥å£ï¼Œè¿™äº›æ¥å£é€šè¿‡è°ƒç”¨ `CouponCustomerServiceImpl` ä¸­çš„æ–¹æ³•æ¥å…·ä½“å®ç°ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚

```java
/**
 * @author javgo.cn
 * @date 2023/11/4
 */
@Slf4j
@RestController
@RequestMapping("coupon-customer")
public class CouponCustomerController {
    @Resource
    private CouponCustomerService customerService;

    @PostMapping("requestCoupon")
    public Coupon requestCoupon(@Valid @RequestBody RequestCoupon request) {
        return customerService.requestCoupon(request);
    }

    @DeleteMapping("deleteCoupon")
    public void deleteCoupon(@RequestParam("userId") Long userId,
                             @RequestParam("couponId") Long couponId) {
        customerService.deleteCoupon(userId, couponId);
    }

    @PostMapping("simulateOrder")
    public SimulationResponse simulate(@Valid @RequestBody SimulationOrder order) {
        return customerService.simulateOrderPrice(order);
    }

    @PostMapping("placeOrder")
    public ShoppingCart checkout(@Valid @RequestBody ShoppingCart info) {
        return customerService.placeOrder(info);
    }

    @PostMapping("findCoupon")
    public List<CouponInfo> findCoupon(@Valid @RequestBody SearchCoupon request) {
        return customerService.findCoupon(request);
    }
}
```

åœ¨å®Œæˆäº†ç”¨æˆ·ä¼˜æƒ åˆ¸æœåŠ¡çš„ä¸šåŠ¡é€»è¾‘å±‚å’Œæ§åˆ¶å±‚å®ç°åï¼Œæ¥ä¸‹æ¥çš„æ­¥éª¤æ˜¯è¿›è¡Œåº”ç”¨å¯åŠ¨ç±»çš„é…ç½®ä»¥åŠç›¸å…³é…ç½®æ–‡ä»¶çš„è®¾ç½®ã€‚

#### 4.3.4 å¯åŠ¨ç±»

å¯åŠ¨ç±»æ˜¯ Spring Boot åº”ç”¨çš„å…¥å£ç‚¹ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„æ³¨è§£ï¼ŒSpring Boot å¯ä»¥è‡ªåŠ¨é…ç½®å…¶ä¸Šä¸‹æ–‡ç¯å¢ƒå¹¶å¯åŠ¨åº”ç”¨ã€‚

ä»¥ä¸‹æ˜¯å¯åŠ¨ç±»ä»£ç çš„æ ¸å¿ƒç‰‡æ®µï¼š

```java
@SpringBootApplication
@EnableJpaAuditing // å¼€å¯å®¡è®¡åŠŸèƒ½
@ComponentScan(basePackages = {"cn.javgo"})
@EnableTransactionManagement // å¼€å¯äº‹åŠ¡ç®¡ç†
@EnableJpaRepositories(basePackages = {"cn.javgo"}) // æ‰«æ JPA ç›¸å…³çš„ DAO å±‚
@EntityScan(basePackages = {"cn.javgo"}) // æ‰«æ JPA ç›¸å…³çš„å®ä½“ç±»
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

- `@SpringBootApplication`ï¼šè¿™æ˜¯ä¸€ä¸ªç»„åˆæ³¨è§£ï¼Œå®ƒæ•´åˆäº†`@Configuration`ï¼Œ`@EnableAutoConfiguration`ï¼Œå’Œ `@ComponentScan` æ³¨è§£ã€‚é€šè¿‡è¿™ä¸ªæ³¨è§£ï¼ŒSpring Boot è‡ªåŠ¨æ‰«æå¹¶åŠ è½½å®šä¹‰å¥½çš„ç»„ä»¶ã€‚
- `@ComponentScan(basePackages = "cn.javgo")`ï¼šè¿™ä¸ªæ³¨è§£å‘Šè¯‰ Spring Boot åœ¨ `cn.javgo` åŒ…ä¸‹ä»¥åŠå…¶å­åŒ…ä¸­æŸ¥æ‰¾ç»„ä»¶ã€é…ç½®å’ŒæœåŠ¡ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ Spring Boot çš„ä¸€ä¸ªçº¦å®šï¼šå®ƒé»˜è®¤ä¼šæ‰«æå¯åŠ¨ç±»æ‰€åœ¨åŒ…ä»¥åŠå…¶å­åŒ…ä¸­çš„ç»„ä»¶ã€‚å¦‚æœéœ€è¦åŠ è½½å…¶ä»–åŒ…è·¯å¾„ä¸‹çš„ç»„ä»¶ï¼Œåˆ™éœ€è¦é€šè¿‡ `@ComponentScan` æ³¨è§£æ˜ç¡®æŒ‡å®šæ‰«æè·¯å¾„ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœå¯åŠ¨ç±»ä½äº `cn.javgo.customer` åŒ…ä¸­ï¼Œä½†é¡¹ç›®ä¸­éœ€è¦åŠ è½½ `cn.javgo.template` åŒ…ä¸‹çš„ç»„ä»¶ï¼Œå°±éœ€è¦åœ¨ `@ComponentScan` ä¸­æŒ‡å®šè¿™äº›åŒ…ä½œä¸ºé¢å¤–çš„æ‰«æè·¯å¾„ã€‚

#### 4.3.5 æ¨¡å—é…ç½®

å¯¹äºé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ `application.yml`ï¼ˆæˆ– `application.properties`ï¼‰ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿé‰´å·²æœ‰çš„ `coupon-template-impl` æœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œå¤åˆ¶å¹¶è°ƒæ•´å¿…è¦çš„é…ç½®é¡¹æ¥æ»¡è¶³å½“å‰æœåŠ¡çš„éœ€æ±‚ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œç¡®ä¿ä¿®æ”¹ `spring.application.name `å±æ€§ï¼Œå°†å…¶è®¾ç½®ä¸º `coupon-customer-serv`ï¼Œä»¥åæ˜ æœåŠ¡çš„å®é™…èº«ä»½ã€‚

é…ç½®æ–‡ä»¶çš„è¯¦ç»†å†…å®¹ï¼š

```properties
# æœåŠ¡å™¨ç«¯å£
server.port=20001

# æ˜¯å¦åœ¨é”™è¯¯ä¿¡æ¯ä¸­åŒ…å«æ¶ˆæ¯
server.error.include-message=always

# åº”ç”¨åç§°
spring.application.name=coupon-customer-serv

# æ•°æ®åº“é©±åŠ¨ç±»å
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
# æ•°æ®åº“è¿æ¥URL
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/coupon_db?autoReconnect=true&useUnicode=true&characterEncoding=utf8&useSSL=false&allowPublicKeyRetrieval=true&zeroDateTimeBehavior=convertToNull&serverTimezone=UTC
# æ•°æ®åº“ç”¨æˆ·å
spring.datasource.username=root
# æ•°æ®åº“å¯†ç 
spring.datasource.password=root

# æ•°æ®æºç±»å‹
spring.datasource.type=com.zaxxer.hikari.HikariDataSource
# æ•°æ®æºè¿æ¥æ± åç§°
spring.datasource.hikari.pool-name=CouponHikari
# è¿æ¥è¶…æ—¶æ—¶é—´
spring.datasource.hikari.connection-timeout=5000
# ç©ºé—²è¶…æ—¶æ—¶é—´
spring.datasource.hikari.idle-timeout=30000
# æœ€å¤§è¿æ¥æ± å¤§å°
spring.datasource.hikari.maximum-pool-size=10
# æœ€å°è¿æ¥æ± å¤§å°
spring.datasource.hikari.minimum-idle=5
# è¿æ¥ç”Ÿå‘½å‘¨æœŸ
spring.datasource.hikari.max-lifetime=60000
# è‡ªåŠ¨æäº¤
spring.datasource.hikari.auto-commit=true

# æ˜¯å¦æ˜¾ç¤º Hibernate SQL è¯­å¥
spring.jpa.show-sql=true
# JPA ç”ŸæˆDDLçš„æ–¹å¼
spring.jpa.hibernate.ddl-auto=none
# Hibernate SQL è¯­å¥æ ¼å¼åŒ–
spring.jpa.properties.hibernate.format_sql=true
# Hibernate SQL è¯­å¥æ˜¾ç¤º
spring.jpa.properties.hibernate.show_sql=true
# æ˜¯å¦åœ¨è§†å›¾ä¸­æ‰“å¼€ JPA è¿æ¥
spring.jpa.open-in-view=false

# æ—¥å¿—çº§åˆ«
logging.level.cn.javgo.coupon=debug
```

é…ç½®å®Œå¯åŠ¨ç±»å’Œ `application.properties` ä¹‹åï¼Œç”¨æˆ·ä¼˜æƒ åˆ¸æœåŠ¡çš„ Spring Boot ç‰ˆæœ¬å°±é…ç½®å®Œæˆäº†ã€‚ç°åœ¨ï¼Œé€šè¿‡åœ¨æœ¬åœ°å¯åŠ¨å•ä½“åº”ç”¨ `coupon-customer-serv`ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ•´åˆå¹¶ä½¿ç”¨ç”¨æˆ·æœåŠ¡ã€æ¨¡æ¿æœåŠ¡å’Œè®¡ç®—æœåŠ¡çš„åŠŸèƒ½ã€‚

åœ¨æœ¬åœ°ç¯å¢ƒä¸‹ï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œå¯åŠ¨ç±»æ¥å¯åŠ¨æœåŠ¡ï¼Œå¹¶é€šè¿‡ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯æœåŠ¡çš„åŠŸèƒ½ï¼Œç¡®ä¿å®ƒä»¬æŒ‰é¢„æœŸå·¥ä½œã€‚

## 5.é¡¹ç›®æ€»ç»“

æˆ‘ä»¬å…±åŒæ‰“é€ äº†ä¸€ä¸ªåŸºäº Spring Boot çš„ä¼˜æƒ åˆ¸å¹³å°ï¼Œæ¶µç›–äº†ç”¨æˆ·ã€æ¨¡æ¿å’Œè®¡ç®—ç­‰ä¸‰ä¸ªæ ¸å¿ƒæœåŠ¡æ¨¡å—ã€‚æœ¬é¡¹ç›®é‡‡çº³äº†**åˆ†å±‚è®¾è®¡åŸåˆ™**ï¼Œç»†åŒ–ä¸º APIã€DAO å’Œä¸šåŠ¡é€»è¾‘å±‚ï¼Œä»¥ç¡®ä¿æ¶æ„çš„æ¸…æ™°æ€§å’Œç»´æŠ¤çš„ä¾¿æ·æ€§ã€‚åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œspring-data-jpa çš„åŠ å…¥æå¤§ç®€åŒ–äº†æ•°æ®æ“ä½œï¼Œè€Œ spring-web åˆ™ä¸ºæˆ‘ä»¬æä¾›äº†æ„å»º RESTful æ¥å£çš„å¼ºå¤§å·¥å…·ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å³å°†è¸å…¥ Spring Cloud çš„å­¦ä¹ ä¹‹æ—…ã€‚åœ¨è¿™ä¸ªç¯‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥äº†è§£ Nacosã€Loadbalancerã€OpenFeign ç­‰å…³é”®ç»„ä»¶ï¼Œå®ƒä»¬æ˜¯æ„å»ºå¾®æœåŠ¡æ¶æ„ä¸­è·¨æœåŠ¡è°ƒç”¨ç³»ç»Ÿçš„åŸºçŸ³ã€‚é€šè¿‡ Spring Cloudï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®ç°æœåŠ¡çš„è‡ªåŠ¨æ³¨å†Œä¸å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æœåŠ¡ç†”æ–­å’Œé“¾è·¯è¿½è¸ªç­‰é«˜çº§åŠŸèƒ½ï¼Œè¿™å°†æå¤§åœ°æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¯é æ€§ã€‚
