import{_ as l}from"./plugin-vue_export-helper-c27b6911.js";import{r as c,o as i,c as u,a as s,d as n,b as a,w as o,f as t}from"./app-009ef08a.js";const d={},k=t('<h2 id="_1-搭建开发环境" tabindex="-1"><a class="header-anchor" href="#_1-搭建开发环境" aria-hidden="true">#</a> 1.搭建开发环境</h2><p>“工欲善其事，必先利其器”——这个古代的格言在现代软件开发中依然适用。开发环境的搭建是进行高效软件开发的基础，确保在项目实施过程中系统运行的稳定性与一致性。在深入项目实战之前，关键在于建立一个健全且可靠的开发环境，以避免后期由于环境配置不当带来的种种问题和挑战。</p><ol><li><p><strong>开发环境的统一标准化</strong></p><p>首先，统一的开发环境配置是保障项目团队协作顺畅的重要因素。我们需确保各开发组件，如 Java、Maven 和其他相关中间件的版本统一。版本的统一有助于减少因环境差异导致的问题，如兼容性问题或功能差异，从而保证项目的进度和质量。</p></li><li><p><strong>关键中间件的选择与搭建</strong></p><p>在本项目中，我们选用了多个重要的中间件，包括但不限于 Spring Cloud 的核心组件如 Nacos、Sentinel、Zipkin 和 Seata。选择这些中间件是为了提高项目的可靠性、监控能力及分布式事务管理。我们将在后续章节中逐一深入介绍这些中间件的作用、安装过程和配置方法。</p></li><li><p><strong>集成开发环境（IDE）和数据库的设置</strong></p><p>我们还需要搭建集成开发环境（IDE），安装数据库，并导入必要的数据库脚本。一个高效的 IDE 可以极大提高开发效率，而适当配置的数据库是确保数据存取效率和安全的关键。此外，我们还会探讨如何安装和配置一些常用的中间件，以便更好地支持后续的开发工作。</p></li></ol><p>OK，不说废话了，我们正式开始！</p><h3 id="_1-1-环境准备-选择一个合适的操作系统" tabindex="-1"><a class="header-anchor" href="#_1-1-环境准备-选择一个合适的操作系统" aria-hidden="true">#</a> 1.1 环境准备：选择一个合适的操作系统</h3><p>选择一个适合的操作系统是开发过程中的第一步。针对 Java 开发，强烈推荐 <strong>Mac 笔记本或者基于 Linux 的操作系统</strong>。Linux 系统由于其稳定性、灵活性以及与生产环境的一致性，被广泛认为是服务器端应用和开发的首选。而 Mac 系统，凭借其优秀的用户体验和对开发者友好的环境，同样是一个不错的选择。</p><p>如果你目前是 Windows 用户，有以下几种方式可以获得类似 Linux 的开发体验：</p><ol><li><strong>安装双系统</strong>：这是最接近真实 Linux 系统的体验，但可能需要额外的分区或硬盘空间。</li><li><strong>使用 Cygwin 或 Ubuntu 虚拟机</strong>：这些工具可以在 Windows 系统中模拟出 Linux 环境，方便且高效。</li></ol><p>接下来，我将介绍如何在 Mac 系统上配置开发环境。尽管这里以 Mac 系统为例，但相同的步骤也适用于 Linux，只是安装方式可能略有不同。Windows 用户可以参考官方下载链接进行相应软件的安装。</p><h3 id="_1-2-homebrew-mac-上的软件管理神器" tabindex="-1"><a class="header-anchor" href="#_1-2-homebrew-mac-上的软件管理神器" aria-hidden="true">#</a> 1.2 Homebrew：Mac 上的软件管理神器</h3><p>Homebrew 是 Mac 上的一款强大的包管理工具，它可以大大简化软件的安装和管理过程。你可以通过下面的步骤在 Mac 上安装 Homebrew。</p>',11),r={href:"https://brew.sh/",target:"_blank",rel:"noopener noreferrer"},v=t(`<figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-023042.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>使用以下命令进行安装：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>/bin/bash <span class="token parameter variable">-c</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span class="token variable">)</span></span>&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>由于某些网络环境的限制，你可能会遇到安装速度缓慢的问题。这里有两个解决方案：</p><ol><li><strong>使用 VPN</strong>：这可以有效提高下载速度，但可能需要额外的费用或配置。</li><li><strong>切换到国内镜像源</strong>：如清华大学或中国科技大学的镜像。官方安装文档中有详细的替换方法。</li></ol><p>安装完成后，执行 <code>brew -v</code> 来验证安装是否成功。你应该能看到类似以下的输出信息：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>➜  ~ brew <span class="token parameter variable">-v</span>
Homebrew <span class="token number">4.0</span>.28-67-ge9ac36a
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>有了 Homebrew，你可以方便地使用 <code>brew install</code> 命令安装所需软件。但是，使用国内镜像时，请注意某些软件或依赖项可能因网络问题安装失败，此时可以尝试根据错误日志单独安装有问题的依赖然后再尝试安装目标软件。</p><h3 id="_1-3-java-和-maven-高效-java-开发的关键" tabindex="-1"><a class="header-anchor" href="#_1-3-java-和-maven-高效-java-开发的关键" aria-hidden="true">#</a> 1.3 Java 和 Maven：高效 Java 开发的关键</h3><p>Java 和 Maven 是 Java 开发的核心工具，其版本选择和配置直接影响到开发的效率和项目的稳定性。以下将详细介绍如何配置这两个工具，确保一个顺畅的开发流程。</p><p>Java 和 Maven 版本选择：</p>`,11),m=s("strong",null,"JDK 8",-1),g={href:"https://www.oracle.com/sg/java/technologies/javase/javase8u211-later-archive-downloads.html",target:"_blank",rel:"noopener noreferrer"},b=s("strong",null,"Maven 版本",-1),y={href:"https://maven.apache.org/download.cgi",target:"_blank",rel:"noopener noreferrer"},f=t(`<p>由于 Maven 中央仓库在国内访问可能受限，我们可以通过配置 <code>settings.xml</code> 来指定国内的镜像仓库，以提高依赖包的下载速度。这里介绍两个常用的国内镜像：</p><p><strong>阿里云镜像</strong>：速度快，覆盖广泛，适合大多数场景。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirror</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>aliyunmaven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>阿里云公共仓库<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://maven.aliyun.com/repository/public<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirror</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>华为云镜像</strong>：这是一个高速且稳定的替代选项，我在这里使用华为云镜像。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirror</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>huaweicloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrorOf</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.huaweicloud.com/repository/maven/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirror</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过以上步骤，Java 和 Maven 的基本配置就完成了。</p><h3 id="_1-4-intellij-idea-java-开发的利器" tabindex="-1"><a class="header-anchor" href="#_1-4-intellij-idea-java-开发的利器" aria-hidden="true">#</a> 1.4 IntelliJ IDEA：Java 开发的利器</h3><p>IntelliJ IDEA 是一个功能强大且流行的 Java 集成开发环境（IDE），由 JetBrains 开发。它不仅支持 Java，还支持多种其他编程语言和框架。以下是其安装步骤：</p>`,8),h=s("strong",null,"下载",-1),w={href:"https://www.jetbrains.com/zh-cn/idea/download",target:"_blank",rel:"noopener noreferrer"},I=s("li",null,[s("strong",null,"安装"),n("：根据你的操作系统，执行安装程序。过程中，你可以选择安装位置、创建桌面快捷方式等。")],-1),C=s("li",null,[s("strong",null,"配置"),n("：初次启动 IntelliJ IDEA 后，你会被引导完成一些基础配置，比如界面主题、编辑器设置等。")],-1),T=s("li",null,[s("strong",null,"激活"),n("：如果你使用商业版，需要进行激活。学生和教师可通过教育邮箱申请免费的商业版授权。")],-1),q=t(`<figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-024538.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_1-5-lombok-代码简化神器" tabindex="-1"><a class="header-anchor" href="#_1-5-lombok-代码简化神器" aria-hidden="true">#</a> 1.5 Lombok：代码简化神器</h3><p>Lombok 是一个非常实用的 Java 库，用于自动化常见的模板代码，如 getters、setters、equals、hashCode 和 toString 方法。</p><p>在 IntelliJ IDEA 中，安装 Lombok 非常简单。只需在 IDEA 的插件市场中搜索并安装 Lombok 插件即可：</p><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-024723.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>接着启用注解处理器，在 “Settings” 中，进入 “Build, Execution, Deployment” &gt; “Compiler” &gt; “Annotation Processors”。确保勾选 “Enable annotation processing”：</p><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-10-29-121745.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>为了在项目中使用 Lombok，确保你的 <code>pom.xml</code> 或 <code>build.gradle</code> 文件中加入了 Lombok 依赖。Maven 示例：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>最新版本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6-mysql-及其可视化工具-构建高效数据环境" tabindex="-1"><a class="header-anchor" href="#_1-6-mysql-及其可视化工具-构建高效数据环境" aria-hidden="true">#</a> 1.6 MySQL 及其可视化工具：构建高效数据环境</h3><p>我们将使用 MySQL 作为核心数据库。如果你的系统中已经安装了 MariaDB，无需担心，因为 MariaDB 是 MySQL 的一个分支，由 MySQL 的创始人之一开发，并保持与 MySQL 的高度兼容性。</p><p>安装 MySQL 非常简便。Mac 用户可以通过 Homebrew 进行安装，只需执行以下命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>brew <span class="token function">install</span> mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,13),S={href:"https://dev.mysql.com/downloads/mysql",target:"_blank",rel:"noopener noreferrer"},A=t(`<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-025049.png" style="zoom:33%;"><p>完成安装后，可以用以下任一方法启动 MySQL：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 使用 mysql.server 启动</span>
mysql.server start

<span class="token comment"># 使用 brew services 启动（推荐）</span>
brew services start mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同样地，要关闭 MySQL，可用对应的命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 使用 mysql.server 停止</span>
mysql.server stop

<span class="token comment"># 使用 brew services 停止（推荐）</span>
brew services stop mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>TIP：使用 <code>brew services</code> 管理 MySQL 服务时，<code>brew services stop mysql</code> 不仅能方便地停止服务，还可防止系统重启时 MySQL 自动启动。</p></blockquote><p>为验证 MySQL 是否正确安装，尝试使用以下命令登录：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里使用默认的 root 用户登录（初始密码为空）。登录成功后，会见到类似下方的界面，表示 MySQL 安装并运行正常：</p><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-030049.png" style="zoom:50%;"><p>登录后，建议立即修改 root 用户的密码，提高数据库安全性：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">USER</span> <span class="token string">&#39;root&#39;</span><span class="token variable">@&#39;localhost&#39;</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;新密码&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>继 MySQL 安装后，为了更高效地管理数据库，我推荐使用 DataGrip，它是 JetBrains 开发的一款强大的数据库管理工具。DataGrip 支持 MySQL 以及多种其他数据库，提供丰富的功能，如代码自动完成、分析和重构等。</p>`,13),j={href:"https://www.jetbrains.com/zh-cn/datagrip/download",target:"_blank",rel:"noopener noreferrer"},L=t('<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-025527.png" style="zoom:33%;"><p>安装并启动 DataGrip 后，需要添加一个数据源来连接本地的 MySQL 数据库：</p><ol><li>在 DataGrip 中，点击 &quot;添加数据源&quot;。</li><li>选择 MySQL。</li><li>输入数据库连接详情： <ul><li><strong>用户名</strong>：root（或你的自定义用户名）</li><li><strong>密码</strong>：（留空或输入你设置的密码）</li><li><strong>JDBC URL</strong>：<code>jdbc:mysql://localhost:3306</code></li></ul></li><li>确保已安装 MySQL JDBC 驱动。如果未安装，DataGrip 通常会提示下载。</li></ol><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-032416.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>完成这些步骤后，点击 &quot;测试连接&quot; 检查是否能够成功连接到数据库。连接成功意味着你现在可以通过 DataGrip 来管理 MySQL 数据库，进行查询、编辑、管理数据表等操作。</p><p>在实战项目开始之前，我们需要先在 MySQL 中构建项目所需的数据库和数据表。这个过程对于整个项目的数据管理至关重要。</p><p><strong>创建数据库</strong>：我们首先创建一个名为 <code>coupon_db</code> 的数据库，用于存储所有与优惠券相关的数据。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 创建数据库 coupon_db</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> coupon_db<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建 <code>coupon_template</code> 数据表</strong>：该表用于存储优惠券模板的相关信息，如优惠券名称、类型、适用门店等。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 如果存在同名表则删除，然后创建 coupon_template 数据表</span>\n<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>coupon_db<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>coupon_template<span class="token punctuation">`</span></span><span class="token punctuation">;</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>coupon_db<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>coupon_template<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n     <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                   <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;主键&#39;</span><span class="token punctuation">,</span>\n     <span class="token identifier"><span class="token punctuation">`</span>available<span class="token punctuation">`</span></span>        <span class="token keyword">boolean</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">false</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;优惠券可用状态，默认为 false 表示不能使用&#39;</span><span class="token punctuation">,</span>\n     <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span>              <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;优惠券名称&#39;</span><span class="token punctuation">,</span>\n     <span class="token identifier"><span class="token punctuation">`</span>description<span class="token punctuation">`</span></span>     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;优惠券详细信息&#39;</span><span class="token punctuation">,</span>\n     <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span>                <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;优惠券类型&#39;</span><span class="token punctuation">,</span>\n     <span class="token identifier"><span class="token punctuation">`</span>shop_id<span class="token punctuation">`</span></span>           <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;适用的门店，空代表全场适用&#39;</span><span class="token punctuation">,</span>\n     <span class="token identifier"><span class="token punctuation">`</span>created_time<span class="token punctuation">`</span></span>   <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;2023-09-17 00:00:00&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span>\n     <span class="token identifier"><span class="token punctuation">`</span>rule<span class="token punctuation">`</span></span>                 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;使用规则&#39;</span><span class="token punctuation">,</span>\n     \n     <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n     <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_shop_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>shop_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;优惠券模板&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建 <code>coupon</code> 数据表</strong>：此表记录用户领取的优惠券信息，包括用户ID、领券时间、优惠券状态等。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 如果存在同名表则删除，然后创建 coupon 数据表</span>\n<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>coupon_db<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>coupon<span class="token punctuation">`</span></span><span class="token punctuation">;</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>coupon_db<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>coupon<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                    <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;主键&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>template_id<span class="token punctuation">`</span></span>    <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;优惠券模版ID&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span>           <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户ID&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>created_time<span class="token punctuation">`</span></span>  <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;2023-09-17 00:00:00&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;领券时间&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>              <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;优惠券状态&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>shop_id<span class="token punctuation">`</span></span>          <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;冗余字段，方便查找&#39;</span><span class="token punctuation">,</span>\n\n    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_user_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_template_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>template_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">&#39;领到的优惠券&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上 SQL 脚本创建了一个专注于优惠券相关数据的数据库和两个主要数据表。<code>coupon_template</code> 表格用于定义优惠券的基本模板，而 <code>coupon</code> 表格记录了具体的优惠券发放情况。确保在执行这些脚本前，MySQL 服务正在运行。</p><blockquote><p>✏️ 数据表设计要点：</p><ul><li><strong>数据类型选择</strong>：合理选择数据类型能够优化存储空间和查询效率。例如，使用 <code>int</code> 类型表示主键，<code>varchar</code> 存储字符串。</li><li><strong>冗余字段</strong>：<code>coupon</code> 表中的 <code>shop_id</code> 作为冗余字段，便于快速查询优惠券适用门店，这减少了与 <code>coupon_template</code> 表的联合查询需求。</li><li><strong>默认值与注释</strong>：表中字段的默认值及注释的设置增强了数据的可读性和维护性。</li></ul></blockquote><h3 id="_1-7-消息中间件-rabbitmq-的安装与配置" tabindex="-1"><a class="header-anchor" href="#_1-7-消息中间件-rabbitmq-的安装与配置" aria-hidden="true">#</a> 1.7 消息中间件：RabbitMQ 的安装与配置</h3><p>RabbitMQ 是目前使用最广泛的消息中间件之一。后续 Spring Cloud 项目中，我们将结合 Stream 组件和 RabbitMQ 来实现异步消息传递。</p><p><strong>对于 Mac 用户</strong>：使用 Homebrew 快速安装 RabbitMQ 的命令很方便，如下命令将自动安装 RabbitMQ 的最新稳定版本。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>brew <span class="token function">install</span> rabbitmq\n</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>',18),_=s("strong",null,"非 Mac 用户或手动安装",-1),x={href:"https://www.rabbitmq.com/",target:"_blank",rel:"noopener noreferrer"},D=t(`<figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-031755.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>启动 RabbitMQ</strong>：启动 RabbitMQ 服务的命令根据安装方式略有不同。如果通过 Homebrew 安装，可以使用：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmq-server
<span class="token comment"># 或者（推荐）</span>
brew services start rabbitmq
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>TIP：如果是手动安装，确保 RabbitMQ 的安装路径已添加至 PATH 环境变量。</p></blockquote><p><strong>关闭 RabbitMQ</strong>：正确关闭 RabbitMQ 服务是非常重要的，尤其是在处理重要数据和配置时。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>rabbitmqctl stop
<span class="token comment"># 或者（推荐）</span>
brew services stop rabbitmq
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>TIP：确保在停止 RabbitMQ 之前保存所有的重要数据和配置，以防数据丢失或配置被重置。</p></blockquote><p>在浏览器中输入 <code>http://localhost:15672/</code> 访问 RabbitMQ 的管理界面，默认端口为 <code>15672</code>。默认的用户名和密码均为 <code>guest</code>。</p><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-043816.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>登录成功后，你可以看到 RabbitMQ 的管理界面，它提供了关于消息、队列等的详细统计信息和管理选项。</p><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-043834.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>至此，你已经成功安装并运行了 RabbitMQ。</p><blockquote><p>注意：</p><ul><li><strong>更新 RabbitMQ</strong>：如果之前已经安装了 RabbitMQ，但非最新版本，建议更新到最新稳定版本，以便使用所有最新功能和插件。</li><li><strong>数据和配置的保存</strong>：在停止 RabbitMQ 服务之前，确保已经保存了所有重要的数据和配置，以避免数据丢失或配置被重置。</li></ul></blockquote><h3 id="_1-8-存储系统-redis-的安装与配置" tabindex="-1"><a class="header-anchor" href="#_1-8-存储系统-redis-的安装与配置" aria-hidden="true">#</a> 1.8 存储系统：Redis 的安装与配置</h3><p>Redis 是一个高性能的 key-value 存储系统，广泛应用于缓存、会话管理等场景。在微服务架构中，我们将使用 Redis 来实现网关层的限流功能。</p><p><strong>通过 Homebrew 安装</strong>：对于 Mac 用户，使用 Homebrew 安装 Redis 非常方便，以下命令将安装 Redis 的最新版本。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>brew <span class="token function">install</span> redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,17),O=s("strong",null,"手动安装",-1),P={href:"https://redis.io/download",target:"_blank",rel:"noopener noreferrer"},M=s("img",{src:"https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044049.png",style:{zoom:"33%"}},null,-1),R={href:"https://redis.io/docs/getting-started/installation/",target:"_blank",rel:"noopener noreferrer"},E=t(`<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044136.png" style="zoom:29%;"><p><strong>启动和停止 Redis 服务</strong>：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 启动 Redis 服务</span>
brew services start redis

<span class="token comment"># 停止 Redis 服务</span>
brew services stop redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行 <code>redis-cli</code> 连接至默认的 Redis 服务地址（localhost:6379）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>➜  ~ redis-cli
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Redis 控制台中，可以执行 Redis 命令以测试和管理您的 Redis 实例：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> <span class="token builtin class-name">test</span> <span class="token number">955</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get <span class="token builtin class-name">test</span>
<span class="token string">&quot;955&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然，还可以使用 DataGrip 连接 Redis 数据库，进行更直观的数据管理和操作：</p><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044757.png" style="zoom:50%;"><p>连接信息基本保持默认即可：</p><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-044901.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>至此，我们已经完成了所有必要工具的安装。在接下来的 Spring Cloud 微服务实战中，我们还将介绍和使用更多的中间件和工具。</p><blockquote><p>🚀 <strong>下一步：Spring Boot 快速入门</strong></p><p>已经配置好基础环境后，我们可以进一步深入到 Spring Boot 的学习和应用中了！让我们开始 Spring Boot 的旅程吧！**加油！**🔥</p></blockquote><h2 id="_2-搭建优惠券模板服务" tabindex="-1"><a class="header-anchor" href="#_2-搭建优惠券模板服务" aria-hidden="true">#</a> 2.搭建优惠券模板服务</h2><p>在本节，我们将详细探索如何从零开始搭建一个基于 Spring Boot 的优惠券平台，特别聚焦于优惠券模板服务（<code>coupon-template-serv</code>）的构建过程。这一服务是优惠券平台的核心，因为优惠券的生成与管理都依赖于模板。</p><p>项目结构概览：</p><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-11-01-160815.png" style="zoom:67%;"><p>我们的优惠券平台项目（<code>coupon-center</code>）包含四个主要子模块，它们在 Maven 管理下形成一个层次分明的结构：</p><ol><li><strong>coupon-template-serv</strong>：此模块负责创建、查找、克隆和删除优惠券模板。</li><li><strong>coupon-calculation-serv</strong>：处理优惠后的订单价格计算，以及评估各类优惠券的优惠程度。</li><li><strong>coupon-customer-serv</strong>：与用户相关的服务，包括领取优惠券、模拟计算优惠、删除优惠券和订单处理。</li><li><strong>middleware</strong>：存储跨业务的、平台级组件。</li></ol><p>每个以 <code>-serv</code> 结尾的子模块进一步细分为以下三个子模块，确保职责单一，代码管理清晰：</p><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-11-01-161047.png" style="zoom:67%;"><ul><li><strong>coupon-template-api</strong>：包含公共类和外部接口，如 Request 和 Response 对象。</li><li><strong>coupon-template-dao</strong>：定义数据库实体和数据访问对象（DAO）。</li><li><strong>coupon-template-impl</strong>：具体实现服务的核心业务逻辑和 REST API。</li></ul><p>接下来，我们将具体介绍如何配置和启动 <code>coupon-template-serv</code> 模块，包括数据库配置、核心业务逻辑的实现，以及如何通过 REST API 对外提供服务。</p><h3 id="_2-1-添加-maven-依赖项" tabindex="-1"><a class="header-anchor" href="#_2-1-添加-maven-依赖项" aria-hidden="true">#</a> 2.1 添加 Maven 依赖项</h3><p>在构建基于 Maven 的 Spring Boot 项目时，合理的依赖管理策略对于项目的结构和后续维护至关重要。以下内容将详细介绍如何在多模块项目中添加和配置 Maven 依赖项，以及它们在项目中的层级关系。</p><h4 id="_2-1-1-编写-part01-springboot-quick-依赖项" tabindex="-1"><a class="header-anchor" href="#_2-1-1-编写-part01-springboot-quick-依赖项" aria-hidden="true">#</a> 2.1.1 编写 part01-springboot-quick 依赖项</h4><p>在我们的实战项目 <code>part01-springboot-quick</code> 中，它作为顶层项目，主要承担着定义公共 Maven 依赖版本的责任，类似于一个公司的战略管理层，指明大方向而不涉足具体业务。这些配置均在项目的 <code>pom.xml</code> 文件中指定。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.javgo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ch0-springboot-monolithic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>ch0-springboot-monolithic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://maven.apache.org<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- 子模块 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>coupon-template-serv<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>coupon-calculation-serv<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>coupon-customer-serv<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>middleware<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- 属性 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- 依赖管理 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- Spring Cloud 版本 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2020.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!-- Spring Cloud Alibaba 版本 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2021.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!-- Apache Commons --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-collections4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!-- Alibaba FastJson --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.31<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!-- Lombok --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!-- Jakarta Bean Validation --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>jakarta.validation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jakarta.validation-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!-- Google Guava --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>16.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这份 <code>pom.xml</code> 文件中，重点关注以下三个标签：</p><ol><li><p><strong>&lt; parent &gt; 标签</strong></p><p>通过 <code>&lt;parent&gt;</code> 标签的配置，我们确定了顶层项目的父依赖为 <code>spring-boot-starter-parent</code>，它为我们的子模块提供了所需的 Spring Boot 组件版本，这样的做法利于保持依赖的一致性和简化管理。</p></li><li><p><strong>&lt; packaging &gt; 标签</strong></p><p>这里我们指定 <code>&lt;packaging&gt;</code> 的值为 <code>pom</code>，意味着该模块聚焦于策略性的定义，包括子模块的整合和依赖版本管理，而不包含具体的业务逻辑实现。</p></li><li><p><strong>&lt; dependencyManagement &gt; 标签</strong></p><p>与 <code>&lt;parent&gt;</code> 类似，<code>&lt;dependencyManagement&gt;</code> 用于集中管理项目依赖版本。这样，子模块在声明依赖时，只需指出 <code>groupId</code> 和 <code>artifactId</code>，无需指定版本，避免了版本冲突和混乱。</p></li></ol><h4 id="_2-1-2-编写-coupon-template-serv-依赖项" tabindex="-1"><a class="header-anchor" href="#_2-1-2-编写-coupon-template-serv-依赖项" aria-hidden="true">#</a> 2.1.2 编写 coupon-template-serv 依赖项</h4><p>接下来是 <code>coupon-template-serv</code> 子模块的依赖配置。作为 <code>part01-springboot-quick</code> 的直接子模块，它的 <code>pom.xml</code> 配置同样将 <code>&lt;packaging&gt;</code> 类型设为 <code>pom</code>，并且主要内容集中在确定其父模块，并定义下层子模块的配置。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.javgo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ch0-springboot-monolithic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-serv<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>coupon-template-serv<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>http://maven.apache.org<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>coupon-template-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>coupon-template-impl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>coupon-template-dao<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在完成了顶级模块和直接子模块的依赖配置后，我们的下一步是构建 <code>coupon-template-serv</code> 下属的三个子模块：</p><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-081052.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>以 <code>coupon-template-api</code> 子模块为起点，其主要职责是提供接口的请求和响应类模板，它是其他两个模块共享资源的基础，我们将着手于此模块的构建工作。</p><h3 id="_2-4-搭建-coupon-template-api-模块" tabindex="-1"><a class="header-anchor" href="#_2-4-搭建-coupon-template-api-模块" aria-hidden="true">#</a> 2.4 搭建 coupon-template-api 模块</h3><h4 id="_2-4-1-概览" tabindex="-1"><a class="header-anchor" href="#_2-4-1-概览" aria-hidden="true">#</a> 2.4.1 概览</h4><p><code>coupon-template-api</code> 模块担任了整个服务中<strong>共享数据类型和接口规范</strong>的角色。它包含了所有的 REST API 消息传输对象（DTO），例如请求和响应对象，这些都是以 POJO（Plain Old Java Object）类的形式实现的。在微服务体系中，这样做可以避免在服务之间共享完整的业务逻辑，从而促进服务的独立性和可重用性。</p><h4 id="_2-4-2-依赖配置" tabindex="-1"><a class="header-anchor" href="#_2-4-2-依赖配置" aria-hidden="true">#</a> 2.4.2 依赖配置</h4><p>在这个模块的 <code>pom.xml</code> 中，我们加入了若干便于开发的工具类库，如 <code>lombok</code>（用于简化对象的创建和管理），<code>guava</code>（提供额外的集合处理能力），以及 <code>validation-api</code>（用于数据有效性校验）。</p><p>下面是这些依赖项的具体配置：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Apache Commons --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-collections4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Alibaba FastJson --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Lombok --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Jakarta Validation --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>jakarta.validation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jakarta.validation-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Google Guava --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-3-核心组件" tabindex="-1"><a class="header-anchor" href="#_2-4-3-核心组件" aria-hidden="true">#</a> 2.4.3 核心组件</h4>`,44),N=t(`<p>在 <code>cn.javgo.coupon.calculation.template.api.constant</code> 包中，<code>CouponType </code>枚举定义了一系列的优惠券类型。为了增加代码的<strong>鲁棒性</strong>，这里还设计了一个特殊的枚举值 <code>UNKNOWN</code>，用于处理无效的输入。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷类型枚举
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">CouponType</span> <span class="token punctuation">{</span>
    <span class="token function">UNKNOWN</span><span class="token punctuation">(</span><span class="token string">&quot;unknown&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">MONEY_OFF</span><span class="token punctuation">(</span><span class="token string">&quot;满减券&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">DISCOUNT</span><span class="token punctuation">(</span><span class="token string">&quot;折扣券&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">RANDOM_DISCOUNT</span><span class="token punctuation">(</span><span class="token string">&quot;随机折扣券&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">LONELY_NIGHT_MONEY_OFF</span><span class="token punctuation">(</span><span class="token string">&quot;晚间双倍满减券&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * 将给定的代码转换为相应的优惠券类型
     *
     * <span class="token keyword">@param</span> <span class="token parameter">code</span> 优惠券类型的代码
     * <span class="token keyword">@return</span> 转换后的优惠券类型
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CouponType</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">CouponType</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>bean <span class="token operator">-&gt;</span> bean<span class="token punctuation">.</span>code<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 防御性编程：处理恶意请求中故意输入的错误代码</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token constant">UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>`,3),B=t(`<p><code>TemplateRule </code>类位于 <code>cn.javgo.coupon.calculation.template.api.beans.rules</code> 包下，描述了优惠券模板的两个基本规则：领取规则和使用规则。这些规则对于理解和执行优惠券的行为至关重要。</p><ol><li><strong>领券规则</strong>：描述了每个用户可以领取的优惠券数量和优惠券的过期时间。</li><li><strong>优惠券的计算规则</strong>：描述了优惠券的具体折扣规则。</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷领取规则
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemplateRule</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 优惠卷折扣规则
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Discount</span> discount<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 优惠卷领取限制
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> limitation<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 优惠卷过期时间
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> deadline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>`,4),J=t(`<p><code>Discount </code>类定义了具体的折扣逻辑，这里使用 <code>Long</code> 类型以分为单位表示金额，以避免浮点数计算的精度问题。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠规则
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Discount</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 优惠金额
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * 注意：对于不同的优惠卷有不同的含义<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
     * 1、满减劵：满足一定金额后可以减去的金额<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
     * 2、折扣劵：折扣比例，如 90 表示打9折<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
     * 3、随机立减劵：随机减去的金额<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
     * 4、晚间发放劵：晚间优惠卷翻倍
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> quota<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 优惠条件：使用优惠卷的最低金额，单位：分
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> threshold<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>`,3),U=t(`<p><code>CouponTemplateInfo </code>类提供了模板的基础描述，并使用了 <code>jakarta.validation-api</code> 中的校验注解确保数据的完整性。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模板信息
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;主键&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@NotNull</span>
  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷模板名称&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@NotNull</span>
  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷模板描述&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@NotNull</span>
  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷模板类型&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;店铺id&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@NotNull</span>
  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷模板规则&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">TemplateRule</span> templateRule<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;是否可用&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Boolean</span> available<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr>`,3),Q=t(`<blockquote><p>此外，模块中还包括了如分页查询和搜索优惠券模板所需的参数类等。这些类进一步增强了服务的功能。</p></blockquote><p>生成的优惠券则使用另一个对象 <code>CouponInfo</code> 来封装。<code>CouponInfo</code> 对象包含了优惠券的模板信息、领券用户ID、适用门店 ID 等关键属性：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷信息（基于 <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CouponTemplateInfo</span></span><span class="token punctuation">}</span> 生成）
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponInfo</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;主键&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷模板ID&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> templateId<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;用户ID&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;店铺ID&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷状态&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷模板信息&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">CouponTemplateInfo</span> templateInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分页查询优惠券模板信息参数：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 分页查询优惠卷模板
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PagedCouponTemplateInfo</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;优惠卷模板列表&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplateInfo</span><span class="token punctuation">&gt;</span></span> couponTemplateInfoList<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;当前页&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> page<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span><span class="token string">&quot;总页数&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">long</span> total<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>优惠券模板搜索参数：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模版查询参数
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemplateSearchParams</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;优惠卷ID&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;优惠卷名称&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;优惠卷类型&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;门店ID&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;是否可用&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">Boolean</span> available<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;页码&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> page<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;每页大小&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>coupon-template-api </code> 模块为我们提供了标准化的数据交换格式，使得其他服务能够基于这些格式构建自己的逻辑。随着模块的进一步丰富，它将成为保证微服务间通信一致性和减轻耦合的关键。</p><p>在完成 <code>coupon-template-api</code> 模块后，我们接下来将聚焦于 <code>coupon-template-dao</code> 模块，这个模块负责实现数据访问逻辑，包括与数据库的交互和数据持久化。</p><h3 id="_2-5-搭建-coupon-template-dao-模块" tabindex="-1"><a class="header-anchor" href="#_2-5-搭建-coupon-template-dao-模块" aria-hidden="true">#</a> 2.5 搭建 coupon-template-dao 模块</h3><h4 id="_2-5-1-依赖配置" tabindex="-1"><a class="header-anchor" href="#_2-5-1-依赖配置" aria-hidden="true">#</a> 2.5.1 依赖配置</h4><p>在动手实现 <code>coupon-template-dao </code>模块前，确认已经添加了以下关键依赖项至 <code>pom.xml</code> 文件：</p><ul><li><strong>coupon-template-api</strong>: 引入该模块以使用 API 层定义的公共类。</li><li><strong>spring-boot-starter-data-jpa</strong>: 利用 Spring Data JPA 简化数据持久化操作。</li><li><strong>mysql-connector-java</strong>: 确保所用 MySQL 驱动与数据库版本兼容。</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--
        持久层（Persistence Layer）是应用程序中的一个模块，负责管理和存储数据。在实际情况下，持久层不应该直接依赖于 API 层
        （Application Programming Interface Layer），因为这两层的功能分离应该是相对独立的。然而，为了简化示例，这里假设
        持久层直接依赖于 API 层的 POJO 类（Plain Old Java Object，简单的 Java 对象）。

        在实际开发中，持久层应该定义自己的 DTO（Data Transfer Object），即数据传输对象。上层模块可以通过转换器（converter）将
        API 层的 POJO 类转换成适合持久层使用的 DTO。这样做的好处是，持久层的 DTO 可以灵活修改，而不会影响到 API 层的 POJO 类。
        因为 API 层的 POJO 类是应用程序的外部接口，不应该频繁修改。

        总之，在实际开发中，持久层应该与 API 层解耦合，并且通过自定义 DTO 进行数据传输。这样做可以提高应用程序的灵活性和可维护性。
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Spring Data JPA --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Spring Boot Validation --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-validation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- MySQL --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.0.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-5-2-实体定义" tabindex="-1"><a class="header-anchor" href="#_2-5-2-实体定义" aria-hidden="true">#</a> 2.5.2 实体定义</h4><p>在 <code>cn.javgo.template.dao.model</code> 包下创建 <code>CouponTemplate</code> 类，该类表示数据库中 <code>coupon_template</code> 表的实体。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模版实体
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span> <span class="token comment">// 实体</span>
<span class="token annotation punctuation">@EntityListeners</span><span class="token punctuation">(</span><span class="token class-name">AuditingEntityListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 审计</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;coupon_template&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 表名</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponTemplate</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span><span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Convert</span><span class="token punctuation">(</span>converter <span class="token operator">=</span> <span class="token class-name">CouponTypeConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponType</span> category<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;rule&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Convert</span><span class="token punctuation">(</span>converter <span class="token operator">=</span> <span class="token class-name">RuleConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">TemplateRule</span> templateRule<span class="token punctuation">;</span>

    <span class="token comment">// 如果为空，则表示全店通用优惠卷</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;shop_id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;available&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> available<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@CreatedDate</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;created_time&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createdTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 JPA 注解可以将类属性映射到数据库表字段，以下是一些核心注解及其作用的概述：</p><table><thead><tr><th>注解</th><th>描述</th></tr></thead><tbody><tr><td>@Entity</td><td>指明该类为实体类，它将映射到数据库表。</td></tr><tr><td>@Table</td><td>明确指出实体对应于数据库中的哪个表。</td></tr><tr><td>@ID</td><td>标记一个字段作为唯一的主键。</td></tr><tr><td>@GeneratedValue</td><td>指定主键生成策略，如自增。</td></tr><tr><td>@Column</td><td>将实体的属性映射到表的特定列，并可定义列的特性（如非空）。</td></tr><tr><td>@CreatedDate</td><td>自动记录实体创建的时间。</td></tr><tr><td>@Convert</td><td>当数据库字段与实体属性不是直接映射关系时，使用该注解指定一个实现了 <code>AttributeConverter&lt;X,Y&gt;</code> 接口的转换器。</td></tr></tbody></table><blockquote><p>⚠️ 注意：</p><p>尽管 JPA 提供了强大的关系映射功能（如 @ManyToOne 和 @OneToOne），在高并发场景下过度使用这些关系可能会影响性能，由于可能导致复杂的 SQL 语句和大量的数据库操作。推荐在实际开发中尽可能避免级联查询，通过业务逻辑重构或查询优化来减轻数据库负担。</p></blockquote><p>在需要将特定的数据库列值转换为 Java 对象时，定义相应的 <code>AttributeConverter</code> 实现类即可：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷类型转换器
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponTypeConverter</span> <span class="token keyword">implements</span> <span class="token class-name">AttributeConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponType</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">convertToDatabaseColumn</span><span class="token punctuation">(</span><span class="token class-name">CouponType</span> attribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> attribute<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponType</span> <span class="token function">convertToEntityAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CouponType</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>dbData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-5-3-数据访问对象-dao" tabindex="-1"><a class="header-anchor" href="#_2-5-3-数据访问对象-dao" aria-hidden="true">#</a> 2.5.3 数据访问对象（DAO）</h4><p>为了与数据库交互，我们将定义 DAO 接口。例如，<code>CouponTemplateDAO </code>可以通过继承 <code>JpaRepository</code> 接口，提供对 <code>CouponTemplate</code> 实体的 CRUD 操作。通过这种方式，我们避免了编写大量的 SQL 语句，同时 Spring Data JPA 提供的方法已经足够应对大多数数据访问需求。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模版 Dao ( 第一个泛型：实体类，第二个泛型：主键类型 )
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponTemplateDao</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 根据店铺id查询优惠卷模版
     *
     * <span class="token keyword">@param</span> <span class="token parameter">shopId</span> 店铺id
     * <span class="token keyword">@return</span> 优惠卷模版列表
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllByShopId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> shopId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 根据给定的id列表和分页信息，查找所有的优惠券模板
     *
     * <span class="token keyword">@param</span> <span class="token parameter">ids</span>      优惠券id列表
     * <span class="token keyword">@param</span> <span class="token parameter">pageable</span> 分页信息
     * <span class="token keyword">@return</span> 包含匹配的优惠券模板的分页对象
     */</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllByIdIn</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 根据商店ID和可用状态计数
     *
     * <span class="token keyword">@param</span> <span class="token parameter">shopId</span>    商店ID
     * <span class="token keyword">@param</span> <span class="token parameter">available</span> 可用状态
     * <span class="token keyword">@return</span> 计数
     */</span>
    <span class="token class-name">Integer</span> <span class="token function">countByShopIdAndAvailable</span><span class="token punctuation">(</span><span class="token class-name">Long</span> shopId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> available<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 将优惠券模板设置为不可用
     *
     * <span class="token keyword">@return</span> 更新成功时返回修改的行数
     * @Modifying 表示该注解用于修改数据库中的数据
     * @Query 表示该注解用于执行一个 JPA 查询语句
     */</span>
    <span class="token annotation punctuation">@Modifying</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;update CouponTemplate c set c.available = 0 where c.id = :id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">makeCouponUnavailable</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>coupon-template-dao</code> 模块中，您可能好奇如何实现增加、删除和修改功能，因为代码示例中主要展示了查询操作。实际上，这些基础的数据库操作方法都隐含在 <code>CouponTemplateDao</code> 继承的 <code>JpaRepository</code> 接口内。</p><p><code>JpaRepository </code>接口是 Spring Data JPA 的心脏，它提供了包括：</p><ul><li><code>save()</code>: 添加或更新数据</li><li><code>delete()</code>: 删除数据</li><li><code>findOne()</code>, <code>findAll()</code>: 查询数据</li></ul><p>等等一系列标准的数据操作方法。</p><p>除了基本的 CRUD 功能，<code>JpaRepository </code>还提供了多样化的查询方式，例如：</p><ul><li><strong>基于方法名称的查询</strong>：可以通过在接口方法中声明查询条件的方式来构建查询。</li><li><strong>基于 Example 的查询</strong>：使用一个实体对象作为查询模板。</li><li><strong>自定义查询</strong>：通过 <code>@Query</code> 注解来定义 SQL 或 JPQL 查询语句。</li></ul><p>例如，使用基于方法名称的查询方式可以这样定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAllByShopId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> shopId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 Spring Data JPA 中，这种查询方式的优势在于其 &quot;<strong>约定优于配置</strong>&quot; 的设计理念，简化了查询操作。你只需要按规则构造方法名称，框架就能为你生成 SQL。</p><p>但需遵守命名规则，包括：</p><ul><li><strong>起始词</strong>（如<code>find</code>、<code>count</code>）</li><li><strong>属性名称</strong>（需与实体属性匹配）</li><li><strong>连接词</strong>（如<code>And</code>、<code>Or</code>）</li></ul><p>基于方法名称的查询在简单场景下易于使用，但可能难以应对复杂查询。对于更复杂的查询，我们可以使用 <code>@Query</code> 注解来自定义 SQL 语句，如：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;update CouponTemplate c set c.available = false where c.id = :id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">makeCouponUnavailable</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>或者采用 Example 查询，创建一个查询模板实例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">CouponTemplate</span> couponTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CouponTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
couponTemplate<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券名称&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> templateDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过这种方式，我们可以根据模板对象的属性进行查询。</p><p>OK，有了 API 和 Dao 层的基础，下一步我们将进入业务逻辑层的开发，即 <code>coupon-template-impl</code> 模块。在这一层中，我们会利用已经搭建好的结构来实现具体的业务功能。</p><h3 id="_2-6-搭建-coupon-template-impl-模块" tabindex="-1"><a class="header-anchor" href="#_2-6-搭建-coupon-template-impl-模块" aria-hidden="true">#</a> 2.6 搭建 coupon-template-impl 模块</h3><h4 id="_2-6-1-依赖配置" tabindex="-1"><a class="header-anchor" href="#_2-6-1-依赖配置" aria-hidden="true">#</a> 2.6.1 依赖配置</h4><p>当我们开始搭建 <code>coupon-template-impl</code> 模块时，我们将其定义为实现业务逻辑的核心。它将依赖于之前构建的 <code>coupon-template-api</code> 和 <code>coupon-template-dao</code> 模块，同时，还会引入一些外部依赖来增强功能。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- API 模块 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- DAO 模块 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-dao<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Alibaba FastJson --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Spring Boot Web --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Apache Commons Codec --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Google Guava --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Spring Boot Actuator 对微服务端点进行管理和配置监控 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-6-2-定义-service-层接口" tabindex="-1"><a class="header-anchor" href="#_2-6-2-定义-service-层接口" aria-hidden="true">#</a> 2.6.2 定义 Service 层接口</h4><p>首先，定义 <code>CouponTemplateService</code> 接口是关键，这个接口会规定了几个主要方法：</p><ul><li>创建优惠券模板</li><li>查询优惠券模板</li><li>修改优惠券模板状态</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模版服务接口
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponTemplateService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 创建优惠券模板
     *
     * <span class="token keyword">@param</span> <span class="token parameter">couponTemplateInfo</span> 优惠券模板信息
     * <span class="token keyword">@return</span> 创建的优惠券模板信息
     */</span>
    <span class="token class-name">CouponTemplateInfo</span> <span class="token function">createCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">CouponTemplateInfo</span> couponTemplateInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 克隆优惠券模板
     *
     * <span class="token keyword">@param</span> <span class="token parameter">templateId</span> 模板ID
     * <span class="token keyword">@return</span> 克隆的优惠券模板信息
     */</span>
    <span class="token class-name">CouponTemplateInfo</span> <span class="token function">cloneCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> templateId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 搜索优惠券模板
     *
     * <span class="token keyword">@param</span> <span class="token parameter">templateSearchParams</span> 搜索参数
     * <span class="token keyword">@return</span> 搜索到的优惠券模板信息
     */</span>
    <span class="token class-name">PagedCouponTemplateInfo</span> <span class="token function">searchCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">TemplateSearchParams</span> templateSearchParams<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 加载优惠券模板
     *
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 模板ID
     * <span class="token keyword">@return</span> 加载的优惠券模板信息
     */</span>
    <span class="token class-name">CouponTemplateInfo</span> <span class="token function">loadCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 删除优惠券模板
     *
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 模板ID
     */</span>
    <span class="token keyword">void</span> <span class="token function">deleteCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 根据模板ID列表获取优惠券模板Map
     *
     * <span class="token keyword">@param</span> <span class="token parameter">ids</span> 模板ID列表
     * <span class="token keyword">@return</span> 优惠券模板Map
     */</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">CouponTemplateInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCouponTemplateMap</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-6-3-实现-service-层逻辑" tabindex="-1"><a class="header-anchor" href="#_2-6-3-实现-service-层逻辑" aria-hidden="true">#</a> 2.6.3 实现 Service 层逻辑</h4><p><code>CouponTemplateServiceImpl </code>类将实现上述接口中定义的方法。通过与 <code>CouponTemplateDao</code> 交互，Service 层能够实现对优惠券模板的 CRUD 操作。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模板服务实现
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponTemplateServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CouponTemplateService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponTemplateDao</span> couponTemplateDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token function">createCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">CouponTemplateInfo</span> couponTemplateInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 单个商户最多可以创建 100 张优惠卷模版</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Integer</span> count <span class="token operator">=</span> couponTemplateDao<span class="token punctuation">.</span><span class="token function">countByShopIdAndAvailable</span><span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;该店铺优惠卷模板数量超过100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;该店铺优惠卷模板数量超过100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">CouponTemplate</span> couponTemplate <span class="token operator">=</span> <span class="token class-name">CouponTemplate</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">templateRule</span><span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getTemplateRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">shopId</span><span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">category</span><span class="token punctuation">(</span><span class="token class-name">CouponType</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>couponTemplateInfo<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CouponTemplate</span> template <span class="token operator">=</span> couponTemplateDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CouponTemplateConverter</span><span class="token punctuation">.</span><span class="token function">converterTemplateInfo</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token function">cloneCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> templateId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;cloneCouponTemplate templateId: {}&quot;</span><span class="token punctuation">,</span> templateId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 准备拷贝源和目标对象</span>
        <span class="token class-name">CouponTemplate</span> source <span class="token operator">=</span> couponTemplateDao<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>templateId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;无效的优惠卷模版ID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CouponTemplate</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CouponTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 浅拷贝</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 其他数据处理</span>
        target<span class="token punctuation">.</span><span class="token function">setAvailable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 存储并返回</span>
        couponTemplateDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CouponTemplateConverter</span><span class="token punctuation">.</span><span class="token function">converterTemplateInfo</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PagedCouponTemplateInfo</span> <span class="token function">searchCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">TemplateSearchParams</span> templateSearchParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建 JPA Example 查询条件</span>
        <span class="token class-name">CouponTemplate</span> example <span class="token operator">=</span> <span class="token class-name">CouponTemplate</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">shopId</span><span class="token punctuation">(</span>templateSearchParams<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">category</span><span class="token punctuation">(</span><span class="token class-name">CouponType</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>templateSearchParams<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>templateSearchParams<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span>templateSearchParams<span class="token punctuation">.</span><span class="token function">getAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 封装分页查询参数</span>
        <span class="token class-name">PageRequest</span> pageRequest <span class="token operator">=</span> <span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>templateSearchParams<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> templateSearchParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> couponTemplateDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">,</span> pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplateInfo</span><span class="token punctuation">&gt;</span></span> couponTemplateInfoList <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CouponTemplateConverter</span><span class="token operator">::</span><span class="token function">converterTemplateInfo</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">PagedCouponTemplateInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">couponTemplateInfoList</span><span class="token punctuation">(</span>couponTemplateInfoList<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>templateSearchParams<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getTotalElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token function">loadCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">&gt;</span></span> couponTemplate <span class="token operator">=</span> couponTemplateDao<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponTemplate<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CouponTemplateConverter</span><span class="token operator">::</span><span class="token function">converterTemplateInfo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteCouponTemplate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> rows <span class="token operator">=</span> couponTemplateDao<span class="token punctuation">.</span><span class="token function">makeCouponUnavailable</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;无效的优惠卷模版ID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">CouponTemplateInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCouponTemplateMap</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponTemplate</span><span class="token punctuation">&gt;</span></span> couponTemplateList <span class="token operator">=</span> couponTemplateDao<span class="token punctuation">.</span><span class="token function">findAllById</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponTemplateList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CouponTemplateConverter</span><span class="token operator">::</span><span class="token function">converterTemplateInfo</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">CouponTemplateInfo</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-6-4-转换类的使用" tabindex="-1"><a class="header-anchor" href="#_2-6-4-转换类的使用" aria-hidden="true">#</a> 2.6.4 转换类的使用</h4><p>在实现过程中，可能会使用到各种转换类（DTOs、VOs等）来在不同层（Controller、Service、DAO）间传输数据。这些转换类通常负责将数据库实体转换为客户端可以使用的数据模型，或者反之。</p><p>涉及到的转换类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模板转换器
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponTemplateConverter</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token function">converterTemplateInfo</span><span class="token punctuation">(</span><span class="token class-name">CouponTemplate</span> couponTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CouponTemplateInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">.</span><span class="token function">getCategory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">shopId</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">templateRule</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">.</span><span class="token function">getTemplateRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span>couponTemplate<span class="token punctuation">.</span><span class="token function">getAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-6-5-构建-controller" tabindex="-1"><a class="header-anchor" href="#_2-6-5-构建-controller" aria-hidden="true">#</a> 2.6.5 构建 Controller</h4><p>接着，创建 <code>CouponTemplateController</code> 类来提供 RESTful 服务。通过使用 Spring MVC 的注解，我们可以轻松地将后端服务以 API 的形式提供给客户端或前端。</p><p>控制器通常使用以下注解：</p><table><thead><tr><th>注解</th><th>描述</th></tr></thead><tbody><tr><td>@RestController</td><td>声明这是一个控制器，并将其加载到 Spring 上下文中。</td></tr><tr><td>@RequestMapping</td><td>定义类级别的路由信息。</td></tr><tr><td>@PostMapping/@GetMapping/@PutMapping</td><td>定义具体的 HTTP 操作和路由。</td></tr></tbody></table><p>以下是其核心代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷模板控制器
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/template&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponTemplateController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponTemplateService</span> couponTemplateService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addTemplate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token function">addTemplate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CouponTemplateInfo</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Create coupon template: data={}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponTemplateService<span class="token punctuation">.</span><span class="token function">createCouponTemplate</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cloneTemplate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token function">cloneTemplate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> templateId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Clone coupon template: data={}&quot;</span><span class="token punctuation">,</span> templateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponTemplateService<span class="token punctuation">.</span><span class="token function">cloneCouponTemplate</span><span class="token punctuation">(</span>templateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getTemplate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponTemplateInfo</span> <span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Load template, id={}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponTemplateService<span class="token punctuation">.</span><span class="token function">loadCouponTemplate</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getBatch&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">CouponTemplateInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTemplateInBatch</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;getTemplateInBatch: {}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponTemplateService<span class="token punctuation">.</span><span class="token function">getCouponTemplateMap</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">PagedCouponTemplateInfo</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">TemplateSearchParams</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;search templates, payload={}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> couponTemplateService<span class="token punctuation">.</span><span class="token function">searchCouponTemplate</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/deleteTemplate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteTemplate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Load template, id={}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        couponTemplateService<span class="token punctuation">.</span><span class="token function">deleteCouponTemplate</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-6-6-启动类的创建" tabindex="-1"><a class="header-anchor" href="#_2-6-6-启动类的创建" aria-hidden="true">#</a> 2.6.6 启动类的创建</h4><p>最后，我们创建了<code>Application</code>类，这是整个应用的入口点。<code>@SpringBootApplication</code> 注解将触发 Spring Boot 的自动配置机制。</p><p>这个注解还负责扫描启动类所在包及其子包中的组件，并在 Spring 上下文中自动注册它们。如果需要包含其他路径下的组件，<code>@ComponentScan </code>注解可以帮助我们指定那些路径。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableJpaAuditing</span> <span class="token comment">// 启用 JPA 的审计功能</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;cn.javgo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-6-7-配置文件" tabindex="-1"><a class="header-anchor" href="#_2-6-7-配置文件" aria-hidden="true">#</a> 2.6.7 配置文件</h4><p>完成代码编写后，接下来的步骤是创建和配置 <code>.properties </code>文件。这个配置文件在 <code>src/main/resources</code> 目录下是项目的关键部分，因为它包含了连接数据库和各种服务的必要参数。</p><p>配置文件的撰写不仅需要精确，还需要考虑到可读性和未来的可维护性。以下是一些推荐的最佳实践：</p><ul><li>使用清晰的注释来描述每个配置项的作用，特别是那些不常见或容易引起混淆的参数。</li><li>为了保证在不同环境下的兼容性，例如开发环境、测试环境和生产环境，可以采用 <code>application-{profile}.properties</code> 的方式来管理不同的配置。</li><li>对于 JDBC 连接字符串，确保其格式和参数与你使用的数据库版本兼容。如果使用 MySQL 8.x，不要忘记包括如 <code>serverTimezone</code> 的必要参数。</li><li>鉴于安全考虑，敏感信息（比如数据库密码、API 密钥等）不应该直接硬编码在配置文件中。考虑使用环境变量或加密工具来管理这些敏感数据。</li></ul><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 服务器端口</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">20000</span>

<span class="token comment"># 是否在错误信息中包含消息</span>
<span class="token key attr-name">server.error.include-message</span><span class="token punctuation">=</span><span class="token value attr-value">always</span>

<span class="token comment"># 应用名称</span>
<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">coupon-template-serv</span>

<span class="token comment"># 数据库驱动类名</span>
<span class="token key attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment"># 数据库连接URL</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/coupon_db?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;zeroDateTimeBehavior=convertToNull&amp;serverTimezone=UTC</span>
<span class="token comment"># 数据库用户名</span>
<span class="token key attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token comment"># 数据库密码</span>
<span class="token key attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>

<span class="token comment"># 数据源类型</span>
<span class="token key attr-name">spring.datasource.type</span><span class="token punctuation">=</span><span class="token value attr-value">com.zaxxer.hikari.HikariDataSource</span>
<span class="token comment"># 数据源连接池名称</span>
<span class="token key attr-name">spring.datasource.hikari.pool-name</span><span class="token punctuation">=</span><span class="token value attr-value">CouponHikari</span>
<span class="token comment"># 连接超时时间</span>
<span class="token key attr-name">spring.datasource.hikari.connection-timeout</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span>
<span class="token comment"># 空闲超时时间</span>
<span class="token key attr-name">spring.datasource.hikari.idle-timeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span>
<span class="token comment"># 最大连接池大小</span>
<span class="token key attr-name">spring.datasource.hikari.maximum-pool-size</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token comment"># 最小连接池大小</span>
<span class="token key attr-name">spring.datasource.hikari.minimum-idle</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token comment"># 连接生命周期</span>
<span class="token key attr-name">spring.datasource.hikari.max-lifetime</span><span class="token punctuation">=</span><span class="token value attr-value">60000</span>
<span class="token comment"># 自动提交</span>
<span class="token key attr-name">spring.datasource.hikari.auto-commit</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>

<span class="token comment"># 是否显示 Hibernate SQL 语句</span>
<span class="token key attr-name">spring.jpa.show-sql</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># JPA 生成DDL的方式</span>
<span class="token key attr-name">spring.jpa.hibernate.ddl-auto</span><span class="token punctuation">=</span><span class="token value attr-value">none</span>
<span class="token comment"># Hibernate SQL 语句格式化</span>
<span class="token key attr-name">spring.jpa.properties.hibernate.format_sql</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># Hibernate SQL 语句显示</span>
<span class="token key attr-name">spring.jpa.properties.hibernate.show_sql</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># 是否在视图中打开 JPA 连接</span>
<span class="token key attr-name">spring.jpa.open-in-view</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>

<span class="token comment"># 日志级别</span>
<span class="token key attr-name">logging.level.cn.javgo.coupon</span><span class="token punctuation">=</span><span class="token value attr-value">debug</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，我们的优惠券平台的首个模块 <code>coupon-template-serv</code> 已经构建完成。你可以在本地启动项目，并使用 Postman 工具进行测试。你也可以自行加入 Swagger：</p><figure><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-17-134423.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_2-6-8-模块小结" tabindex="-1"><a class="header-anchor" href="#_2-6-8-模块小结" aria-hidden="true">#</a> 2.6.8 模块小结</h4><p>在本模块中，我们完成了 <code>coupon-template-serv</code> 的搭建，这是优惠券平台的一个重要组成部分。我们展示了如何有效利用 Spring Boot 的功能，简化了服务的实现，并介绍了如何通过 Spring Data JPA 高效地操作数据库。</p><p>关键技术点回顾：</p><ul><li>使用 <code>spring-data-jpa</code> 进行数据库操作，实现了 CRUD 功能，并通过它体验到了 Spring 的 “约定优于配置” 的理念。</li><li>强调了代码的防御性编程、自动化生成、和精确的金额计算等编码技巧。</li><li>探讨了数据校验的简化方法和避免级联关系的常见陷阱。</li></ul><p>通过以上的探索和学习，你现在应该对构建一个模块化、可扩展的 Spring Boot 应用有了深入的理解。下一步，我们将继续搭建<code>coupon-calculation-serv</code> 和 <code>coupon-customer-serv</code> 模块，进一步扩展我们的优惠券平台。</p><h2 id="_3-搭建优惠券计算服务" tabindex="-1"><a class="header-anchor" href="#_3-搭建优惠券计算服务" aria-hidden="true">#</a> 3.搭建优惠券计算服务</h2><p>通过前面的章节，我们已经完成了优惠券模板服务 <code>coupon-template-serv</code> 的搭建，并对 Spring Boot 有了更深层次的理解。接下来，我们将深入开发优惠券系统的两个关键组件：<code>coupon-calculation-serv</code>（负责优惠计算）和<code>coupon-customer-serv</code>（向用户提供服务）。在这一过程中，中间件模块 <code>middleware</code> 的详细探讨将放在涉及 Spring Cloud 的部分进行。</p><p>我们的第一步是建立 <code>coupon-calculation-serv</code>，一个专注于为订单提供优惠计算的服务接口。<code>coupon-calculation-serv</code> 作为典型的计算密集型服务，其主要特点包括：</p><ol><li>不受网络 I/O 和磁盘空间限制；</li><li>在运行时主要消耗 CPU 和内存等计算资源。</li></ol><p>在构建大型应用的过程中，我们通常会把<strong>计算密集型服务和 I/O 或存储密集型服务分离</strong>开，这样做的目的是优化资源使用效率。以一个实际的例子来说明，假设我们同时运行一个计算密集型的微服务 A 和一个 I/O 密集型的微服务 B。在高流量时，我们可以为服务 A 分配更多的 CPU 和内存资源来应对压力；对于服务 B，则可以增加云存储资源。这样 “<strong>按需分配</strong>” 的策略能够有效地提高资源使用率。</p><p>如果我们将服务 A 和 B 合并在一起，就会失去对资源分配的精确控制，全链路压力测试也无法准确评估性能指标，从而可能造成资源的浪费。因此，我建议将优惠计算服务独立出来，以实现更合理的资源配置。</p><p>现在让我们着手构建 <code>coupon-calculation-serv</code>。它将包含多个子模块，类似于 <code>coupon-template-serv</code> 的结构，包括 API 层和业务逻辑层。API 层负责定义公共的 POJO 类，而业务逻辑层则专注于优惠计算逻辑的实现。由于优惠计算服务不涉及数据库操作，我们将不包含 DAO 模块。</p><p>我们首先从 <code>coupon-calculation-api</code> 子模块入手，这是整个服务的接口层。</p><h3 id="_3-1-搭建-coupon-calculation-api-模块" tabindex="-1"><a class="header-anchor" href="#_3-1-搭建-coupon-calculation-api-模块" aria-hidden="true">#</a> 3.1 搭建 coupon-calculation-api 模块</h3><p>为了使 <code>coupon-calculation-serv</code> 能够计算订单的优惠价格，它需要知道当前订单使用了哪些优惠券。因此，我们首先需要引入封装优惠券信息的 Java 类<code>CouponInfo</code>，该类位于 <code>coupon-template-api</code> 包中。为此，我们在 <code>coupon-calculation-api</code> 中添加 <code>coupon-template-api</code> 的依赖项。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>依赖项添加完毕后，我们继续定义用于封装订单信息的 <code>ShoppingCart </code>类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 封装订单信息
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShoppingCart</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 商品信息
     */</span>
    <span class="token annotation punctuation">@NotEmpty</span>
    <span class="token keyword">private</span> <span class="token class-name">Product</span> product<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 优惠券ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> couponId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单总价
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> cost<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 优惠券信息列表
     * 说明：目前仅支持单张优惠券，但是为了以后的扩展考虑，你可以添加多个优惠券的计算逻辑
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponInfo</span><span class="token punctuation">&gt;</span></span> couponInfos<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 用户ID
     */</span>
    <span class="token annotation punctuation">@NotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上述代码中，我们可以看到 <code>ShoppingCart</code> 订单类使用了 <code>Product</code> 对象来封装当前订单的商品列表。<code>Product</code> 类中包含了商品的单价、数量以及门店ID。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 封装商品信息
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 你可以试着搭建一个商品中心，用来存储商品信息，逐步完善这个应用
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> productId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 商品的价格
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> price<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 商品在购物车里的数量
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 商品销售的门店
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在电商行业，商品数量通常不仅仅是整数。例如，对于蔬菜或肉类这样的非标准商品，它们的计量单位可能不是 “个”。因此，在实际的项目中，特别是零售业务系统中，计量单位应该允许小数。但为了简化本项目，我们假设所有商品都是标准商品。</p></blockquote><p>在下单时，可能有多张优惠券可供选择。为了确定哪张优惠券提供的折扣最大，你需要进行 “<strong>价格试算</strong>” 来模拟计算每张优惠券的折扣金额。<code>SimulationOrder</code> 和 <code>SimulationResponse</code> 分别代表了 “价格试算” 的订单类和返回的计算结果。接下来，我们来看这两个类的代码。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 封装模拟订单信息：用于试算最优的优惠券
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimulationOrder</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 商品信息列表
     */</span>
    <span class="token annotation punctuation">@NotEmpty</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> products<span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * 优惠券ID列表
     */</span>
    <span class="token annotation punctuation">@NotEmpty</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> couponIDs<span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * 优惠券信息列表
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponInfo</span><span class="token punctuation">&gt;</span></span> couponInfos<span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * 用户ID
     */</span>
    <span class="token annotation punctuation">@NotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 封装模拟计算结果
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimulationResponse</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 最省钱的优惠卷 ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> bestCouponId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 每一个优惠卷对应的订单价格
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> couponToOrderPrice <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，<code>coupon-calculation-api </code>模块的搭建已经完成。由于计算服务不需要访问数据库，我们可以跳过 dao 模块的搭建，直接进入 <code>coupon-calculation-impl</code> 业务层的代码实现。</p><h3 id="_3-2-搭建-coupon-calculation-impl-模块" tabindex="-1"><a class="header-anchor" href="#_3-2-搭建-coupon-calculation-impl-模块" aria-hidden="true">#</a> 3.2 搭建 coupon-calculation-impl 模块</h3><h4 id="_3-2-1-依赖配置" tabindex="-1"><a class="header-anchor" href="#_3-2-1-依赖配置" aria-hidden="true">#</a> 3.2.1 依赖配置</h4><p>在实现 <code>coupon-calculation-impl</code> 模块之前，我们需要在其 <code>pom.xml </code>中明确加入三个核心依赖。这些依赖项，尤其是 <code>coupon-template-api</code> 和 <code>coupon-calculation-api</code>，将为我们提供完成订单优惠计算所需的 POJO 对象。这是构建优惠计算逻辑的基础。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-calculation-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-2-模版设计模式分析" tabindex="-1"><a class="header-anchor" href="#_3-2-2-模版设计模式分析" aria-hidden="true">#</a> 3.2.2 模版设计模式分析</h4><p>为了优雅地实现优惠计算逻辑，我选择了<strong>模板设计模式</strong>。该模式通过抽象类定义算法的框架，将具体实现留给子类完成。鉴于优惠券类型的多样性（如满减、折扣、随机立减等），它们的计算流程具有共性，但每个的计算细节各不相同，模板设计模式为处理这一问题提供了完美解决方案。</p><p>以下是我们的计算逻辑类结构图：</p><img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-11-04-134259.png" style="zoom:50%;"><p>在此结构中，<code>RuleTemplate </code> 顶层接口定义了 <code>calculate</code> 方法用于计算优惠券：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 模版模式：优惠券计算规则接口
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RuleTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算购物车金额
     *
     * <span class="token keyword">@param</span> <span class="token parameter">shoppingCart</span> 购物车对象
     * <span class="token keyword">@return</span> 计算后的购物车金额
     */</span>
    <span class="token class-name">ShoppingCart</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> shoppingCart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们设计了一个 <code>AbstractRuleTemplate</code> 抽象类封装通用逻辑，并为不同类型的优惠券各提供一个具体子类来实现其独有的计算逻辑。<code>AbstractRuleTemplate </code>类提供了一个 <code>calculate</code> 方法的实现框架，并定义了一个待子类实现的 <code>calculateNewPrice</code> 抽象方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 模版抽象类：实现通用优惠卷计算规则以复用，同时提供抽象方法给子类实现各自的计算规则（设计策略模式）
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/3
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRuleTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">RuleTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算优惠后的购物车价格
     *
     * <span class="token keyword">@param</span> <span class="token parameter">order</span> 购物车订单
     * <span class="token keyword">@return</span> 计算后的购物车订单
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShoppingCart</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计算订单总金额</span>
        <span class="token keyword">long</span> orderTotalAmount <span class="token operator">=</span> <span class="token function">getTotalPrice</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 按店铺分组计算订单总金额</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> orderTotalAmountGroupByShop <span class="token operator">=</span> <span class="token function">getTotalPriceGroupByShop</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取优惠券模板信息</span>
        <span class="token class-name">CouponTemplateInfo</span> templateInfo <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getCouponInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTemplateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取优惠券的最低消费限制</span>
        <span class="token class-name">Long</span> threshold <span class="token operator">=</span> templateInfo<span class="token punctuation">.</span><span class="token function">getTemplateRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDiscount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取优惠券的使用限额</span>
        <span class="token class-name">Long</span> quota <span class="token operator">=</span> templateInfo<span class="token punctuation">.</span><span class="token function">getTemplateRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDiscount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQuota</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取优惠券所属店铺ID</span>
        <span class="token class-name">Long</span> shopId <span class="token operator">=</span> templateInfo<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算店铺总金额（如果shopId为空，则使用订单总金额；否则使用按店铺分组的订单总金额）</span>
        <span class="token class-name">Long</span> shopTotalAmount <span class="token operator">=</span> <span class="token punctuation">(</span>shopId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> orderTotalAmount <span class="token operator">:</span> orderTotalAmountGroupByShop<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>shopId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果店铺总金额小于最低消费限制，不适用优惠券</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopTotalAmount <span class="token operator">&lt;</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;订单总价小于优惠卷的最低消费限制，不适用优惠卷！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setCost</span><span class="token punctuation">(</span>orderTotalAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setCouponInfos</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> order<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 计算新的价格（根据订单总金额、店铺总金额和使用限额）</span>
        <span class="token class-name">Long</span> newCost <span class="token operator">=</span> <span class="token function">calculateNewPrice</span><span class="token punctuation">(</span>orderTotalAmount<span class="token punctuation">,</span> shopTotalAmount<span class="token punctuation">,</span> quota<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果新的价格小于最小成本，设为最小成本（至少 1 分钱）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newCost <span class="token operator">&lt;</span> <span class="token function">minCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newCost <span class="token operator">=</span> <span class="token function">minCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新订单的成本和优惠券信息</span>
        order<span class="token punctuation">.</span><span class="token function">setCost</span><span class="token punctuation">(</span>newCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券计算成功，订单总价：{}，优惠券优惠金额：{}，优惠后订单总价：{}&quot;</span><span class="token punctuation">,</span> orderTotalAmount<span class="token punctuation">,</span> orderTotalAmount <span class="token operator">-</span> newCost<span class="token punctuation">,</span> newCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 计算新的价格（策略模式，留给子类根据不同类型的优惠卷计算规则实现）
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderTotalAmount</span> 订单总金额
     * <span class="token keyword">@param</span> <span class="token parameter">shopTotalAmount</span>  店铺总金额
     * <span class="token keyword">@param</span> <span class="token parameter">quota</span>            使用限额
     * <span class="token keyword">@return</span> 计算后的新价格
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Long</span> <span class="token function">calculateNewPrice</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> shopTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> quota<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 计算订单的总金额
     *
     * <span class="token keyword">@param</span> <span class="token parameter">products</span> 订单产品列表
     * <span class="token keyword">@return</span> 订单的总金额
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> products<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> products<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToLong</span><span class="token punctuation">(</span>product <span class="token operator">-&gt;</span> product<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> product<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 按店铺分组计算订单的总金额
     *
     * <span class="token keyword">@param</span> <span class="token parameter">products</span> 订单产品列表
     * <span class="token keyword">@return</span> 按店铺分组的订单总金额 map
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTotalPriceGroupByShop</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> products<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> products<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
                        <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>
                                <span class="token class-name">Product</span><span class="token operator">::</span><span class="token function">getShopId</span><span class="token punctuation">,</span>
                                <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">summingLong</span><span class="token punctuation">(</span>product <span class="token operator">-&gt;</span> product<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> product<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 获取最小成本
     *
     * <span class="token keyword">@return</span> 最小成本
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">minCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例如，满减规则的实现 <code>MoneyOffTemplate</code> 继承了 <code>AbstractRuleTemplate</code>，只需提供 <code>calculateNewPrice</code> 方法的具体实现即可，这样的设计简洁且减少了代码重复。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷策略：满减
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MoneyOffTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRuleTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">RuleTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算新的价格
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderTotalAmount</span> 订单总金额
     * <span class="token keyword">@param</span> <span class="token parameter">shopTotalAmount</span>  商店总金额
     * <span class="token keyword">@param</span> <span class="token parameter">quota</span>            优惠额度(这里指满减额度）
     * <span class="token keyword">@return</span> 新的价格
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">calculateNewPrice</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> shopTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> quota<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计算优惠额度：取商店总金额和优惠额度的最小值</span>
        <span class="token class-name">Long</span> benefitAmount <span class="token operator">=</span> shopTotalAmount <span class="token operator">&lt;</span> quota <span class="token operator">?</span> shopTotalAmount <span class="token operator">:</span> quota<span class="token punctuation">;</span>
        <span class="token comment">// 计算最终的价格：订单总金额减去优惠额度</span>
        <span class="token keyword">return</span> orderTotalAmount <span class="token operator">-</span> benefitAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面给出其他优惠卷计算模版：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷策略：折扣卷
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscountTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRuleTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">RuleTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算新的价格
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderTotalAmount</span> 订单总金额
     * <span class="token keyword">@param</span> <span class="token parameter">shopTotalAmount</span>  商店总金额
     * <span class="token keyword">@param</span> <span class="token parameter">quota</span>            优惠额度
     * <span class="token keyword">@return</span> 新的价格
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">calculateNewPrice</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> shopTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> quota<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">convertToDecimal</span><span class="token punctuation">(</span>shopTotalAmount<span class="token punctuation">,</span> quota<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 将商店总金额转换为小数，并按比例转换为实际金额
     *
     * <span class="token keyword">@param</span> <span class="token parameter">shopTotalAmount</span> 商店总金额
     * <span class="token keyword">@param</span> <span class="token parameter">quota</span>           比例
     * <span class="token keyword">@return</span> 转换后的小数金额
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token function">convertToDecimal</span><span class="token punctuation">(</span><span class="token class-name">Long</span> shopTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> quota<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">double</span> v <span class="token operator">=</span> shopTotalAmount <span class="token operator">*</span> <span class="token punctuation">(</span>quota<span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷策略：空策略
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DummyTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRuleTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">RuleTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算新的价格
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderTotalAmount</span> 订单总金额
     * <span class="token keyword">@param</span> <span class="token parameter">shopTotalAmount</span>  商店总金额
     * <span class="token keyword">@param</span> <span class="token parameter">quota</span>            优惠额度
     * <span class="token keyword">@return</span> 新的价格
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">calculateNewPrice</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> shopTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> quota<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> orderTotalAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShoppingCart</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        order<span class="token punctuation">.</span><span class="token function">setCost</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷策略：夜间单身狗翻倍卷（22:00 - 02:00）
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LonelyNightTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRuleTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">RuleTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算新的价格
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderTotalAmount</span> 订单总金额
     * <span class="token keyword">@param</span> <span class="token parameter">shopTotalAmount</span>  商店总金额
     * <span class="token keyword">@param</span> <span class="token parameter">quota</span>            优惠额度
     * <span class="token keyword">@return</span> 新的价格
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">calculateNewPrice</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> shopTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> quota<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hourOfDay <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">HOUR_OF_DAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hourOfDay <span class="token operator">&gt;=</span> <span class="token number">22</span> <span class="token operator">||</span> hourOfDay <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            quota <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Long</span> benefitAmount <span class="token operator">=</span> shopTotalAmount <span class="token operator">&lt;</span> quota <span class="token operator">?</span> shopTotalAmount <span class="token operator">:</span> quota<span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderTotalAmount <span class="token operator">-</span> benefitAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷策略：随机立减卷
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomReductionTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRuleTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">RuleTemplate</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算新的价格
     *
     * <span class="token keyword">@param</span> <span class="token parameter">orderTotalAmount</span> 订单总金额
     * <span class="token keyword">@param</span> <span class="token parameter">shopTotalAmount</span>  商店总金额
     * <span class="token keyword">@param</span> <span class="token parameter">quota</span>            优惠额度
     * <span class="token keyword">@return</span> 新的价格
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">calculateNewPrice</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> shopTotalAmount<span class="token punctuation">,</span> <span class="token class-name">Long</span> quota<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计算最大的优惠额度：取商店总金额和优惠额度的最小值</span>
        <span class="token keyword">long</span> maxBenefit <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>shopTotalAmount<span class="token punctuation">,</span> quota<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算优惠额度：随机生成一个整数，范围为 0 ~ maxBenefit-1</span>
        <span class="token keyword">int</span> reductionAmount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> maxBenefit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算新的价格：订单总金额减去优惠额度</span>
        <span class="token keyword">return</span> orderTotalAmount <span class="token operator">-</span> reductionAmount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在未来，如果业务拓展新增了更多类型的优惠券，当前的设计允许我们通过添加新的子类或在必要时创建更多层次的抽象类来应对，这样做一方面保持了现有代码的稳定，另一方面又保持了系统的灵活性和可扩展性。</p><h4 id="_3-2-3-service-层" tabindex="-1"><a class="header-anchor" href="#_3-2-3-service-层" aria-hidden="true">#</a> 3.2.3 Service 层</h4><p>接下来的步骤是实现 Service 层。Service 层中的 <code>calculateOrderPrice</code> 方法通过<code>CouponTemplateFactory</code>工厂类来获取具体的计算规则，然后调用 <code>calculate</code> 方法来计算订单的优惠后价格。其中，<code>simulate </code>方法提供了一种试算机制，帮助用户在实际下单前预估各优惠券的折扣金额，以便选择最优惠的选项。</p><p><code>CouponTemplateFactory </code>的设计是根据订单中包含的优惠券信息来返回相应的优惠券模板实例，以便进一步计算。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 工厂模式：用于创建不同类型的优惠券模板
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponTemplateFactory</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">MoneyOffTemplate</span> moneyOffTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscountTemplate</span> discountTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RandomReductionTemplate</span> randomReductionTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">LonelyNightTemplate</span> lonelyNightTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">DummyTemplate</span> dummyTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RuleTemplate</span> <span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getCouponInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> dummyTemplate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">CouponTemplateInfo</span> templateInfo <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getCouponInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTemplateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CouponType</span> couponType <span class="token operator">=</span> <span class="token class-name">CouponType</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>templateInfo<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>couponType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">MONEY_OFF</span><span class="token operator">:</span>
                <span class="token keyword">return</span> moneyOffTemplate<span class="token punctuation">;</span>

            <span class="token keyword">case</span> <span class="token constant">DISCOUNT</span><span class="token operator">:</span>
                <span class="token keyword">return</span> discountTemplate<span class="token punctuation">;</span>

            <span class="token keyword">case</span> <span class="token constant">RANDOM_DISCOUNT</span><span class="token operator">:</span>
                <span class="token keyword">return</span> randomReductionTemplate<span class="token punctuation">;</span>

            <span class="token keyword">case</span> <span class="token constant">LONELY_NIGHT_MONEY_OFF</span><span class="token operator">:</span>
                <span class="token keyword">return</span> lonelyNightTemplate<span class="token punctuation">;</span>

            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> dummyTemplate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 <code>CouponCalculationService</code> 接口以及其具体实现，这样的设计遵循了<strong>开闭原则</strong>，即对修改封闭，对扩展开放，提高了代码的可维护性和可扩展性。</p><p><code>CouponCalculationService</code> 接口用于提供优惠计算的 API 定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷计算服务
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponCalculationService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 计算订单价格
     *
     * <span class="token keyword">@param</span> <span class="token parameter">cart</span> 购物车
     * <span class="token keyword">@return</span> 订单价格
     */</span>
    <span class="token class-name">ShoppingCart</span> <span class="token function">calculateOrderPrice</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> cart<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 优惠试算
     *
     * <span class="token keyword">@param</span> <span class="token parameter">order</span> 订单
     * <span class="token keyword">@return</span> 响应
     */</span>
    <span class="token class-name">SimulationResponse</span> <span class="token function">simulateOrder</span><span class="token punctuation">(</span><span class="token class-name">SimulationOrder</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷计算服务实现
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponCalculationServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CouponCalculationService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponTemplateFactory</span> couponTemplateFactory<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 正常计算
     * <span class="token keyword">@param</span> <span class="token parameter">cart</span> 购物车
     * <span class="token keyword">@return</span> 计算后的购物车
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShoppingCart</span> <span class="token function">calculateOrderPrice</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> cart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;calculateOrderPrice: {}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RuleTemplate</span> ruleTemplate <span class="token operator">=</span> couponTemplateFactory<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ruleTemplate<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 模拟计算
     * <span class="token keyword">@param</span> <span class="token parameter">order</span> 订单
     * <span class="token keyword">@return</span> 模拟计算结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SimulationResponse</span> <span class="token function">simulateOrder</span><span class="token punctuation">(</span><span class="token class-name">SimulationOrder</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建一个模拟响应对象</span>
        <span class="token class-name">SimulationResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimulationResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化最小订单价格为 Long 最大值</span>
        <span class="token class-name">Long</span> minOrderPrice <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历传入的优惠券信息列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CouponInfo</span> couponInfo <span class="token operator">:</span> order<span class="token punctuation">.</span><span class="token function">getCouponInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 创建一个购物车对象</span>
            <span class="token class-name">ShoppingCart</span> shoppingCart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShoppingCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置购物车的产品为传入订单的产品</span>
            shoppingCart<span class="token punctuation">.</span><span class="token function">setProducts</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将优惠券信息添加到购物车中</span>
            shoppingCart<span class="token punctuation">.</span><span class="token function">setCouponInfos</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>couponInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 根据购物车模板计算后的购物车对象（决定使用哪个优惠券，对上层业务透明）</span>
            shoppingCart <span class="token operator">=</span> couponTemplateFactory<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span>shoppingCart<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>shoppingCart<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 获取当前优惠券信息的ID</span>
            <span class="token class-name">Long</span> couponInfoId <span class="token operator">=</span> couponInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取计算后的购物车价格</span>
            <span class="token keyword">long</span> orderPrice <span class="token operator">=</span> shoppingCart<span class="token punctuation">.</span><span class="token function">getCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将优惠券ID和对应的订单价格添加到模拟响应的优惠券到订单价格映射中</span>
            response<span class="token punctuation">.</span><span class="token function">getCouponToOrderPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>couponInfoId<span class="token punctuation">,</span> orderPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果最小订单价格大于当前订单价格</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>minOrderPrice <span class="token operator">&gt;</span> orderPrice<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 设置最佳优惠券ID为当前优惠券信息的ID</span>
                response<span class="token punctuation">.</span><span class="token function">setBestCouponId</span><span class="token punctuation">(</span>couponInfoId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新最小订单价格</span>
                minOrderPrice <span class="token operator">=</span> orderPrice<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-4-controller-层" tabindex="-1"><a class="header-anchor" href="#_3-2-4-controller-层" aria-hidden="true">#</a> 3.2.4 Controller 层</h4><p>完成 Service 层的构建后，我们需要通过创建一个 <code>CouponCalculationController</code> 类来向外界提供接口。这个控制器将暴露至少两个 POST 接口，一个用于完成订单的优惠计算，另一个用于进行优惠券的价格试算。这些接口的实现将依赖于之前构建的 Service 层逻辑。</p><p>这里是一个简化的示例，展示了如何定义这些 REST 接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷计算 Controller
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;calculator&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponCalculationController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponCalculationService</span> calculationService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/checkout&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ShoppingCart</span> <span class="token function">calculateOrderPrice</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ShoppingCart</span> settlement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;do calculation: {}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>settlement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> calculationService<span class="token punctuation">.</span><span class="token function">calculateOrderPrice</span><span class="token punctuation">(</span>settlement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/simulate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SimulationResponse</span> <span class="token function">simulate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SimulationOrder</span> simulator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;do simulation: {}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>simulator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> calculationService<span class="token punctuation">.</span><span class="token function">simulateOrder</span><span class="token punctuation">(</span>simulator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个控制器中，我们注入了 <code>CouponCalculationService</code> 来调用计算和试算的相关方法，并返回结果。</p><h4 id="_3-2-5-启动类" tabindex="-1"><a class="header-anchor" href="#_3-2-5-启动类" aria-hidden="true">#</a> 3.2.5 启动类</h4><p>接着，我们需要创建 <code>Application</code> 类来启动 Spring Boot 应用。这个类通常很简单，包含一个 main 方法和 <code>@SpringBootApplication</code> 注解：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;cn.javgo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>apple<span class="token punctuation">.</span>eawt<span class="token punctuation">.</span></span>Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-6-配置文件" tabindex="-1"><a class="header-anchor" href="#_3-2-6-配置文件" aria-hidden="true">#</a> 3.2.6 配置文件</h4><p>最后，我们需要配置 <code>application.yml</code> 文件，为我们的服务提供必要的配置，如端口号、数据库连接的配置等。</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 服务端口</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">20002</span>
<span class="token comment"># 错误信息是否包含堆栈信息</span>
<span class="token key attr-name">server.error.include-message</span><span class="token punctuation">=</span><span class="token value attr-value">always</span>

<span class="token comment"># 应用名称</span>
<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">coupon-calculation-serv</span>

<span class="token comment"># 日志级别</span>
<span class="token key attr-name">logging.level.cn.javgo.coupon</span><span class="token punctuation">=</span><span class="token value attr-value">debug</span>

<span class="token comment"># 开启 Spring Boot Actuator 的所有端点</span>
<span class="token key attr-name">management.endpoints.web.exposure.include</span><span class="token punctuation">=</span><span class="token value attr-value">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，我们就完成了 <code>coupon-calculation-impl</code> 模块的构建。我们可以通过编写单元测试和集成测试来验证服务的正确性，并使用 Spring Boot 的 Actuator 来监控服务的健康状况和性能。</p><p>下一步，我们将继续前进，构建 <code>coupon-customer-serv</code> 模块，这是优惠券项目的最后一个服务，专门用于与用户交互，比如领取优惠券、查询优惠券等。</p><h2 id="_4-搭建用户服务" tabindex="-1"><a class="header-anchor" href="#_4-搭建用户服务" aria-hidden="true">#</a> 4.搭建用户服务</h2><p>在电子商务系统中，用户优惠券服务（以下简称 “用户服务”）是至关重要的一环。本模块的设计重点在于实现用户与优惠券交互的功能，包括用户领取优惠券、查询持有优惠券以及在订单结算时使用优惠券。类似地，该模块的架构设计参照了优惠券模板服务，也分为 API 层、DAO 层和业务逻辑层。</p><p>为了保持文章的聚焦，我们将不会深入 “用户注册” 等功能，而是假设你已经熟悉用户身份验证的流程，通过 <code>userId</code> 来标识一个经过认证的用户身份。</p><h3 id="_4-1-搭建-coupon-customer-api-模块" tabindex="-1"><a class="header-anchor" href="#_4-1-搭建-coupon-customer-api-模块" aria-hidden="true">#</a> 4.1 搭建 coupon-customer-api 模块</h3><h4 id="_4-1-1-依赖配置" tabindex="-1"><a class="header-anchor" href="#_4-1-1-依赖配置" aria-hidden="true">#</a> 4.1.1 依赖配置</h4><p>在用户服务的 API 层构建中，首先要确保用户服务能够与系统中的其他服务进行交互。具体来说，我们需要在用户服务的项目对象模型（POM）文件中添加优惠券模板服务（coupon-template-api）和优惠券计算服务（coupon-calculation-api）的依赖。这一步确保用户服务能够使用这两个服务提供的请求和响应对象。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-calculation-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-1-2-封装-dto" tabindex="-1"><a class="header-anchor" href="#_4-1-2-封装-dto" aria-hidden="true">#</a> 4.1.2 封装 DTO</h4><p>接下来，我们定义 <code>RequestCoupon</code> 类，用于封装用户领取优惠券时所需提供的信息，这通常包括用户 ID 和优惠券模板 ID。通过这个类，用户可以请求系统为其生成基于指定模板的优惠券。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 用户领取优惠券请求
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestCoupon</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NotNull</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> couponTemplateId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，<code>SearchCoupon</code> 类被定义用于封装查询优惠券请求时的参数。它允许用户根据自己的需要进行优惠券查询，例如，可以根据优惠券的状态进行筛选。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷查询
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchCoupon</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@NotNull</span>
  <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷状态枚举
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">CouponStatus</span> <span class="token punctuation">{</span>

    <span class="token function">AVAILABLE</span><span class="token punctuation">(</span><span class="token string">&quot;未使用&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">USED</span><span class="token punctuation">(</span><span class="token string">&quot;已使用&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">INACTIVE</span><span class="token punctuation">(</span><span class="token string">&quot;已注销&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CouponStatus</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>bean <span class="token operator">-&gt;</span> bean<span class="token punctuation">.</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，我们已经搭建好了用户服务的 API 子模块的基本结构。下一步，我们会进入到数据访问层（DAO），在这一层我们将实现优惠券数据的持久化操作，包括优惠券的存储、检索、更新和删除。</p><h3 id="_4-2-搭建-coupon-customer-dao-模块" tabindex="-1"><a class="header-anchor" href="#_4-2-搭建-coupon-customer-dao-模块" aria-hidden="true">#</a> 4.2 搭建 coupon-customer-dao 模块</h3><h4 id="_4-2-1-数据库映射对象" tabindex="-1"><a class="header-anchor" href="#_4-2-1-数据库映射对象" aria-hidden="true">#</a> 4.2.1 数据库映射对象</h4><p>在用户优惠券服务的数据访问层（DAO 层）的搭建中，核心任务是设计和实现与数据库交互的实体和接口。在这一环节，我定义了 <code>Coupon</code> 实体类，这是一个数据库映射对象，专门用来表示和存储用户所领取的优惠券信息。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@EntityListeners</span><span class="token punctuation">(</span><span class="token class-name">AuditingEntityListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;coupon&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Coupon</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span><span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;template_id&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> templateId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;shop_id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> shopId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Convert</span><span class="token punctuation">(</span>converter <span class="token operator">=</span> <span class="token class-name">CouponStatusConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponStatus</span> status<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transient</span> <span class="token comment">// 标记该字段不参与数据库映射</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponTemplateInfo</span> templateInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@CreatedDate</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;created_time&quot;</span><span class="token punctuation">,</span> nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>针对 <code>Coupon</code> 实体类，我还编写了相应的转换器类，其作用是在不同数据类型的实体属性和表字段进行映射时，能够将数据库实体属性和对应字段进行互相转换，保证数据处理的一致性和准确性。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷状态转换器
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponStatusConverter</span> <span class="token keyword">implements</span> <span class="token class-name">AttributeConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponStatus</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">convertToDatabaseColumn</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span> attribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> attribute<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CouponStatus</span> <span class="token function">convertToEntityAttribute</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> dbData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>dbData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,161),F=s("code",null,"getter",-1),z=s("code",null,"setter",-1),H=s("code",null,"toString",-1),V={href:"https://projectlombok.org/",target:"_blank",rel:"noopener noreferrer"},G=t(`<img src="https://javgo-images.oss-cn-beijing.aliyuncs.com/2023-09-18-061309.png" style="zoom:33%;"><p>此外，我想分享关于 “<strong>数据冗余</strong>” 的设计考量。例如，在 <code>Coupon</code> 实体中，我们决定引入一个冗余字段——Shop ID。虽然该数据可以通过关联的 <code>CouponTemplate</code> 实体获取，但将其直接存储在 <code>Coupon</code> 实体中可以极大提升数据查询效率，这种设计在面向大规模并发的系统时尤为常见。它体现了 “<strong>以空间换时间</strong>” 的策略，即通过增加存储消耗来换取更快的响应速度。</p><h4 id="_4-2-2-持久层" tabindex="-1"><a class="header-anchor" href="#_4-2-2-持久层" aria-hidden="true">#</a> 4.2.2 持久层</h4><p>接下来，创建了 <code>CouponDAO</code> 接口，这是一个遵循 Spring Data JPA 规范的数据访问接口。在这里，我们定义了必要的数据操作方法。例如，一个用于统计优惠券数量的方法。而基于 <code>JpaRepository</code> 提供的标准 CRUD 操作则不需要额外定义，这展示了 Spring Data JPA 框架的便捷性和高效性。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷 DAO
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponDao</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Coupon</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 根据用户ID和模板ID统计数量
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>     用户ID
     * <span class="token keyword">@param</span> <span class="token parameter">templateId</span> 模板ID
     * <span class="token keyword">@return</span> 统计数量
     */</span>
    <span class="token keyword">long</span> <span class="token function">countByUserIdAndTemplateId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> templateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，用户优惠券服务的数据访问层已经搭建完成。我们将继续前进，下一步是进入实现层（impl 层），在那里我们将具体实现业务逻辑。</p><h3 id="_4-3-搭建-coupon-customer-impl-模块" tabindex="-1"><a class="header-anchor" href="#_4-3-搭建-coupon-customer-impl-模块" aria-hidden="true">#</a> 4.3 搭建 coupon-customer-impl 模块</h3><p>在本节中，我们将详述用户优惠券服务的业务逻辑层——<code>coupon-customer-impl</code>模块的构建。</p><h4 id="_4-3-1-依赖配置" tabindex="-1"><a class="header-anchor" href="#_4-3-1-依赖配置" aria-hidden="true">#</a> 4.3.1 依赖配置</h4><p>在微服务的完全实践之前，我们首先将模板服务（template）和计算服务（calculation）的功能临时集成到用户服务（customer）中，形成一个集成的单体应用。这个过渡性的单体结构为未来拆分成独立微服务打下了基础。</p><p>在开始实现业务逻辑之前，需要在 <code>coupon-customer-impl</code> 的配置中加入模板和计算服务的实现层依赖项。这一步至关重要，因为它确保了用户服务不仅能够调用其他服务的 API，还能够利用它们的具体实现来完成复杂的业务操作。</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-customer-dao<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-calculation-impl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>\${project.groupId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>coupon-template-impl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>\${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-2-service-层" tabindex="-1"><a class="header-anchor" href="#_4-3-2-service-层" aria-hidden="true">#</a> 4.3.2 Service 层</h4><p>完成依赖配置之后，我定义了一个核心业务接口 <code>CouponCustomerService</code>，它规定了领取优惠券、查询优惠券、核销优惠券以及执行优惠券试算等关键业务功能的方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 用户优惠卷服务
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponCustomerService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 获取优惠券
     *
     * <span class="token keyword">@param</span> <span class="token parameter">request</span> 优惠券请求对象
     * <span class="token keyword">@return</span> 优惠券对象
     */</span>
    <span class="token class-name">Coupon</span> <span class="token function">requestCoupon</span><span class="token punctuation">(</span><span class="token class-name">RequestCoupon</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 核销优惠卷（即下单）
     *
     * <span class="token keyword">@param</span> <span class="token parameter">order</span> 购物车对象
     */</span>
    <span class="token class-name">ShoppingCart</span> <span class="token function">placeOrder</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 模拟订单试算
     *
     * <span class="token keyword">@param</span> <span class="token parameter">order</span> 模拟订单对象
     * <span class="token keyword">@return</span> 模拟响应对象
     */</span>
    <span class="token class-name">SimulationResponse</span> <span class="token function">simulateOrderPrice</span><span class="token punctuation">(</span><span class="token class-name">SimulationOrder</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 删除优惠券
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>   用户ID
     * <span class="token keyword">@param</span> <span class="token parameter">couponId</span> 优惠券ID
     */</span>
    <span class="token keyword">void</span> <span class="token function">deleteCoupon</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> couponId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 查找优惠券
     *
     * <span class="token keyword">@param</span> <span class="token parameter">request</span> 查找优惠券请求对象
     * <span class="token keyword">@return</span> 优惠券信息列表
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCoupon</span><span class="token punctuation">(</span><span class="token class-name">SearchCoupon</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，重点关注 <code>placeOrder</code> 方法的实现，这个方法是处理用户下单及优惠券核销流程的关键。在实现这个方法时，<code>Coupon</code> 对象的构造过程采用了构建者模式，这一模式通过 Lombok 的 <code>@Builder</code> 注解得以简化实现，使得对象的创建过程既直观又易于管理，提升了代码的整洁度和可维护性。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ShoppingCart</span> <span class="token function">placeOrder</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果订单商品为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;订单商品为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;订单商品为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Coupon</span> coupon <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果订单中含有优惠券ID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getCouponId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建优惠券查询示例</span>
        <span class="token class-name">Coupon</span> example <span class="token operator">=</span> <span class="token class-name">Coupon</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getCouponId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">AVAILABLE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查询符合条件的优惠券</span>
        coupon <span class="token operator">=</span> couponDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将优惠券转换为优惠券信息对象</span>
        <span class="token class-name">CouponInfo</span> couponInfo <span class="token operator">=</span> <span class="token class-name">CouponConverter</span><span class="token punctuation">.</span><span class="token function">convertToCoupon</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载优惠券模板信息</span>
        couponInfo<span class="token punctuation">.</span><span class="token function">setTemplateInfo</span><span class="token punctuation">(</span>templateService<span class="token punctuation">.</span><span class="token function">loadCouponTemplate</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将优惠券信息添加到订单中</span>
        order<span class="token punctuation">.</span><span class="token function">setCouponInfos</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>couponInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 计算订单价格</span>
    <span class="token class-name">ShoppingCart</span> checkoutInfo <span class="token operator">=</span> calculationService<span class="token punctuation">.</span><span class="token function">calculateOrderPrice</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果含有优惠券</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>coupon <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果订单中没有优惠券信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>checkoutInfo<span class="token punctuation">.</span><span class="token function">getCouponInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;没有优惠券信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;没有优惠券信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新优惠券状态&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新优惠券状态为已使用</span>
        coupon<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">USED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存优惠券信息</span>
        couponDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回结账信息对象</span>
    <span class="token keyword">return</span> checkoutInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完整实现类如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 用户优惠券业务逻辑实现类
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponCustomerServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CouponCustomerService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponDao</span> couponDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponTemplateService</span> templateService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponCalculationService</span> calculationService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Coupon</span> <span class="token function">requestCoupon</span><span class="token punctuation">(</span><span class="token class-name">RequestCoupon</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加载优惠券模板信息</span>
        <span class="token class-name">CouponTemplateInfo</span> templateInfo <span class="token operator">=</span> templateService<span class="token punctuation">.</span><span class="token function">loadCouponTemplate</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCouponTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果模板信息为空，则抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>templateInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券模板不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券模板不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取当前时间</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimeInMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取模板规则的截止时间</span>
        <span class="token class-name">Long</span> expTime <span class="token operator">=</span> templateInfo<span class="token punctuation">.</span><span class="token function">getTemplateRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果截止时间不为空且当前时间超过截止时间，或者可用性为false，则抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expTime <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> now <span class="token operator">&gt;</span> expTime <span class="token operator">||</span> <span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token function">isFalse</span><span class="token punctuation">(</span>templateInfo<span class="token punctuation">.</span><span class="token function">getAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券模板不可用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券模板不可用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 统计用户使用该模板的优惠券数量</span>
        <span class="token keyword">long</span> count <span class="token operator">=</span> couponDao<span class="token punctuation">.</span><span class="token function">countByUserIdAndTemplateId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getCouponTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果数量达到限制，则抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;=</span> templateInfo<span class="token punctuation">.</span><span class="token function">getTemplateRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLimitation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券模板已达上限&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券模板已达上限&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 创建优惠券对象</span>
        <span class="token class-name">Coupon</span> coupon <span class="token operator">=</span> <span class="token class-name">Coupon</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">templateId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCouponTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">shopId</span><span class="token punctuation">(</span>templateInfo<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">AVAILABLE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 保存优惠券到数据库</span>
        couponDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回生成的优惠券对象</span>
        <span class="token keyword">return</span> coupon<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShoppingCart</span> <span class="token function">placeOrder</span><span class="token punctuation">(</span><span class="token class-name">ShoppingCart</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果订单商品为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;订单商品为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;订单商品为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Coupon</span> coupon <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果订单中含有优惠券ID</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getCouponId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 创建优惠券查询示例</span>
            <span class="token class-name">Coupon</span> example <span class="token operator">=</span> <span class="token class-name">Coupon</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getCouponId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">AVAILABLE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 查询符合条件的优惠券</span>
            coupon <span class="token operator">=</span> couponDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将优惠券转换为优惠券信息对象</span>
            <span class="token class-name">CouponInfo</span> couponInfo <span class="token operator">=</span> <span class="token class-name">CouponConverter</span><span class="token punctuation">.</span><span class="token function">convertToCoupon</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 加载优惠券模板信息</span>
            couponInfo<span class="token punctuation">.</span><span class="token function">setTemplateInfo</span><span class="token punctuation">(</span>templateService<span class="token punctuation">.</span><span class="token function">loadCouponTemplate</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将优惠券信息添加到订单中</span>
            order<span class="token punctuation">.</span><span class="token function">setCouponInfos</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>couponInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 计算订单价格</span>
        <span class="token class-name">ShoppingCart</span> checkoutInfo <span class="token operator">=</span> calculationService<span class="token punctuation">.</span><span class="token function">calculateOrderPrice</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果含有优惠券</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>coupon <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果订单中没有优惠券信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>checkoutInfo<span class="token punctuation">.</span><span class="token function">getCouponInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;没有优惠券信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;没有优惠券信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新优惠券状态&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新优惠券状态为已使用</span>
            coupon<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">USED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存优惠券信息</span>
            couponDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回结账信息对象</span>
        <span class="token keyword">return</span> checkoutInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SimulationResponse</span> <span class="token function">simulateOrderPrice</span><span class="token punctuation">(</span><span class="token class-name">SimulationOrder</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建一个空的CouponInfo列表</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponInfo</span><span class="token punctuation">&gt;</span></span> couponInfos <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历订单中的优惠券ID列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> couponID <span class="token operator">:</span> order<span class="token punctuation">.</span><span class="token function">getCouponIDs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 创建一个Coupon的构建器对象，并设置用户ID、优惠券ID和状态</span>
            <span class="token class-name">Coupon</span> example <span class="token operator">=</span> <span class="token class-name">Coupon</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>couponID<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">AVAILABLE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 通过优惠券ID查询优惠券信息，并将结果转换为Observable</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Coupon</span><span class="token punctuation">&gt;</span></span> couponOptional <span class="token operator">=</span> couponDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果查询到了优惠券</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>couponOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获取优惠券对象</span>
                <span class="token class-name">Coupon</span> coupon <span class="token operator">=</span> couponOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 将优惠券转换为CouponInfo对象</span>
                <span class="token class-name">CouponInfo</span> couponInfo <span class="token operator">=</span> <span class="token class-name">CouponConverter</span><span class="token punctuation">.</span><span class="token function">convertToCoupon</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 加载优惠券模板信息</span>
                couponInfo<span class="token punctuation">.</span><span class="token function">setTemplateInfo</span><span class="token punctuation">(</span>templateService<span class="token punctuation">.</span><span class="token function">loadCouponTemplate</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 将CouponInfo对象添加到列表中</span>
                couponInfos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>couponInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 将生成的优惠券信息列表设置回订单对象</span>
        order<span class="token punctuation">.</span><span class="token function">setCouponInfos</span><span class="token punctuation">(</span>couponInfos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用计算服务的simulateOrder方法，返回模拟订单结果</span>
        <span class="token keyword">return</span> calculationService<span class="token punctuation">.</span><span class="token function">simulateOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteCoupon</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> couponId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 构建优惠券查询示例</span>
        <span class="token class-name">Coupon</span> example <span class="token operator">=</span> <span class="token class-name">Coupon</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>couponId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">AVAILABLE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据查询示例获取符合条件的优惠券</span>
        <span class="token class-name">Coupon</span> coupon <span class="token operator">=</span> couponDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将优惠券状态设置为无效</span>
        coupon<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token constant">INACTIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 保存修改后的优惠券</span>
        couponDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCoupon</span><span class="token punctuation">(</span><span class="token class-name">SearchCoupon</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据搜索条件查询优惠券列表</span>
        <span class="token comment">// 注意：在生产中此处应该使用分页查询且查询条件应该封装为一个类</span>
        <span class="token class-name">Coupon</span> example <span class="token operator">=</span> <span class="token class-name">Coupon</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">CouponStatus</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">shopId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Coupon</span><span class="token punctuation">&gt;</span></span> coupons <span class="token operator">=</span> couponDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Example</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果优惠券列表为空,返回空列表</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>coupons<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取优惠券模板ID列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> templateIds <span class="token operator">=</span> coupons<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Coupon</span><span class="token operator">::</span><span class="token function">getTemplateId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据模板ID获取优惠券模板信息映射</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">CouponTemplateInfo</span><span class="token punctuation">&gt;</span></span> templateMap <span class="token operator">=</span> templateService<span class="token punctuation">.</span><span class="token function">getCouponTemplateMap</span><span class="token punctuation">(</span>templateIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将优惠券模板信息设置到优惠券对象中</span>
        coupons<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>coupon <span class="token operator">-&gt;</span> coupon<span class="token punctuation">.</span><span class="token function">setTemplateInfo</span><span class="token punctuation">(</span>templateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将优惠券列表转换为优惠券信息列表</span>
        <span class="token keyword">return</span> coupons<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CouponConverter</span><span class="token operator">::</span><span class="token function">convertToCoupon</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>涉及到的转换器如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 优惠卷转换器
 *
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponConverter</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CouponInfo</span> <span class="token function">convertToCoupon</span><span class="token punctuation">(</span><span class="token class-name">Coupon</span> coupon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CouponInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">templateId</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getTemplateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">shopId</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getShopId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">templateInfo</span><span class="token punctuation">(</span>coupon<span class="token punctuation">.</span><span class="token function">getTemplateInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里，转换器的作用是确保实体对象与数据传输对象（DTO）之间的准确转换，这对保证系统的数据一致性至关重要。</p><h4 id="_4-3-3-controller-层" tabindex="-1"><a class="header-anchor" href="#_4-3-3-controller-层" aria-hidden="true">#</a> 4.3.3 Controller 层</h4><p>在业务逻辑层的实现之后，紧接着是将服务逻辑与前端交互的控制器层。在 <code>CouponCustomerController</code> 中，我定义了几个对外接口，这些接口通过调用 <code>CouponCustomerServiceImpl</code> 中的方法来具体实现相应的业务逻辑。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> javgo.cn
 * <span class="token keyword">@date</span> 2023/11/4
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;coupon-customer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponCustomerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CouponCustomerService</span> customerService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;requestCoupon&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Coupon</span> <span class="token function">requestCoupon</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RequestCoupon</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> customerService<span class="token punctuation">.</span><span class="token function">requestCoupon</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;deleteCoupon&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteCoupon</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;couponId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> couponId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        customerService<span class="token punctuation">.</span><span class="token function">deleteCoupon</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> couponId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;simulateOrder&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SimulationResponse</span> <span class="token function">simulate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SimulationOrder</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> customerService<span class="token punctuation">.</span><span class="token function">simulateOrderPrice</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;placeOrder&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ShoppingCart</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">ShoppingCart</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> customerService<span class="token punctuation">.</span><span class="token function">placeOrder</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;findCoupon&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CouponInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCoupon</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SearchCoupon</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> customerService<span class="token punctuation">.</span><span class="token function">findCoupon</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在完成了用户优惠券服务的业务逻辑层和控制层实现后，接下来的步骤是进行应用启动类的配置以及相关配置文件的设置。</p><h4 id="_4-3-4-启动类" tabindex="-1"><a class="header-anchor" href="#_4-3-4-启动类" aria-hidden="true">#</a> 4.3.4 启动类</h4><p>启动类是 Spring Boot 应用的入口点，通过一系列的注解，Spring Boot 可以自动配置其上下文环境并启动应用。</p><p>以下是启动类代码的核心片段：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableJpaAuditing</span> <span class="token comment">// 开启审计功能</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;cn.javgo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span> <span class="token comment">// 开启事务管理</span>
<span class="token annotation punctuation">@EnableJpaRepositories</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;cn.javgo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 扫描 JPA 相关的 DAO 层</span>
<span class="token annotation punctuation">@EntityScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;cn.javgo&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 扫描 JPA 相关的实体类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>@SpringBootApplication</code>：这是一个组合注解，它整合了<code>@Configuration</code>，<code>@EnableAutoConfiguration</code>，和 <code>@ComponentScan</code> 注解。通过这个注解，Spring Boot 自动扫描并加载定义好的组件。</li><li><code>@ComponentScan(basePackages = &quot;cn.javgo&quot;)</code>：这个注解告诉 Spring Boot 在 <code>cn.javgo</code> 包下以及其子包中查找组件、配置和服务。</li></ul><p>在这里，我们需要注意 Spring Boot 的一个约定：它默认会扫描启动类所在包以及其子包中的组件。如果需要加载其他包路径下的组件，则需要通过 <code>@ComponentScan</code> 注解明确指定扫描路径。</p><p>例如，如果启动类位于 <code>cn.javgo.customer</code> 包中，但项目中需要加载 <code>cn.javgo.template</code> 包下的组件，就需要在 <code>@ComponentScan</code> 中指定这些包作为额外的扫描路径。</p><h4 id="_4-3-5-模块配置" tabindex="-1"><a class="header-anchor" href="#_4-3-5-模块配置" aria-hidden="true">#</a> 4.3.5 模块配置</h4><p>对于配置文件，我们通常使用 <code>application.yml</code>（或 <code>application.properties</code>）。这里，我们可以借鉴已有的 <code>coupon-template-impl</code> 服务的配置文件，复制并调整必要的配置项来满足当前服务的需求。最重要的是，确保修改 <code>spring.application.name </code>属性，将其设置为 <code>coupon-customer-serv</code>，以反映服务的实际身份。</p><p>配置文件的详细内容：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 服务器端口</span>
<span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">20001</span>

<span class="token comment"># 是否在错误信息中包含消息</span>
<span class="token key attr-name">server.error.include-message</span><span class="token punctuation">=</span><span class="token value attr-value">always</span>

<span class="token comment"># 应用名称</span>
<span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">coupon-customer-serv</span>

<span class="token comment"># 数据库驱动类名</span>
<span class="token key attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment"># 数据库连接URL</span>
<span class="token key attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/coupon_db?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;zeroDateTimeBehavior=convertToNull&amp;serverTimezone=UTC</span>
<span class="token comment"># 数据库用户名</span>
<span class="token key attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token comment"># 数据库密码</span>
<span class="token key attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>

<span class="token comment"># 数据源类型</span>
<span class="token key attr-name">spring.datasource.type</span><span class="token punctuation">=</span><span class="token value attr-value">com.zaxxer.hikari.HikariDataSource</span>
<span class="token comment"># 数据源连接池名称</span>
<span class="token key attr-name">spring.datasource.hikari.pool-name</span><span class="token punctuation">=</span><span class="token value attr-value">CouponHikari</span>
<span class="token comment"># 连接超时时间</span>
<span class="token key attr-name">spring.datasource.hikari.connection-timeout</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span>
<span class="token comment"># 空闲超时时间</span>
<span class="token key attr-name">spring.datasource.hikari.idle-timeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span>
<span class="token comment"># 最大连接池大小</span>
<span class="token key attr-name">spring.datasource.hikari.maximum-pool-size</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token comment"># 最小连接池大小</span>
<span class="token key attr-name">spring.datasource.hikari.minimum-idle</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>
<span class="token comment"># 连接生命周期</span>
<span class="token key attr-name">spring.datasource.hikari.max-lifetime</span><span class="token punctuation">=</span><span class="token value attr-value">60000</span>
<span class="token comment"># 自动提交</span>
<span class="token key attr-name">spring.datasource.hikari.auto-commit</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>

<span class="token comment"># 是否显示 Hibernate SQL 语句</span>
<span class="token key attr-name">spring.jpa.show-sql</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># JPA 生成DDL的方式</span>
<span class="token key attr-name">spring.jpa.hibernate.ddl-auto</span><span class="token punctuation">=</span><span class="token value attr-value">none</span>
<span class="token comment"># Hibernate SQL 语句格式化</span>
<span class="token key attr-name">spring.jpa.properties.hibernate.format_sql</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># Hibernate SQL 语句显示</span>
<span class="token key attr-name">spring.jpa.properties.hibernate.show_sql</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># 是否在视图中打开 JPA 连接</span>
<span class="token key attr-name">spring.jpa.open-in-view</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>

<span class="token comment"># 日志级别</span>
<span class="token key attr-name">logging.level.cn.javgo.coupon</span><span class="token punctuation">=</span><span class="token value attr-value">debug</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置完启动类和 <code>application.properties</code> 之后，用户优惠券服务的 Spring Boot 版本就配置完成了。现在，通过在本地启动单体应用 <code>coupon-customer-serv</code>，我们能够整合并使用用户服务、模板服务和计算服务的功能。</p><p>在本地环境下，你可以直接运行启动类来启动服务，并通过不同的测试用例来验证服务的功能，确保它们按预期工作。</p><h2 id="_5-项目总结" tabindex="-1"><a class="header-anchor" href="#_5-项目总结" aria-hidden="true">#</a> 5.项目总结</h2><p>我们共同打造了一个基于 Spring Boot 的优惠券平台，涵盖了用户、模板和计算等三个核心服务模块。本项目采纳了<strong>分层设计原则</strong>，细化为 API、DAO 和业务逻辑层，以确保架构的清晰性和维护的便捷性。在实现过程中，spring-data-jpa 的加入极大简化了数据操作，而 spring-web 则为我们提供了构建 RESTful 接口的强大工具。</p><p>下面，我们即将踏入 Spring Cloud 的学习之旅。在这个篇章中，我们将深入了解 Nacos、Loadbalancer、OpenFeign 等关键组件，它们是构建微服务架构中跨服务调用系统的基石。通过 Spring Cloud，我们能够实现服务的自动注册与发现、负载均衡、服务熔断和链路追踪等高级功能，这将极大地提高系统的可用性和可靠性。</p>`,42);function $(Y,K){const p=c("ExternalLinkIcon"),e=c("center");return i(),u("div",null,[k,s("p",null,[n("首先，访问 "),s("a",r,[n("Homebrew 官方网站"),a(p)]),n(" 查看详细的安装指南。")]),v,s("ul",null,[s("li",null,[m,n("：这是 Java 长期支持的版本之一，广泛用于企业级应用。你可以从 "),s("a",g,[n("Oracle 官网"),a(p)]),n(" 下载 JDK 8 的最新小版本。尽管较旧，但其稳定性和广泛的应用支持是选择它的主要原因。")]),s("li",null,[b,n("：建议使用 Maven 3.6 或更高版本，以确保与现代 Java 生态的兼容性。在本文中，我使用的是 Maven 3.9.3，可从 "),s("a",y,[n("Maven 官网"),a(p)]),n(" 下载。")])]),f,s("ol",null,[s("li",null,[h,n("：前往 "),s("a",w,[n("JetBrains 官方网站"),a(p)]),n(" 下载 IntelliJ IDEA。你可以选择免费的社区版，或是具有更多特性的付费商业版。")]),I,C,T]),q,s("p",null,[n("Windows 或 Linux 用户可访问 "),s("a",S,[n("MySQL 官方网站"),a(p)]),n("，下载相应平台的社区版安装包。社区版已充分满足我们实战项目的需求。")]),A,s("p",null,[n("访问 "),s("a",j,[n("DataGrip 官网"),a(p)]),n("，选择适合你操作系统的版本下载：")]),L,s("p",null,[_,n("：访问 "),s("a",x,[n("RabbitMQ 官网"),a(p)]),n(" 下载相应的安装包。")]),D,s("p",null,[O,n("：也可以选择手动安装 Redis，访问 "),s("a",P,[n("Redis 官方网站"),a(p)]),n(" 下载源码包。")]),M,s("p",null,[n("然后按照官方"),s("a",R,[n("安装指南"),a(p)]),n("进行本地编译和安装：")]),E,a(e,null,{default:o(()=>[n("优惠券类型枚举（CouponType）")]),_:1}),N,a(e,null,{default:o(()=>[n("优惠券模板规则（TemplateRule）")]),_:1}),B,a(e,null,{default:o(()=>[n("折扣规则（Discount）")]),_:1}),J,a(e,null,{default:o(()=>[n("优惠券模板信息（CouponTemplateInfo）")]),_:1}),U,a(e,null,{default:o(()=>[n("其他类")]),_:1}),Q,s("p",null,[n("在上述代码中，使用了 Lombok 库来简化实体类的编写，通过注解自动生成常用的方法如 "),F,n("、"),z,n("、"),H,n(" 等，大大提升了开发效率。对 Lombok 感兴趣的读者可以访问其"),s("a",V,[n("官方网站"),a(p)]),n("以获得更多信息。")]),G])}const Z=l(d,[["render",$],["__file","04-cloud-实战项目搭建.html.vue"]]);export{Z as default};
